# ============================================================================
# SomaAgent01 ML - Full ML Stack with CPU/GPU Detection
# ============================================================================
#
# Purpose: Memory replicator, ML processing, document extraction
# Size: ~1.5GB (CPU) / ~2.5GB (GPU)
# Services: memory-replicator, voyant-worker
#
# BUILD COMMANDS:
#   CPU:  make build-ml
#   GPU:  docker build -f Dockerfile.ml --build-arg TORCH_VARIANT=cuda -t somaagent-ml:latest .
#
# ============================================================================

# Build arguments for CPU/GPU selection
ARG TORCH_VERSION="2.3.1"
ARG TORCH_VARIANT="cpu"

FROM python:3.11-slim AS builder

ARG TORCH_VERSION
ARG TORCH_VARIANT

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    VENV_PATH="/opt/venv"

# Build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

RUN python -m venv "${VENV_PATH}" && \
    "${VENV_PATH}/bin/pip" install --upgrade pip setuptools wheel

WORKDIR /opt/build

# Copy requirements
COPY requirements-core.txt requirements-worker.txt requirements-analyzer.txt ./

# ============================================================================
# CPU/GPU PYTORCH SELECTION
# ============================================================================
RUN if [ "${TORCH_VARIANT}" = "cpu" ]; then \
    echo "ðŸ”§ Installing PyTorch CPU version..."; \
    TORCH_INDEX="https://download.pytorch.org/whl/cpu"; \
    TORCH_SPEC="torch==${TORCH_VERSION}"; \
    elif [ "${TORCH_VARIANT}" = "cuda" ] || [ "${TORCH_VARIANT}" = "cu121" ]; then \
    echo "ðŸ”§ Installing PyTorch CUDA version..."; \
    TORCH_INDEX="https://download.pytorch.org/whl/cu121"; \
    TORCH_SPEC="torch==${TORCH_VERSION}+cu121"; \
    else \
    echo "ðŸ”§ Installing PyTorch ${TORCH_VARIANT} version..."; \
    TORCH_INDEX="https://download.pytorch.org/whl/${TORCH_VARIANT}"; \
    TORCH_SPEC="torch==${TORCH_VERSION}+${TORCH_VARIANT}"; \
    fi && \
    "${VENV_PATH}/bin/pip" install --no-cache-dir \
    --index-url https://pypi.org/simple \
    --extra-index-url ${TORCH_INDEX} \
    ${TORCH_SPEC}

# Install remaining ML dependencies
RUN "${VENV_PATH}/bin/pip" install --no-cache-dir -r requirements-analyzer.txt

# ============================================================================
# RUNTIME
# ============================================================================
FROM python:3.11-slim AS runtime

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    VENV_PATH="/opt/venv" \
    DJANGO_SETTINGS_MODULE="services.gateway.settings"

ENV PATH="${VENV_PATH}/bin:$PATH" \
    PYTHONPATH=/app

# Runtime deps including document processing
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    libpq5 \
    libsndfile1 \
    tesseract-ocr \
    poppler-utils \
    ffmpeg \
    libgl1 \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /opt/venv /opt/venv

WORKDIR /app

# Copy application
COPY admin/ /app/admin/
COPY services/ /app/services/
COPY python/ /app/python/
COPY integrations/ /app/integrations/
COPY src/ /app/src/
COPY manage.py sitecustomize.py agent.py models.py /app/
COPY scripts/entrypoints/ /app/scripts/entrypoints/

RUN useradd -m -u 1000 agent && \
    chown -R agent:agent /app && \
    chmod +x /app/scripts/entrypoints/*.sh 2>/dev/null || true

USER agent

ENTRYPOINT ["/app/scripts/entrypoints/django-entrypoint.sh"]
CMD ["python", "-m", "services.memory_replicator.main"]
