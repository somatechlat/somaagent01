FROM somaagent01-slim:latest

ENV PYTHONPATH=/git/agent-zero
ENV PATH="/venv/bin:${PATH}"
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

# Install browser automation layer
RUN /venv/bin/pip install --no-cache-dir \
      playwright==1.52.0 \
      browser-use==0.5.11 && \
    /venv/bin/playwright install chromium && \
    /venv/bin/python -c "import browser_use, playwright; print('browser layer ok')"

# Verify core app still imports
RUN /venv/bin/python - <<'PY'
import importlib.util
mods = [
  'fastapi', 'uvicorn', 'fasta2a', 'fastmcp', 'mcp', 'redis', 'aiokafka',
  'langchain_core', 'crontab', 'browser_use'
]
missing = [m for m in mods if importlib.util.find_spec(m) is None]
assert not missing, f"Missing: {missing}"
print('All core + browser modules present')
PY

EXPOSE 80
CMD ["/venv/bin/python", "run_ui.py", "--dockerized=true", "--host=0.0.0.0", "--port=80"]
