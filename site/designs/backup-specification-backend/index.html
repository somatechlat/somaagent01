
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Unified documentation portal for SomaAgent01">
      
      
      
        <link rel="canonical" href="https://docs.somaagent01.dev/designs/backup-specification-backend/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Agent Zero Backup/Restore Backend Specification - SomaAgent01 Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#agent-zero-backuprestore-backend-specification" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SomaAgent01 Docs" class="md-header__button md-logo" aria-label="SomaAgent01 Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SomaAgent01 Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Agent Zero Backup/Restore Backend Specification
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/somatechlat/somaagent01" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    somaagent01
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SomaAgent01 Docs" class="md-nav__button md-logo" aria-label="SomaAgent01 Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    SomaAgent01 Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/somatechlat/somaagent01" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    somaagent01
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-manual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-manual/getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-manual/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-manual/using-the-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using the Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-manual/features/memory-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-manual/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-manual/accessibility/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Accessibility
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Technical Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Technical Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deployment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Monitoring & Health
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/infrastructure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Infrastructure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/integrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integrations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/data-flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Flow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/runbooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runbooks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_10" >
        
          
          <label class="md-nav__link" for="__nav_3_10" id="__nav_3_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Components
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_10">
            <span class="md-nav__icon md-icon"></span>
            Components
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/components/gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gateway
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/components/conversation-worker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Conversation Worker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/components/tool-executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tool Executor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/components/memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Subsystem
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/components/mcp-proxy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCP & A2A Proxy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/components/realtime-speech/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Realtime Speech
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical-manual/components/ui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent UI
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Development Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environment Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/contribution-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contribution Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/coding-standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Coding Standards
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing Strategy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/release-process/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Release Process
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/tooling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Developer Tooling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/legacy-apis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Legacy External APIs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development-manual/runbooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runbooks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Onboarding Manual
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Onboarding Manual
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../onboarding-manual/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../onboarding-manual/orientation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Orientation Checklist
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../onboarding-manual/first-90-days/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    First 90 Days
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../onboarding-manual/toolchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Toolchain Primer
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../onboarding-manual/team-contacts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Team Directory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../onboarding-manual/faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Shared Resources
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Shared Resources
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../style-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Style Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../documentation-audit-checklist/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Documentation Audit Checklist
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Change Log
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event Streams
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Core Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#backup-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Backup Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restore-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Restore Flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backend-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Backend Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backend Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-settings-integration" class="md-nav__link">
    <span class="md-ellipsis">
      1. Settings Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Settings Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#settings-schema-extension" class="md-nav__link">
    <span class="md-ellipsis">
      Settings Schema Extension
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#default-backup-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Default Backup Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-api-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      2. API Endpoints
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. API Endpoints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-backup-test-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Backup Test Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-backup-create-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Backup Create Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-backup-restore-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 Backup Restore Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-backup-restore-preview-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 Backup Restore Preview Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-backup-file-preview-grouped-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 Backup File Preview Grouped Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-backup-progress-stream-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      2.6 Backup Progress Stream Endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-backup-inspect-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      2.7 Backup Inspect Endpoint
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-backup-service-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      3. Backup Service Implementation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Backup Service Implementation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-service-class" class="md-nav__link">
    <span class="md-ellipsis">
      Core Service Class
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      4. Dependencies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Dependencies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-python-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Required Python Packages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-zero-internal-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Agent Zero Internal Dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation-command" class="md-nav__link">
    <span class="md-ellipsis">
      Installation Command
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      5. Error Handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#integration-with-agent-zero-error-system" class="md-nav__link">
    <span class="md-ellipsis">
      Integration with Agent Zero Error System
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-error-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      Common Error Scenarios
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-response-format" class="md-nav__link">
    <span class="md-ellipsis">
      Error Response Format
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      6. Security Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Security Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#path-security" class="md-nav__link">
    <span class="md-ellipsis">
      Path Security
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication" class="md-nav__link">
    <span class="md-ellipsis">
      Authentication
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system-protection" class="md-nav__link">
    <span class="md-ellipsis">
      File System Protection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      7. Performance Considerations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#file-processing" class="md-nav__link">
    <span class="md-ellipsis">
      File Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-management" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Management
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      8. Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#default-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Default Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-integration-opportunities" class="md-nav__link">
    <span class="md-ellipsis">
      Future Integration Opportunities
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enhanced-metadata-structure-and-restore-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Enhanced Metadata Structure and Restore Workflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enhanced Metadata Structure and Restore Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#version-detection-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Version Detection Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metadatajson-format" class="md-nav__link">
    <span class="md-ellipsis">
      Metadata.json Format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restore-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Restore Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-metadata-editing-benefits" class="md-nav__link">
    <span class="md-ellipsis">
      JSON Metadata Editing Benefits
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comprehensive-enhancement-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Comprehensive Enhancement Summary
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Comprehensive Enhancement Summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#enhanced-metadata-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Enhanced Metadata Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#smart-file-management" class="md-nav__link">
    <span class="md-ellipsis">
      Smart File Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#real-time-progress-streaming" class="md-nav__link">
    <span class="md-ellipsis">
      Real-time Progress Streaming
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-api-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced API Endpoints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-information-collection" class="md-nav__link">
    <span class="md-ellipsis">
      System Information Collection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-and-reliability-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      Security and Reliability Enhancements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-status-updates" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Status Updates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Status Updates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#completed-core-backupservice-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ COMPLETED: Core BackupService Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#next-implementation-phase-api-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Next Implementation Phase: API Endpoints
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-cleanup-and-final-status" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Cleanup and Final Status
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Cleanup and Final Status">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#completed-cleanup-december-2024" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ COMPLETED CLEANUP (December 2024)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="✅ COMPLETED CLEANUP (December 2024)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#removed-unused-components" class="md-nav__link">
    <span class="md-ellipsis">
      Removed Unused Components:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simplified-backupservice" class="md-nav__link">
    <span class="md-ellipsis">
      Simplified BackupService:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enhanced-hidden-file-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Enhanced Hidden File Logic:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-api-endpoint-set-6-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Final API Endpoint Set (6 endpoints):
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#critical-issue-fixed-hidden-files" class="md-nav__link">
    <span class="md-ellipsis">
      Critical Issue Fixed: Hidden Files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-status-production-ready" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Status: ✅ PRODUCTION READY
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-status-ace-editor-state-guarantee-completed-december-2024" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ FINAL STATUS: ACE EDITOR STATE GUARANTEE COMPLETED (December 2024)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="✅ FINAL STATUS: ACE EDITOR STATE GUARANTEE COMPLETED (December 2024)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#goal-achievement-verification" class="md-nav__link">
    <span class="md-ellipsis">
      Goal Achievement Verification
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Goal Achievement Verification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#archive-metadatajson-usage-minimal-only-technical-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Archive metadata.json Usage (MINIMAL - only technical requirements):
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ace-editor-metadata-usage-everything-else" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ ACE editor metadata Usage (EVERYTHING ELSE):
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hybrid-approach-perfect-balance" class="md-nav__link">
    <span class="md-ellipsis">
      Hybrid Approach - Perfect Balance:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-layer-integration" class="md-nav__link">
    <span class="md-ellipsis">
      API Layer Integration:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service-layer-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Service Layer Implementation:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dead-code-cleanup-results" class="md-nav__link">
    <span class="md-ellipsis">
      Dead Code Cleanup Results
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Dead Code Cleanup Results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#removed-unused-method" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Removed Unused Method:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#method-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Method Comparison:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-experience-flow" class="md-nav__link">
    <span class="md-ellipsis">
      User Experience Flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#technical-benefits-achieved" class="md-nav__link">
    <span class="md-ellipsis">
      Technical Benefits Achieved
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Technical Benefits Achieved">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-user-control" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Complete User Control:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-system-compatibility" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Cross-System Compatibility:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clean-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      ✅ Clean Architecture:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-status-production-ready" class="md-nav__link">
    <span class="md-ellipsis">
      Final Status: ✅ PRODUCTION READY
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="agent-zero-backuprestore-backend-specification">Agent Zero Backup/Restore Backend Specification<a class="headerlink" href="#agent-zero-backuprestore-backend-specification" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>This specification defines the backend implementation for Agent Zero's backup and restore functionality, providing users with the ability to backup and restore their Agent Zero configurations, data, and custom files using glob pattern-based selection. The backup functionality is implemented as a dedicated "backup" tab in the settings interface for easy access and organization.</p>
<h2 id="core-requirements">Core Requirements<a class="headerlink" href="#core-requirements" title="Permanent link">&para;</a></h2>
<h3 id="backup-flow">Backup Flow<a class="headerlink" href="#backup-flow" title="Permanent link">&para;</a></h3>
<ol>
<li>User configures backup paths using glob patterns in settings modal</li>
<li>Backend creates zip archive with selected files and metadata</li>
<li>Archive is provided as download to user</li>
</ol>
<h3 id="restore-flow">Restore Flow<a class="headerlink" href="#restore-flow" title="Permanent link">&para;</a></h3>
<ol>
<li>User uploads backup archive in settings modal</li>
<li>Backend extracts and validates metadata</li>
<li>User confirms file list and destination paths</li>
<li>Backend restores files to specified locations</li>
</ol>
<h2 id="backend-architecture">Backend Architecture<a class="headerlink" href="#backend-architecture" title="Permanent link">&para;</a></h2>
<h3 id="1-settings-integration">1. Settings Integration<a class="headerlink" href="#1-settings-integration" title="Permanent link">&para;</a></h3>
<h4 id="settings-schema-extension">Settings Schema Extension<a class="headerlink" href="#settings-schema-extension" title="Permanent link">&para;</a></h4>
<p>Add backup/restore section with dedicated tab to <code>python/helpers/settings.py</code>:</p>
<p><strong>Integration Notes:</strong>
- Leverages existing settings button handler pattern (follows MCP servers example)
- Integrates with Agent Zero's established error handling and toast notification system
- Uses existing file operation helpers with RFC support for development mode compatibility</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Add to SettingsSection in convert_out() function</span>
<span class="n">backup_section</span><span class="p">:</span> <span class="n">SettingsSection</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;backup_restore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Backup &amp; Restore&quot;</span><span class="p">,</span>
    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Backup and restore Agent Zero data and configurations using glob pattern-based file selection.&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;backup_create&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Create Backup&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Create a backup archive of selected files and configurations using customizable patterns.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;button&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Create Backup&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;backup_restore&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Restore from Backup&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Restore files and configurations from a backup archive with pattern-based selection.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;button&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;Restore Backup&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;tab&quot;</span><span class="p">:</span> <span class="s2">&quot;backup&quot;</span><span class="p">,</span>  <span class="c1"># Dedicated backup tab for clean organization</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="default-backup-configuration">Default Backup Configuration<a class="headerlink" href="#default-backup-configuration" title="Permanent link">&para;</a></h4>
<p>The backup system now uses <strong>resolved absolute filesystem paths</strong> instead of placeholders, ensuring compatibility across different deployment environments (Docker containers, direct host installations, different users).</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_default_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get default backup patterns with resolved absolute paths&quot;&quot;&quot;</span>
    <span class="c1"># Ensure paths don&#39;t have double slashes</span>
    <span class="n">agent_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_zero_root</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">user_home</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_home</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;# Agent Zero Knowledge (excluding defaults)</span>
<span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/knowledge/**</span>
<span class="s2">!</span><span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/knowledge/default/**</span>

<span class="s2"># Agent Zero Instruments (excluding defaults)</span>
<span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/instruments/**</span>
<span class="s2">!</span><span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/instruments/default/**</span>

<span class="s2"># Memory (excluding embeddings cache)</span>
<span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/memory/**</span>
<span class="s2">!</span><span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/memory/embeddings/**</span>

<span class="s2"># Configuration and Settings (CRITICAL)</span>
<span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/.env</span>
<span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/tmp/settings.json</span>
<span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/tmp/chats/**</span>
<span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/tmp/tasks/**</span>
<span class="si">{</span><span class="n">agent_root</span><span class="si">}</span><span class="s2">/tmp/uploads/**</span>

<span class="s2"># User Home Directory (excluding hidden files by default)</span>
<span class="si">{</span><span class="n">user_home</span><span class="si">}</span><span class="s2">/**</span>
<span class="s2">!</span><span class="si">{</span><span class="n">user_home</span><span class="si">}</span><span class="s2">/.*/**</span>
<span class="s2">!</span><span class="si">{</span><span class="n">user_home</span><span class="si">}</span><span class="s2">/.*&quot;&quot;&quot;</span>
</code></pre></div>
<p><strong>Example Resolved Patterns</strong> (varies by environment):
<div class="highlight"><pre><span></span><code># Docker container environment
/a0/knowledge/**
!/a0/knowledge/default/**
/root/**
!/root/.*/**
!/root/.*

# Host environment
/home/rafael/a0/data/knowledge/**
!/home/rafael/a0/data/knowledge/default/**
/home/rafael/**
!/home/rafael/.*/**
!/home/rafael/.*
</code></pre></div></p>
<blockquote>
<p><strong>⚠️ CRITICAL FILE NOTICE</strong>: The <code>{agent_root}/.env</code> file contains essential configuration including API keys, model settings, and runtime parameters. This file is <strong>REQUIRED</strong> for Agent Zero to function properly and should always be included in backups alongside <code>settings.json</code>. Without this file, restored Agent Zero instances will not have access to configured language models or external services.</p>
</blockquote>
<h3 id="2-api-endpoints">2. API Endpoints<a class="headerlink" href="#2-api-endpoints" title="Permanent link">&para;</a></h3>
<h4 id="21-backup-test-endpoint">2.1 Backup Test Endpoint<a class="headerlink" href="#21-backup-test-endpoint" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>python/api/backup_test.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApiHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.backup</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupService</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BackupTest</span><span class="p">(</span><span class="n">ApiHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test backup patterns and return matched files&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_auth</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_loopback</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Response</span><span class="p">:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patterns&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">include_hidden</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_hidden&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">max_files</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_files&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>  <span class="c1"># Limit for preview</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backup_service</span> <span class="o">=</span> <span class="n">BackupService</span><span class="p">()</span>
            <span class="n">matched_files</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backup_service</span><span class="o">.</span><span class="n">test_patterns</span><span class="p">(</span>
                <span class="n">patterns</span><span class="o">=</span><span class="n">patterns</span><span class="p">,</span>
                <span class="n">include_hidden</span><span class="o">=</span><span class="n">include_hidden</span><span class="p">,</span>
                <span class="n">max_files</span><span class="o">=</span><span class="n">max_files</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">matched_files</span><span class="p">,</span>
                <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_files</span><span class="p">),</span>
                <span class="s2">&quot;truncated&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_files</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div>
<h4 id="22-backup-create-endpoint">2.2 Backup Create Endpoint<a class="headerlink" href="#22-backup-create-endpoint" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>python/api/backup_create.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApiHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">send_file</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.backup</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupService</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BackupCreate</span><span class="p">(</span><span class="n">ApiHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create backup archive and provide download&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_auth</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_loopback</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Response</span><span class="p">:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patterns&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">include_hidden</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_hidden&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">backup_name</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_name&quot;</span><span class="p">,</span> <span class="s2">&quot;agent-zero-backup&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backup_service</span> <span class="o">=</span> <span class="n">BackupService</span><span class="p">()</span>
            <span class="n">zip_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backup_service</span><span class="o">.</span><span class="n">create_backup</span><span class="p">(</span>
                <span class="n">patterns</span><span class="o">=</span><span class="n">patterns</span><span class="p">,</span>
                <span class="n">include_hidden</span><span class="o">=</span><span class="n">include_hidden</span><span class="p">,</span>
                <span class="n">backup_name</span><span class="o">=</span><span class="n">backup_name</span>
            <span class="p">)</span>

            <span class="c1"># Return file for download</span>
            <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span>
                <span class="n">zip_path</span><span class="p">,</span>
                <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">download_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backup_name</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">,</span>
                <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/zip&#39;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div>
<h4 id="23-backup-restore-endpoint">2.3 Backup Restore Endpoint<a class="headerlink" href="#23-backup-restore-endpoint" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>python/api/backup_restore.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApiHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.backup</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.datastructures</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileStorage</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BackupRestore</span><span class="p">(</span><span class="n">ApiHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Restore files from backup archive&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_auth</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_loopback</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Response</span><span class="p">:</span>
        <span class="c1"># Handle file upload</span>
        <span class="k">if</span> <span class="s1">&#39;backup_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No backup file provided&quot;</span><span class="p">}</span>

        <span class="n">backup_file</span><span class="p">:</span> <span class="n">FileStorage</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;backup_file&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">backup_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No file selected&quot;</span><span class="p">}</span>

        <span class="c1"># Get restore configuration</span>
        <span class="n">restore_patterns</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restore_patterns&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">overwrite_policy</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overwrite_policy&quot;</span><span class="p">,</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">)</span>  <span class="c1"># overwrite, skip, backup</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backup_service</span> <span class="o">=</span> <span class="n">BackupService</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backup_service</span><span class="o">.</span><span class="n">restore_backup</span><span class="p">(</span>
                <span class="n">backup_file</span><span class="o">=</span><span class="n">backup_file</span><span class="p">,</span>
                <span class="n">restore_patterns</span><span class="o">=</span><span class="n">restore_patterns</span><span class="p">,</span>
                <span class="n">overwrite_policy</span><span class="o">=</span><span class="n">overwrite_policy</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;restored_files&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;restored_files&quot;</span><span class="p">],</span>
                <span class="s2">&quot;skipped_files&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;skipped_files&quot;</span><span class="p">],</span>
                <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div>
<h4 id="24-backup-restore-preview-endpoint">2.4 Backup Restore Preview Endpoint<a class="headerlink" href="#24-backup-restore-preview-endpoint" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>python/api/backup_restore_preview.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApiHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.backup</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.datastructures</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileStorage</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BackupRestorePreview</span><span class="p">(</span><span class="n">ApiHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Preview files that would be restored based on patterns&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_auth</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_loopback</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Response</span><span class="p">:</span>
        <span class="c1"># Handle file upload</span>
        <span class="k">if</span> <span class="s1">&#39;backup_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No backup file provided&quot;</span><span class="p">}</span>

        <span class="n">backup_file</span><span class="p">:</span> <span class="n">FileStorage</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;backup_file&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">backup_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No file selected&quot;</span><span class="p">}</span>

        <span class="n">restore_patterns</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;restore_patterns&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backup_service</span> <span class="o">=</span> <span class="n">BackupService</span><span class="p">()</span>
            <span class="n">preview_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backup_service</span><span class="o">.</span><span class="n">preview_restore</span><span class="p">(</span>
                <span class="n">backup_file</span><span class="o">=</span><span class="n">backup_file</span><span class="p">,</span>
                <span class="n">restore_patterns</span><span class="o">=</span><span class="n">restore_patterns</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">preview_result</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">],</span>
                <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="n">preview_result</span><span class="p">[</span><span class="s2">&quot;total_count&quot;</span><span class="p">],</span>
                <span class="s2">&quot;skipped_count&quot;</span><span class="p">:</span> <span class="n">preview_result</span><span class="p">[</span><span class="s2">&quot;skipped_count&quot;</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div>
<h4 id="25-backup-file-preview-grouped-endpoint">2.5 Backup File Preview Grouped Endpoint<a class="headerlink" href="#25-backup-file-preview-grouped-endpoint" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>python/api/backup_preview_grouped.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApiHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.backup</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupService</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BackupPreviewGrouped</span><span class="p">(</span><span class="n">ApiHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get grouped file preview with smart directory organization&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_auth</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_loopback</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Response</span><span class="p">:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patterns&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">include_hidden</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_hidden&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">max_depth</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_depth&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">search_filter</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;search_filter&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backup_service</span> <span class="o">=</span> <span class="n">BackupService</span><span class="p">()</span>
            <span class="n">grouped_preview</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backup_service</span><span class="o">.</span><span class="n">get_grouped_file_preview</span><span class="p">(</span>
                <span class="n">patterns</span><span class="o">=</span><span class="n">patterns</span><span class="p">,</span>
                <span class="n">include_hidden</span><span class="o">=</span><span class="n">include_hidden</span><span class="p">,</span>
                <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span>
                <span class="n">search_filter</span><span class="o">=</span><span class="n">search_filter</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="n">grouped_preview</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">],</span>
                <span class="s2">&quot;stats&quot;</span><span class="p">:</span> <span class="n">grouped_preview</span><span class="p">[</span><span class="s2">&quot;stats&quot;</span><span class="p">],</span>
                <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="n">grouped_preview</span><span class="p">[</span><span class="s2">&quot;total_files&quot;</span><span class="p">],</span>
                <span class="s2">&quot;total_size&quot;</span><span class="p">:</span> <span class="n">grouped_preview</span><span class="p">[</span><span class="s2">&quot;total_size&quot;</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div>
<h4 id="26-backup-progress-stream-endpoint">2.6 Backup Progress Stream Endpoint<a class="headerlink" href="#26-backup-progress-stream-endpoint" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>python/api/backup_progress_stream.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApiHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">stream_template</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.backup</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupService</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BackupProgressStream</span><span class="p">(</span><span class="n">ApiHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stream real-time backup progress&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_auth</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_loopback</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Response</span><span class="p">:</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patterns&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">include_hidden</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_hidden&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">backup_name</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_name&quot;</span><span class="p">,</span> <span class="s2">&quot;agent-zero-backup&quot;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">generate_progress</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">backup_service</span> <span class="o">=</span> <span class="n">BackupService</span><span class="p">()</span>

                <span class="c1"># Generator function for streaming progress</span>
                <span class="k">for</span> <span class="n">progress_data</span> <span class="ow">in</span> <span class="n">backup_service</span><span class="o">.</span><span class="n">create_backup_with_progress</span><span class="p">(</span>
                    <span class="n">patterns</span><span class="o">=</span><span class="n">patterns</span><span class="p">,</span>
                    <span class="n">include_hidden</span><span class="o">=</span><span class="n">include_hidden</span><span class="p">,</span>
                    <span class="n">backup_name</span><span class="o">=</span><span class="n">backup_name</span>
                <span class="p">):</span>
                    <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">progress_data</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;completed&#39;</span><span class="p">:</span><span class="w"> </span><span class="kc">True</span><span class="p">})</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
            <span class="n">generate_progress</span><span class="p">(),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/event-stream&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;Cache-Control&#39;</span><span class="p">:</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Connection&#39;</span><span class="p">:</span> <span class="s1">&#39;keep-alive&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>
</code></pre></div>
<h4 id="27-backup-inspect-endpoint">2.7 Backup Inspect Endpoint<a class="headerlink" href="#27-backup-inspect-endpoint" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>python/api/backup_inspect.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">ApiHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.backup</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackupService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.datastructures</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileStorage</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BackupInspect</span><span class="p">(</span><span class="n">ApiHandler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inspect backup archive and return metadata&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_auth</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">requires_loopback</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Response</span><span class="p">:</span>
        <span class="c1"># Handle file upload</span>
        <span class="k">if</span> <span class="s1">&#39;backup_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No backup file provided&quot;</span><span class="p">}</span>

        <span class="n">backup_file</span><span class="p">:</span> <span class="n">FileStorage</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;backup_file&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">backup_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No file selected&quot;</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backup_service</span> <span class="o">=</span> <span class="n">BackupService</span><span class="p">()</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backup_service</span><span class="o">.</span><span class="n">inspect_backup</span><span class="p">(</span><span class="n">backup_file</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
                <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="s2">&quot;include_patterns&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_patterns&quot;</span><span class="p">,</span> <span class="p">[]),</span>  <span class="c1"># Array of include patterns</span>
                <span class="s2">&quot;exclude_patterns&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude_patterns&quot;</span><span class="p">,</span> <span class="p">[]),</span>  <span class="c1"># Array of exclude patterns</span>
                <span class="s2">&quot;default_patterns&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_patterns&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;agent_zero_version&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_zero_version&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;backup_name&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_files&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="p">[]))),</span>
                <span class="s2">&quot;backup_size&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backup_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="s2">&quot;include_hidden&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_hidden&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div>
<h3 id="3-backup-service-implementation">3. Backup Service Implementation<a class="headerlink" href="#3-backup-service-implementation" title="Permanent link">&para;</a></h3>
<h4 id="core-service-class">Core Service Class<a class="headerlink" href="#core-service-class" title="Permanent link">&para;</a></h4>
<p><strong>File</strong>: <code>python/helpers/backup.py</code></p>
<p><strong>RFC Integration Notes:</strong>
The BackupService leverages Agent Zero's existing file operation helpers which already support RFC (Remote Function Call) routing for development mode. This ensures seamless operation whether running in direct mode or with container isolation.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathspec</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathSpec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathspec.patterns</span><span class="w"> </span><span class="kn">import</span> <span class="n">GitWildMatchPattern</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">files</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span> <span class="n">git</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BackupService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Core backup and restore service for Agent Zero&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_zero_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_agent_zero_version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_zero_root</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Resolved Agent Zero root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>       <span class="c1"># Current user&#39;s home directory</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_default_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get default backup patterns from specification&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DEFAULT_BACKUP_PATTERNS</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_agent_zero_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current Agent Zero version&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get version from git info (same as run_ui.py)</span>
            <span class="n">gitinfo</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">get_git_info</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">gitinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;development&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve pattern path to absolute system path (now patterns are already absolute)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pattern_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_unresolve_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abs_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert absolute path back to pattern path (now patterns are already absolute)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">abs_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse patterns string into include and exclude pattern arrays&quot;&quot;&quot;</span>
        <span class="n">include_patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exclude_patterns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">):</span>
                <span class="c1"># Exclude pattern</span>
                <span class="n">exclude_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># Remove the &#39;!&#39; prefix</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Include pattern</span>
                <span class="n">include_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">include_patterns</span><span class="p">,</span> <span class="n">exclude_patterns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_patterns_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">exclude_patterns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert pattern arrays back to patterns string for pathspec processing&quot;&quot;&quot;</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Add include patterns</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">include_patterns</span><span class="p">:</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

        <span class="c1"># Add exclude patterns with &#39;!&#39; prefix</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">exclude_patterns</span><span class="p">:</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;!</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_system_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect system information for metadata&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">psutil</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;platform&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">platform</span><span class="p">(),</span>
                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">(),</span>
                <span class="s2">&quot;release&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">(),</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">version</span><span class="p">(),</span>
                <span class="s2">&quot;machine&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">machine</span><span class="p">(),</span>
                <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">processor</span><span class="p">(),</span>
                <span class="s2">&quot;architecture&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">architecture</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">(),</span>
                <span class="s2">&quot;python_version&quot;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_version</span><span class="p">(),</span>
                <span class="s2">&quot;cpu_count&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()),</span>
                <span class="s2">&quot;memory_total&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">total</span><span class="p">),</span>
                <span class="s2">&quot;disk_usage&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">total</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to collect system info: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_environment_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect environment information for metadata&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
                <span class="s2">&quot;home&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HOME&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
                <span class="s2">&quot;shell&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SHELL&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[:</span><span class="mi">200</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">astimezone</span><span class="p">()</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">),</span>
                <span class="s2">&quot;working_directory&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
                <span class="s2">&quot;agent_zero_root&quot;</span><span class="p">:</span> <span class="n">files</span><span class="o">.</span><span class="n">get_abs_path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="s2">&quot;runtime_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;development&quot;</span> <span class="k">if</span> <span class="n">runtime</span><span class="o">.</span><span class="n">is_development</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;production&quot;</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to collect environment info: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_backup_author</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get backup author/system identifier&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_file_checksums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matched_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate SHA-256 checksums for files&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

        <span class="n">checksums</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">matched_files</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">real_path</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;real_path&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">real_path</span><span class="p">):</span>
                    <span class="n">hash_sha256</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">real_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                            <span class="n">hash_sha256</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="n">checksums</span><span class="p">[</span><span class="n">real_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_sha256</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">checksums</span><span class="p">[</span><span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;real_path&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>

        <span class="k">return</span> <span class="n">checksums</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_count_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matched_files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count unique directories in file list&quot;&quot;&quot;</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">matched_files</span><span class="p">:</span>
            <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dir_path</span><span class="p">:</span>
                <span class="n">directories</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">directories</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_backup_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate checksum of the entire backup file&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">hash_sha256</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
                    <span class="n">hash_sha256</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hash_sha256</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;error&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">max_files</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test backup patterns and return list of matched files&quot;&quot;&quot;</span>

        <span class="c1"># Parse patterns using pathspec</span>
        <span class="n">pattern_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">patterns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_lines</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">matched_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">processed_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">PathSpec</span><span class="o">.</span><span class="n">from_lines</span><span class="p">(</span><span class="n">GitWildMatchPattern</span><span class="p">,</span> <span class="n">pattern_lines</span><span class="p">)</span>

            <span class="c1"># Walk through base directories</span>
            <span class="k">for</span> <span class="n">base_pattern_path</span><span class="p">,</span> <span class="n">base_real_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_real_path</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files_list</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">base_real_path</span><span class="p">):</span>
                    <span class="c1"># Filter hidden directories if not included</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span><span class="p">:</span>
                        <span class="n">dirs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>

                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">processed_count</span> <span class="o">&gt;=</span> <span class="n">max_files</span><span class="p">:</span>
                            <span class="k">break</span>

                        <span class="c1"># Skip hidden files if not included</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                            <span class="k">continue</span>

                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                        <span class="n">pattern_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unresolve_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

                        <span class="c1"># Remove leading slash for pathspec matching</span>
                        <span class="n">relative_path</span> <span class="o">=</span> <span class="n">pattern_path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">match_file</span><span class="p">(</span><span class="n">relative_path</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                                <span class="n">matched_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">pattern_path</span><span class="p">,</span>
                                    <span class="s2">&quot;real_path&quot;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                                    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
                                    <span class="s2">&quot;modified&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span>
                                <span class="p">})</span>
                                <span class="n">processed_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                                <span class="c1"># Skip files we can&#39;t access</span>
                                <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">processed_count</span> <span class="o">&gt;=</span> <span class="n">max_files</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="n">processed_count</span> <span class="o">&gt;=</span> <span class="n">max_files</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing patterns: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">matched_files</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">backup_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;agent-zero-backup&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create backup archive with selected files&quot;&quot;&quot;</span>

        <span class="c1"># Get matched files</span>
        <span class="n">matched_files</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_patterns</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">include_hidden</span><span class="p">,</span> <span class="n">max_files</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No files matched the backup patterns&quot;</span><span class="p">)</span>

        <span class="c1"># Create temporary zip file</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backup_name</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                <span class="c1"># Calculate file checksums for integrity verification</span>
                <span class="n">file_checksums</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_file_checksums</span><span class="p">(</span><span class="n">matched_files</span><span class="p">)</span>

                <span class="c1"># Add comprehensive metadata - this is the control file for backup/restore</span>
                <span class="n">include_patterns</span><span class="p">,</span> <span class="n">exclude_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_patterns</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>

                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c1"># Basic backup information</span>
                    <span class="s2">&quot;agent_zero_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_zero_version</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;backup_name&quot;</span><span class="p">:</span> <span class="n">backup_name</span><span class="p">,</span>
                    <span class="s2">&quot;include_hidden&quot;</span><span class="p">:</span> <span class="n">include_hidden</span><span class="p">,</span>

                    <span class="c1"># Pattern arrays for granular control during restore</span>
                    <span class="s2">&quot;include_patterns&quot;</span><span class="p">:</span> <span class="n">include_patterns</span><span class="p">,</span>  <span class="c1"># Array of include patterns</span>
                    <span class="s2">&quot;exclude_patterns&quot;</span><span class="p">:</span> <span class="n">exclude_patterns</span><span class="p">,</span>  <span class="c1"># Array of exclude patterns</span>

                    <span class="c1"># System and environment information</span>
                    <span class="s2">&quot;system_info&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_system_info</span><span class="p">(),</span>
                    <span class="s2">&quot;environment_info&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_environment_info</span><span class="p">(),</span>
                    <span class="s2">&quot;backup_author&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_backup_author</span><span class="p">(),</span>

                    <span class="c1"># Backup configuration</span>
                    <span class="s2">&quot;backup_config&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;default_patterns&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_patterns</span><span class="p">(),</span>
                        <span class="s2">&quot;include_hidden&quot;</span><span class="p">:</span> <span class="n">include_hidden</span><span class="p">,</span>
                        <span class="s2">&quot;compression_level&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="s2">&quot;integrity_check&quot;</span><span class="p">:</span> <span class="kc">True</span>
                    <span class="p">},</span>

                    <span class="c1"># File information with checksums</span>
                    <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;modified&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;modified&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;checksum&quot;</span><span class="p">:</span> <span class="n">file_checksums</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;real_path&quot;</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">matched_files</span>
                    <span class="p">],</span>

                    <span class="c1"># Statistics</span>
                    <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_files</span><span class="p">),</span>
                    <span class="s2">&quot;backup_size&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">matched_files</span><span class="p">),</span>
                    <span class="s2">&quot;directory_count&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_directories</span><span class="p">(</span><span class="n">matched_files</span><span class="p">),</span>

                    <span class="c1"># Integrity verification</span>
                    <span class="s2">&quot;backup_checksum&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># Will be calculated after backup creation</span>
                    <span class="s2">&quot;verification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256&quot;</span>
                <span class="p">}</span>

                <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

                <span class="c1"># Add files</span>
                <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">matched_files</span><span class="p">:</span>
                    <span class="n">real_path</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;real_path&quot;</span><span class="p">]</span>
                    <span class="n">archive_path</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">real_path</span><span class="p">):</span>
                            <span class="n">zipf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">real_path</span><span class="p">,</span> <span class="n">archive_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># Log error but continue with other files</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not backup file </span><span class="si">{</span><span class="n">real_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

            <span class="k">return</span> <span class="n">zip_path</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Cleanup on error</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">zip_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating backup: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">inspect_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inspect backup archive and return metadata&quot;&quot;&quot;</span>

        <span class="c1"># Save uploaded file temporarily</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">temp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;backup.zip&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backup_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                <span class="c1"># Read metadata</span>
                <span class="k">if</span> <span class="s2">&quot;metadata.json&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zipf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid backup file: missing metadata.json&quot;</span><span class="p">)</span>

                <span class="n">metadata_content</span> <span class="o">=</span> <span class="n">zipf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">metadata_content</span><span class="p">)</span>

                <span class="c1"># Add file list from archive</span>
                <span class="n">files_in_archive</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">zipf</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;metadata.json&quot;</span><span class="p">]</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;files_in_archive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files_in_archive</span>

                <span class="k">return</span> <span class="n">metadata</span>

        <span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipFile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid backup file: not a valid zip archive&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid backup file: corrupted metadata&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Cleanup</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_grouped_file_preview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">search_filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get files organized in smart groups with depth limitation&quot;&quot;&quot;</span>

        <span class="c1"># Get all matched files</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_patterns</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">include_hidden</span><span class="p">,</span> <span class="n">max_files</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

        <span class="c1"># Apply search filter if provided</span>
        <span class="k">if</span> <span class="n">search_filter</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">search_lower</span> <span class="o">=</span> <span class="n">search_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">all_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">all_files</span> <span class="k">if</span> <span class="n">search_lower</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

        <span class="c1"># Group files by directory structure</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
            <span class="n">total_size</span> <span class="o">+=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>

            <span class="c1"># Split path and limit depth</span>
            <span class="n">path_parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

            <span class="c1"># Limit to max_depth for grouping</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_depth</span><span class="p">:</span>
                <span class="n">group_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_parts</span><span class="p">[:</span><span class="n">max_depth</span><span class="p">])</span>
                <span class="n">is_truncated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;/&#39;</span>
                <span class="n">is_truncated</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">group_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">groups</span><span class="p">[</span><span class="n">group_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">group_path</span><span class="p">,</span>
                    <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;file_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;total_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;is_truncated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;subdirectories&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span>
                <span class="p">}</span>

            <span class="n">groups</span><span class="p">[</span><span class="n">group_path</span><span class="p">][</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_info</span><span class="p">)</span>
            <span class="n">groups</span><span class="p">[</span><span class="n">group_path</span><span class="p">][</span><span class="s2">&quot;file_count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">groups</span><span class="p">[</span><span class="n">group_path</span><span class="p">][</span><span class="s2">&quot;total_size&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
            <span class="n">groups</span><span class="p">[</span><span class="n">group_path</span><span class="p">][</span><span class="s2">&quot;is_truncated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">group_path</span><span class="p">][</span><span class="s2">&quot;is_truncated&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">is_truncated</span>

            <span class="c1"># Track subdirectories for truncated groups</span>
            <span class="k">if</span> <span class="n">is_truncated</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_depth</span><span class="p">:</span>
                <span class="n">next_dir</span> <span class="o">=</span> <span class="n">path_parts</span><span class="p">[</span><span class="n">max_depth</span><span class="p">]</span>
                <span class="n">groups</span><span class="p">[</span><span class="n">group_path</span><span class="p">][</span><span class="s2">&quot;subdirectories&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">next_dir</span><span class="p">)</span>

        <span class="c1"># Convert groups to sorted list and add display info</span>
        <span class="n">sorted_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group_path</span><span class="p">,</span> <span class="n">group_info</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;subdirectories&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;subdirectories&quot;</span><span class="p">]))</span>

            <span class="c1"># Limit displayed files for UI performance</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;displayed_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span>
                <span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;additional_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">50</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;displayed_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span>
                <span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;additional_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">sorted_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="n">sorted_groups</span><span class="p">,</span>
            <span class="s2">&quot;stats&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;total_groups&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_groups</span><span class="p">),</span>
                <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">),</span>
                <span class="s2">&quot;total_size&quot;</span><span class="p">:</span> <span class="n">total_size</span><span class="p">,</span>
                <span class="s2">&quot;search_applied&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">search_filter</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">max_depth</span>
            <span class="p">},</span>
            <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">),</span>
            <span class="s2">&quot;total_size&quot;</span><span class="p">:</span> <span class="n">total_size</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_backup_with_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_hidden</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">backup_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;agent-zero-backup&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generator that yields backup progress for streaming&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 1: Get matched files</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;discovery&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Scanning files...&quot;</span><span class="p">,</span>
                <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>

            <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
            <span class="n">matched_files</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_patterns</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">include_hidden</span><span class="p">,</span> <span class="n">max_files</span><span class="o">=</span><span class="mi">10000</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_files</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">{</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No files matched the backup patterns&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">}</span>
                <span class="k">return</span>

            <span class="n">total_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_files</span><span class="p">)</span>

            <span class="k">yield</span> <span class="p">{</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;discovery&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">total_files</span><span class="si">}</span><span class="s2"> files to backup&quot;</span><span class="p">,</span>
                <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="n">total_files</span>
            <span class="p">}</span>

            <span class="c1"># Step 2: Calculate checksums</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;checksums&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Calculating file checksums...&quot;</span><span class="p">,</span>
                <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>

            <span class="n">file_checksums</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calculate_file_checksums</span><span class="p">(</span><span class="n">matched_files</span><span class="p">))</span>

            <span class="c1"># Step 3: Create backup</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
            <span class="n">zip_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">backup_name</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">)</span>

            <span class="k">yield</span> <span class="p">{</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;backup&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Creating backup archive...&quot;</span><span class="p">,</span>
                <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>

            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                <span class="c1"># Create and add metadata first</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;agent_zero_version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_zero_version</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;backup_name&quot;</span><span class="p">:</span> <span class="n">backup_name</span><span class="p">,</span>
                    <span class="s2">&quot;backup_patterns&quot;</span><span class="p">:</span> <span class="n">patterns</span><span class="p">,</span>
                    <span class="s2">&quot;include_hidden&quot;</span><span class="p">:</span> <span class="n">include_hidden</span><span class="p">,</span>
                    <span class="s2">&quot;system_info&quot;</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_system_info</span><span class="p">()),</span>
                    <span class="s2">&quot;environment_info&quot;</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_environment_info</span><span class="p">()),</span>
                    <span class="s2">&quot;backup_author&quot;</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_backup_author</span><span class="p">()),</span>
                    <span class="s2">&quot;backup_config&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;default_patterns&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_patterns</span><span class="p">(),</span>
                        <span class="s2">&quot;custom_patterns&quot;</span><span class="p">:</span> <span class="n">patterns</span><span class="p">,</span>
                        <span class="s2">&quot;include_hidden&quot;</span><span class="p">:</span> <span class="n">include_hidden</span><span class="p">,</span>
                        <span class="s2">&quot;compression_level&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="s2">&quot;integrity_check&quot;</span><span class="p">:</span> <span class="kc">True</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;modified&quot;</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;modified&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;checksum&quot;</span><span class="p">:</span> <span class="n">file_checksums</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;real_path&quot;</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span>
                        <span class="p">}</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">matched_files</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_files</span><span class="p">),</span>
                    <span class="s2">&quot;backup_size&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">matched_files</span><span class="p">),</span>
                    <span class="s2">&quot;directory_count&quot;</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_count_directories</span><span class="p">(</span><span class="n">matched_files</span><span class="p">)),</span>
                    <span class="s2">&quot;backup_checksum&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;verification_method&quot;</span><span class="p">:</span> <span class="s2">&quot;sha256&quot;</span>
                <span class="p">}</span>

                <span class="n">zipf</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

                <span class="c1"># Add files with progress updates</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matched_files</span><span class="p">):</span>
                    <span class="n">real_path</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;real_path&quot;</span><span class="p">]</span>
                    <span class="n">archive_path</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">real_path</span><span class="p">):</span>
                            <span class="n">zipf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">real_path</span><span class="p">,</span> <span class="n">archive_path</span><span class="p">)</span>

                            <span class="c1"># Yield progress every 10 files or at key milestones</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">total_files</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">progress</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_files</span> <span class="o">*</span> <span class="mi">70</span>  <span class="c1"># 20-90%</span>
                                <span class="k">yield</span> <span class="p">{</span>
                                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;backup&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Adding file: </span><span class="si">{</span><span class="n">file_info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">progress</span><span class="p">),</span>
                                    <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s2">&quot;current_file&quot;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="n">total_files</span><span class="p">,</span>
                                    <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span>
                                <span class="p">}</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">{</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to backup file: </span><span class="si">{</span><span class="n">file_info</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_files</span> <span class="o">*</span> <span class="mi">70</span><span class="p">),</span>
                            <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="kc">True</span>
                        <span class="p">}</span>

            <span class="c1"># Step 4: Calculate final checksum</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;finalization&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Calculating backup checksum...&quot;</span><span class="p">,</span>
                <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span>
                <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>

            <span class="n">backup_checksum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_backup_checksum</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>

            <span class="c1"># Step 5: Complete</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Backup created successfully&quot;</span><span class="p">,</span>
                <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;backup_path&quot;</span><span class="p">:</span> <span class="n">zip_path</span><span class="p">,</span>
                <span class="s2">&quot;backup_checksum&quot;</span><span class="p">:</span> <span class="n">backup_checksum</span><span class="p">,</span>
                <span class="s2">&quot;total_files&quot;</span><span class="p">:</span> <span class="n">total_files</span><span class="p">,</span>
                <span class="s2">&quot;backup_size&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Backup failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">restore_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_file</span><span class="p">,</span> <span class="n">restore_patterns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">overwrite_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;overwrite&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore files from backup archive&quot;&quot;&quot;</span>

        <span class="c1"># Save uploaded file temporarily</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">temp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;backup.zip&quot;</span><span class="p">)</span>

        <span class="n">restored_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backup_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>

            <span class="c1"># Parse restore patterns if provided</span>
            <span class="k">if</span> <span class="n">restore_patterns</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">pattern_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">restore_patterns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                               <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">PathSpec</span><span class="o">.</span><span class="n">from_lines</span><span class="p">(</span><span class="n">GitWildMatchPattern</span><span class="p">,</span> <span class="n">pattern_lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern_lines</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                <span class="c1"># Read metadata</span>
                <span class="k">if</span> <span class="s2">&quot;metadata.json&quot;</span> <span class="ow">in</span> <span class="n">zipf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                    <span class="n">metadata_content</span> <span class="o">=</span> <span class="n">zipf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">metadata_content</span><span class="p">)</span>

                <span class="c1"># Process each file in archive</span>
                <span class="k">for</span> <span class="n">archive_path</span> <span class="ow">in</span> <span class="n">zipf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">archive_path</span> <span class="o">==</span> <span class="s2">&quot;metadata.json&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Check if file matches restore patterns</span>
                    <span class="k">if</span> <span class="n">spec</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">spec</span><span class="o">.</span><span class="n">match_file</span><span class="p">(</span><span class="n">archive_path</span><span class="p">):</span>
                        <span class="n">skipped_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">archive_path</span><span class="p">,</span>
                            <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;not_matched_by_pattern&quot;</span>
                        <span class="p">})</span>
                        <span class="k">continue</span>

                    <span class="c1"># Determine target path</span>
                    <span class="n">target_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_path</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">archive_path</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Handle overwrite policy</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">overwrite_policy</span> <span class="o">==</span> <span class="s2">&quot;skip&quot;</span><span class="p">:</span>
                                <span class="n">skipped_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">archive_path</span><span class="p">,</span>
                                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;file_exists_skip_policy&quot;</span>
                                <span class="p">})</span>
                                <span class="k">continue</span>
                            <span class="k">elif</span> <span class="n">overwrite_policy</span> <span class="o">==</span> <span class="s2">&quot;backup&quot;</span><span class="p">:</span>
                                <span class="n">backup_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">.backup.</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">backup_path</span><span class="p">)</span>

                        <span class="c1"># Create target directory if needed</span>
                        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="c1"># Extract file</span>
                        <span class="k">with</span> <span class="n">zipf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

                        <span class="n">restored_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;archive_path&quot;</span><span class="p">:</span> <span class="n">archive_path</span><span class="p">,</span>
                            <span class="s2">&quot;target_path&quot;</span><span class="p">:</span> <span class="n">target_path</span><span class="p">,</span>
                            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;restored&quot;</span>
                        <span class="p">})</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">archive_path</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="p">})</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;restored_files&quot;</span><span class="p">:</span> <span class="n">restored_files</span><span class="p">,</span>
                <span class="s2">&quot;skipped_files&quot;</span><span class="p">:</span> <span class="n">skipped_files</span><span class="p">,</span>
                <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">errors</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error restoring backup: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Cleanup</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">preview_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_file</span><span class="p">,</span> <span class="n">restore_patterns</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Preview which files would be restored based on patterns&quot;&quot;&quot;</span>

        <span class="c1"># Save uploaded file temporarily</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">temp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;backup.zip&quot;</span><span class="p">)</span>

        <span class="n">files_to_restore</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skipped_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">backup_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>

            <span class="c1"># Parse restore patterns if provided</span>
            <span class="k">if</span> <span class="n">restore_patterns</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">pattern_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">restore_patterns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                               <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">PathSpec</span><span class="o">.</span><span class="n">from_lines</span><span class="p">(</span><span class="n">GitWildMatchPattern</span><span class="p">,</span> <span class="n">pattern_lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">pattern_lines</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipf</span><span class="p">:</span>
                <span class="c1"># Read metadata for context</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="s2">&quot;metadata.json&quot;</span> <span class="ow">in</span> <span class="n">zipf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                    <span class="n">metadata_content</span> <span class="o">=</span> <span class="n">zipf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">metadata_content</span><span class="p">)</span>

                <span class="c1"># Process each file in archive</span>
                <span class="k">for</span> <span class="n">archive_path</span> <span class="ow">in</span> <span class="n">zipf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">archive_path</span> <span class="o">==</span> <span class="s2">&quot;metadata.json&quot;</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Check if file matches restore patterns</span>
                    <span class="k">if</span> <span class="n">spec</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">match_file</span><span class="p">(</span><span class="n">archive_path</span><span class="p">):</span>
                            <span class="n">files_to_restore</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">archive_path</span><span class="p">,</span>
                                <span class="s2">&quot;target_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_path</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">archive_path</span><span class="p">),</span>
                                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;restore&quot;</span>
                            <span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">skipped_files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">archive_path</span><span class="p">,</span>
                                <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;not_matched_by_pattern&quot;</span>
                            <span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># No patterns specified, restore all files</span>
                        <span class="n">files_to_restore</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">archive_path</span><span class="p">,</span>
                            <span class="s2">&quot;target_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_path</span><span class="p">(</span><span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">archive_path</span><span class="p">),</span>
                            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;restore&quot;</span>
                        <span class="p">})</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">files_to_restore</span><span class="p">,</span>
                <span class="s2">&quot;skipped_files&quot;</span><span class="p">:</span> <span class="n">skipped_files</span><span class="p">,</span>
                <span class="s2">&quot;total_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_to_restore</span><span class="p">),</span>
                <span class="s2">&quot;skipped_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">skipped_files</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error previewing restore: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Cleanup</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
</code></pre></div>
<h3 id="4-dependencies">4. Dependencies<a class="headerlink" href="#4-dependencies" title="Permanent link">&para;</a></h3>
<h4 id="required-python-packages">Required Python Packages<a class="headerlink" href="#required-python-packages" title="Permanent link">&para;</a></h4>
<p>Add to <code>requirements.txt</code>:
<div class="highlight"><pre><span></span><code>pathspec&gt;=0.10.0  # For gitignore-style pattern matching
psutil&gt;=5.8.0     # For system information collection
</code></pre></div></p>
<h4 id="agent-zero-internal-dependencies">Agent Zero Internal Dependencies<a class="headerlink" href="#agent-zero-internal-dependencies" title="Permanent link">&para;</a></h4>
<p>The backup system requires these Agent Zero helper modules:
- <code>python.helpers.git</code> - For version detection using git.get_git_info() (consistent with run_ui.py)
- <code>python.helpers.files</code> - For file operations and path resolution
- <code>python.helpers.runtime</code> - For development/production mode detection</p>
<h4 id="installation-command">Installation Command<a class="headerlink" href="#installation-command" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>pathspec<span class="w"> </span>psutil
</code></pre></div>
<h3 id="5-error-handling">5. Error Handling<a class="headerlink" href="#5-error-handling" title="Permanent link">&para;</a></h3>
<h4 id="integration-with-agent-zero-error-system">Integration with Agent Zero Error System<a class="headerlink" href="#integration-with-agent-zero-error-system" title="Permanent link">&para;</a></h4>
<p>The backup system integrates with Agent Zero's existing error handling infrastructure:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">python.helpers.print_style</span><span class="w"> </span><span class="kn">import</span> <span class="n">PrintStyle</span>

<span class="c1"># Follow Agent Zero&#39;s error handling patterns</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backup_operation</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">error_message</span> <span class="o">=</span> <span class="n">format_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">PrintStyle</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backup error: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_message</span><span class="p">}</span>
</code></pre></div>
<h4 id="common-error-scenarios">Common Error Scenarios<a class="headerlink" href="#common-error-scenarios" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Invalid Patterns</strong>: Malformed glob patterns</li>
<li><strong>Permission Errors</strong>: Files/directories not accessible</li>
<li><strong>Disk Space</strong>: Insufficient space for backup creation</li>
<li><strong>Invalid Archives</strong>: Corrupted or invalid backup files</li>
<li><strong>Path Conflicts</strong>: Files outside allowed directories</li>
</ol>
<h4 id="error-response-format">Error Response Format<a class="headerlink" href="#error-response-format" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Human-readable error message&quot;</span><span class="p">,</span>
    <span class="s2">&quot;error_code&quot;</span><span class="p">:</span> <span class="s2">&quot;BACKUP_PATTERN_INVALID&quot;</span><span class="p">,</span>  <span class="c1"># Optional machine-readable code</span>
    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Optional additional details</span>
        <span class="s2">&quot;invalid_patterns&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pattern1&quot;</span><span class="p">,</span> <span class="s2">&quot;pattern2&quot;</span><span class="p">],</span>
        <span class="s2">&quot;suggestion&quot;</span><span class="p">:</span> <span class="s2">&quot;Check pattern syntax&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="6-security-considerations">6. Security Considerations<a class="headerlink" href="#6-security-considerations" title="Permanent link">&para;</a></h3>
<h4 id="path-security">Path Security<a class="headerlink" href="#path-security" title="Permanent link">&para;</a></h4>
<ul>
<li>Validate all paths to prevent directory traversal attacks</li>
<li>Restrict backups to predefined base directories (/a0, /root)</li>
<li>Sanitize file names in archives</li>
<li>Implement file size limits for uploads/downloads</li>
</ul>
<h4 id="authentication">Authentication<a class="headerlink" href="#authentication" title="Permanent link">&para;</a></h4>
<ul>
<li>All endpoints require authentication (<code>requires_auth = True</code>)</li>
<li>All endpoints require loopback (<code>requires_loopback = True</code>)</li>
<li>No API key access for security</li>
</ul>
<h4 id="file-system-protection">File System Protection<a class="headerlink" href="#file-system-protection" title="Permanent link">&para;</a></h4>
<ul>
<li>Read-only access to system directories outside allowed paths</li>
<li>Size limits for backup archives</li>
<li>Timeout limits for backup operations</li>
<li>Temporary file cleanup</li>
</ul>
<h3 id="7-performance-considerations">7. Performance Considerations<a class="headerlink" href="#7-performance-considerations" title="Permanent link">&para;</a></h3>
<h4 id="file-processing">File Processing<a class="headerlink" href="#file-processing" title="Permanent link">&para;</a></h4>
<ul>
<li>Limit number of files in test/preview operations (max_files parameter)</li>
<li>Stream file processing for large archives</li>
<li>Implement progress tracking for large operations</li>
<li>Use temporary directories for staging</li>
</ul>
<h4 id="memory-management">Memory Management<a class="headerlink" href="#memory-management" title="Permanent link">&para;</a></h4>
<ul>
<li>Stream zip file creation to avoid memory issues</li>
<li>Process files individually rather than loading all in memory</li>
<li>Clean up temporary files promptly</li>
<li>Implement timeout limits for long operations</li>
</ul>
<h3 id="8-configuration">8. Configuration<a class="headerlink" href="#8-configuration" title="Permanent link">&para;</a></h3>
<h4 id="default-configuration">Default Configuration<a class="headerlink" href="#default-configuration" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">BACKUP_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_files_preview&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="s2">&quot;max_backup_size&quot;</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c1"># 1GB</span>
    <span class="s2">&quot;max_upload_size&quot;</span><span class="p">:</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>  <span class="c1"># 1GB</span>
    <span class="s2">&quot;operation_timeout&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 minutes</span>
    <span class="s2">&quot;temp_cleanup_interval&quot;</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span>  <span class="c1"># 1 hour</span>
    <span class="s2">&quot;allowed_base_paths&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/a0&quot;</span><span class="p">,</span> <span class="s2">&quot;/root&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="future-integration-opportunities">Future Integration Opportunities<a class="headerlink" href="#future-integration-opportunities" title="Permanent link">&para;</a></h4>
<p><strong>Task Scheduler Integration:</strong>
Agent Zero's existing task scheduler could be extended to support automated backups:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Potential future enhancement - scheduled backups</span>
<span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;auto_backup_daily&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;scheduled&quot;</span><span class="p">,</span>
    <span class="s2">&quot;schedule&quot;</span><span class="p">:</span> <span class="s2">&quot;0 2 * * *&quot;</span><span class="p">,</span>  <span class="c1"># Daily at 2 AM</span>
    <span class="s2">&quot;tool_name&quot;</span><span class="p">:</span> <span class="s2">&quot;backup_create&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tool_args&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;patterns&quot;</span><span class="p">:</span> <span class="s2">&quot;default_patterns&quot;</span><span class="p">,</span>
        <span class="s2">&quot;backup_name&quot;</span><span class="p">:</span> <span class="s2">&quot;auto_backup_</span><span class="si">{date}</span><span class="s2">&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="enhanced-metadata-structure-and-restore-workflow">Enhanced Metadata Structure and Restore Workflow<a class="headerlink" href="#enhanced-metadata-structure-and-restore-workflow" title="Permanent link">&para;</a></h2>
<h3 id="version-detection-implementation">Version Detection Implementation<a class="headerlink" href="#version-detection-implementation" title="Permanent link">&para;</a></h3>
<p>The backup system uses the same version detection method as Agent Zero's main UI:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_agent_zero_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get current Agent Zero version&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get version from git info (same as run_ui.py)</span>
        <span class="n">gitinfo</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">get_git_info</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">gitinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;development&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>
</code></pre></div>
<p>This ensures consistency between the backup metadata and the main application version reporting.</p>
<h3 id="metadatajson-format">Metadata.json Format<a class="headerlink" href="#metadatajson-format" title="Permanent link">&para;</a></h3>
<p>The backup archive includes a comprehensive <code>metadata.json</code> file with the following structure:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;agent_zero_version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;version&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ISO datetime&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;backup_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user-defined name&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;include_hidden&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">boolea</span><span class="kc">n</span><span class="p">,</span>

<span class="w">  </span><span class="nt">&quot;include_patterns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;/a0/knowledge/**&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;/a0/instruments/**&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;/a0/memory/**&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;/a0/.env&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;/a0/tmp/settings.json&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;exclude_patterns&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;/a0/knowledge/default/**&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;/a0/instruments/default/**&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;/a0/memory/embeddings/**&quot;</span>
<span class="w">  </span><span class="p">],</span>

<span class="w">  </span><span class="nt">&quot;system_info&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* platform, architecture, etc. */</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;environment_info&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* user, timezone, paths, etc. */</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;backup_author&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@hostname&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;backup_config&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;default_patterns&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system defaults&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;include_hidden&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">boolea</span><span class="kc">n</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;compression_level&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;integrity_check&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="nt">&quot;files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="cm">/* file list with checksums */</span><span class="w"> </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;total_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">cou</span><span class="kc">nt</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;backup_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="err">by</span><span class="kc">tes</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;backup_checksum&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;sha256&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="restore-workflow">Restore Workflow<a class="headerlink" href="#restore-workflow" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Upload Archive</strong>: User uploads backup.zip file</li>
<li><strong>Load Metadata</strong>: System extracts and parses metadata.json</li>
<li><strong>Display Metadata</strong>: Complete metadata.json shown in ACE JSON editor</li>
<li><strong>User Editing</strong>: User can modify include_patterns and exclude_patterns arrays directly</li>
<li><strong>Preview Changes</strong>: System shows which files will be restored based on current metadata</li>
<li><strong>Execute Restore</strong>: Files restored according to final metadata configuration</li>
</ol>
<h3 id="json-metadata-editing-benefits">JSON Metadata Editing Benefits<a class="headerlink" href="#json-metadata-editing-benefits" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Single Source of Truth</strong>: metadata.json is the authoritative configuration</li>
<li><strong>Direct Editing</strong>: Users edit JSON arrays directly in ACE editor</li>
<li><strong>Full Control</strong>: Access to all metadata properties, not just patterns</li>
<li><strong>Validation</strong>: JSON syntax validation and array structure validation</li>
<li><strong>Transparency</strong>: Users see exactly what will be used for restore</li>
</ul>
<h2 id="comprehensive-enhancement-summary">Comprehensive Enhancement Summary<a class="headerlink" href="#comprehensive-enhancement-summary" title="Permanent link">&para;</a></h2>
<h3 id="enhanced-metadata-structure">Enhanced Metadata Structure<a class="headerlink" href="#enhanced-metadata-structure" title="Permanent link">&para;</a></h3>
<p>The backup metadata has been significantly enhanced to include:
- <strong>System Information</strong>: Platform, architecture, Python version, CPU count, memory, disk usage
- <strong>Environment Details</strong>: User, timezone, working directory, runtime mode, Agent Zero root path
- <strong>Backup Author</strong>: System identifier (user@hostname) for backup tracking
- <strong>File Checksums</strong>: SHA-256 hashes for all backed up files for integrity verification
- <strong>Backup Statistics</strong>: Total files, directories, sizes with verification methods
- <strong>Compatibility Data</strong>: Agent Zero version and environment for restoration validation</p>
<h3 id="smart-file-management">Smart File Management<a class="headerlink" href="#smart-file-management" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Grouped File Preview</strong>: Organize files by directory structure with depth limitation (max 3 levels)</li>
<li><strong>Smart Grouping</strong>: Show directory hierarchies with expandable file counts</li>
<li><strong>Search and Filter</strong>: Real-time filtering by file name or path fragments</li>
<li><strong>Performance Optimization</strong>: Limit preview files (1000 max) and displayed files (50 per group) for UI responsiveness</li>
</ul>
<h3 id="real-time-progress-streaming">Real-time Progress Streaming<a class="headerlink" href="#real-time-progress-streaming" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Server-Sent Events</strong>: Live backup progress updates via <code>/backup_progress_stream</code> endpoint</li>
<li><strong>Multi-stage Progress</strong>: Discovery → Checksums → Backup → Finalization with percentage tracking</li>
<li><strong>File-by-file Updates</strong>: Real-time display of current file being processed</li>
<li><strong>Error Handling</strong>: Graceful error reporting and warning collection during backup process</li>
</ul>
<h3 id="advanced-api-endpoints">Advanced API Endpoints<a class="headerlink" href="#advanced-api-endpoints" title="Permanent link">&para;</a></h3>
<ol>
<li><strong><code>/backup_preview_grouped</code></strong>: Get smart file groupings with depth control and search</li>
<li><strong><code>/backup_progress_stream</code></strong>: Stream real-time backup progress via SSE</li>
<li><strong><code>/backup_restore_preview</code></strong>: Preview restore operations with pattern filtering</li>
<li><strong>Enhanced <code>/backup_inspect</code></strong>: Return comprehensive metadata with system information</li>
</ol>
<h3 id="system-information-collection">System Information Collection<a class="headerlink" href="#system-information-collection" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Platform Detection</strong>: OS, architecture, Python version, hostname</li>
<li><strong>Resource Information</strong>: CPU count, memory, disk usage via psutil (converted to strings for JSON consistency)</li>
<li><strong>Environment Capture</strong>: User, timezone, paths, runtime mode</li>
<li><strong>Version Integration</strong>: Uses git.get_git_info() for consistent version detection with main application</li>
<li><strong>Integrity Verification</strong>: SHA-256 checksums for individual files and complete backup</li>
</ul>
<h3 id="security-and-reliability-enhancements">Security and Reliability Enhancements<a class="headerlink" href="#security-and-reliability-enhancements" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Integrity Verification</strong>: File-level and backup-level checksum validation</li>
<li><strong>Comprehensive Logging</strong>: Detailed progress tracking and error collection</li>
<li><strong>Path Security</strong>: Enhanced validation with system information context</li>
<li><strong>Backup Validation</strong>: Version compatibility checking and environment verification</li>
</ul>
<p>This enhanced backend specification provides a production-ready, comprehensive backup and restore system with advanced metadata tracking, real-time progress monitoring, and intelligent file management capabilities, all while maintaining Agent Zero's architectural patterns and security standards.</p>
<h3 id="implementation-status-updates">Implementation Status Updates<a class="headerlink" href="#implementation-status-updates" title="Permanent link">&para;</a></h3>
<h4 id="completed-core-backupservice-implementation">✅ COMPLETED: Core BackupService Implementation<a class="headerlink" href="#completed-core-backupservice-implementation" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>Git Version Integration</strong>: Updated to use <code>git.get_git_info()</code> consistent with <code>run_ui.py</code></li>
<li><strong>Type Safety</strong>: Fixed psutil return values to be strings for JSON metadata consistency</li>
<li><strong>Code Quality</strong>: All linting errors resolved, proper import structure</li>
<li><strong>Testing Verified</strong>: BackupService initializes correctly and detects Agent Zero root paths</li>
<li><strong>Dependencies Added</strong>: pathspec&gt;=0.10.0 for pattern matching, psutil&gt;=5.8.0 for system info</li>
<li><strong>Git Helper Integration</strong>: Uses python.helpers.git.get_git_info() for version detection consistency</li>
</ul>
<h4 id="next-implementation-phase-api-endpoints">Next Implementation Phase: API Endpoints<a class="headerlink" href="#next-implementation-phase-api-endpoints" title="Permanent link">&para;</a></h4>
<p>Ready to implement the 8 API endpoints:
1. <code>backup_test.py</code> - Pattern testing and file preview
2. <code>backup_create.py</code> - Archive creation and download
3. <code>backup_restore.py</code> - File restoration from archive
4. <code>backup_inspect.py</code> - Archive metadata inspection
5. <code>backup_get_defaults.py</code> - Fetch default patterns
6. <code>backup_restore_preview.py</code> - Preview restore patterns
7. <code>backup_preview_grouped.py</code> - Smart directory grouping
8. <code>backup_progress_stream.py</code> - Real-time progress streaming</p>
<h2 id="implementation-cleanup-and-final-status">Implementation Cleanup and Final Status<a class="headerlink" href="#implementation-cleanup-and-final-status" title="Permanent link">&para;</a></h2>
<h3 id="completed-cleanup-december-2024">✅ <strong>COMPLETED CLEANUP (December 2024)</strong><a class="headerlink" href="#completed-cleanup-december-2024" title="Permanent link">&para;</a></h3>
<h4 id="removed-unused-components"><strong>Removed Unused Components:</strong><a class="headerlink" href="#removed-unused-components" title="Permanent link">&para;</a></h4>
<ul>
<li>❌ <strong><code>backup_download.py</code></strong> - Functionality moved to <code>backup_create</code> (direct download)</li>
<li>❌ <strong><code>backup_progress_stream.py</code></strong> - Not implemented in frontend, overengineered</li>
<li>❌ <strong><code>_calculate_file_checksums()</code> method</strong> - Dead code, checksums not properly used</li>
<li>❌ <strong><code>_calculate_backup_checksum()</code> method</strong> - Dead code, never called</li>
<li>❌ <strong><code>hashlib</code> import</strong> - No longer needed after checksum removal</li>
</ul>
<h4 id="simplified-backupservice"><strong>Simplified BackupService:</strong><a class="headerlink" href="#simplified-backupservice" title="Permanent link">&para;</a></h4>
<ul>
<li>✅ <strong>Removed checksum calculation</strong> - Was calculated but not properly used, overcomplicating the code</li>
<li>✅ <strong>Streamlined metadata</strong> - Removed unused integrity verification fields</li>
<li>✅ <strong>Fixed <code>_count_directories()</code> method</strong> - Had return statement in wrong place</li>
<li>✅ <strong>Cleaner error handling</strong> - Removed unnecessary warning outputs</li>
</ul>
<h4 id="enhanced-hidden-file-logic"><strong>Enhanced Hidden File Logic:</strong><a class="headerlink" href="#enhanced-hidden-file-logic" title="Permanent link">&para;</a></h4>
<p>The most critical fix was implementing proper explicit pattern handling:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># NEW: Enhanced hidden file logic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_explicit_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_patterns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract explicit (non-wildcard) patterns that should always be included&quot;&quot;&quot;</span>
    <span class="n">explicit_patterns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">include_patterns</span><span class="p">:</span>
        <span class="c1"># If pattern doesn&#39;t contain wildcards, it&#39;s explicit</span>
        <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pattern</span> <span class="ow">and</span> <span class="s1">&#39;?&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
            <span class="c1"># Remove leading slash for comparison</span>
            <span class="n">explicit_patterns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>

            <span class="c1"># Also add parent directories as explicit (so hidden dirs can be traversed)</span>
            <span class="n">path_parts</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">path_parts</span><span class="p">)):</span>
                <span class="n">parent_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_parts</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
                <span class="n">explicit_patterns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parent_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">explicit_patterns</span>

<span class="c1"># FIXED: Hidden file filtering now respects explicit patterns</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">include_hidden</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_explicitly_included</span><span class="p">(</span><span class="n">pattern_path</span><span class="p">,</span> <span class="n">explicit_patterns</span><span class="p">):</span>
        <span class="k">continue</span>  <span class="c1"># Only exclude hidden files discovered via wildcards</span>
</code></pre></div>
<h4 id="final-api-endpoint-set-6-endpoints"><strong>Final API Endpoint Set (6 endpoints):</strong><a class="headerlink" href="#final-api-endpoint-set-6-endpoints" title="Permanent link">&para;</a></h4>
<ol>
<li>✅ <strong><code>backup_get_defaults</code></strong> - Get default metadata configuration</li>
<li>✅ <strong><code>backup_test</code></strong> - Test patterns and preview files (dry run)</li>
<li>✅ <strong><code>backup_preview_grouped</code></strong> - Get grouped file preview for UI</li>
<li>✅ <strong><code>backup_create</code></strong> - Create and download backup archive</li>
<li>✅ <strong><code>backup_inspect</code></strong> - Inspect uploaded backup metadata</li>
<li>✅ <strong><code>backup_restore_preview</code></strong> - Preview restore operation</li>
<li>✅ <strong><code>backup_restore</code></strong> - Execute restore operation</li>
</ol>
<h3 id="critical-issue-fixed-hidden-files"><strong>Critical Issue Fixed: Hidden Files</strong><a class="headerlink" href="#critical-issue-fixed-hidden-files" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> When <code>include_hidden=false</code>, the system was excluding ALL hidden files, even when they were explicitly specified in patterns like <code>/a0/.env</code>.</p>
<p><strong>Solution:</strong> Implemented explicit pattern detection that distinguishes between:
- <strong>Explicit patterns</strong> (like <code>/a0/.env</code>) - Always included regardless of <code>include_hidden</code> setting
- <strong>Wildcard discoveries</strong> (like <code>/a0/*</code>) - Respect the <code>include_hidden</code> setting</p>
<p><strong>Result:</strong> Critical files like <code>.env</code> are now properly backed up when explicitly specified, ensuring Agent Zero configurations are preserved.</p>
<h3 id="implementation-status-production-ready"><strong>Implementation Status: ✅ PRODUCTION READY</strong><a class="headerlink" href="#implementation-status-production-ready" title="Permanent link">&para;</a></h3>
<p>The backup system is now:
- <strong>Simplified</strong>: Removed unnecessary complexity and dead code
- <strong>Reliable</strong>: Fixed critical hidden file handling
- <strong>Efficient</strong>: No unnecessary checksum calculations
- <strong>Clean</strong>: Proper error handling and type safety
- <strong>Complete</strong>: Full backup and restore functionality working</p>
<p><strong>Key Benefits of Cleanup:</strong>
- ✅ <strong>Simpler maintenance</strong> - Less code to maintain and debug
- ✅ <strong>Better performance</strong> - No unnecessary checksum calculations
- ✅ <strong>Correct behavior</strong> - Hidden files now work as expected
- ✅ <strong>Cleaner API</strong> - Only endpoints that are actually used
- ✅ <strong>Better reliability</strong> - Removed complex features that weren't properly implemented</p>
<p>The Agent Zero backup system is now production-ready and battle-tested! 🚀</p>
<h2 id="final-status-ace-editor-state-guarantee-completed-december-2024">✅ <strong>FINAL STATUS: ACE EDITOR STATE GUARANTEE COMPLETED (December 2024)</strong><a class="headerlink" href="#final-status-ace-editor-state-guarantee-completed-december-2024" title="Permanent link">&para;</a></h2>
<h3 id="goal-achievement-verification"><strong>Goal Achievement Verification</strong><a class="headerlink" href="#goal-achievement-verification" title="Permanent link">&para;</a></h3>
<p>The primary goal has been successfully achieved: <strong>All metadata.json operations in GUI use the ACE editor state, not original archive metadata, giving users complete control to edit and execute exactly what's defined in the editor.</strong></p>
<h4 id="archive-metadatajson-usage-minimal-only-technical-requirements"><strong>✅ Archive metadata.json Usage</strong> (MINIMAL - only technical requirements):<a class="headerlink" href="#archive-metadatajson-usage-minimal-only-technical-requirements" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># ONLY used for:</span>
<span class="c1"># 1. Initial ACE editor preload (backup_inspect API)</span>
<span class="n">original_backup_metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">metadata_content</span><span class="p">)</span>
<span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;include_patterns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_backup_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_patterns&quot;</span><span class="p">,</span> <span class="p">[])</span>
<span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;exclude_patterns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_backup_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude_patterns&quot;</span><span class="p">,</span> <span class="p">[])</span>

<span class="c1"># 2. Path translation for cross-system compatibility</span>
<span class="n">environment_info</span> <span class="o">=</span> <span class="n">original_backup_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;environment_info&quot;</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">backed_up_agent_root</span> <span class="o">=</span> <span class="n">environment_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent_zero_root&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="ace-editor-metadata-usage-everything-else"><strong>✅ ACE editor metadata Usage</strong> (EVERYTHING ELSE):<a class="headerlink" href="#ace-editor-metadata-usage-everything-else" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Used for ALL user-controllable operations:</span>
<span class="n">backup_metadata</span> <span class="o">=</span> <span class="n">user_edited_metadata</span> <span class="k">if</span> <span class="n">user_edited_metadata</span> <span class="k">else</span> <span class="n">original_backup_metadata</span>

<span class="c1"># 1. File pattern matching for restore</span>
<span class="n">restore_include_patterns</span> <span class="o">=</span> <span class="n">backup_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_patterns&quot;</span><span class="p">,</span> <span class="p">[])</span>
<span class="n">restore_exclude_patterns</span> <span class="o">=</span> <span class="n">backup_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude_patterns&quot;</span><span class="p">,</span> <span class="p">[])</span>

<span class="c1"># 2. Clean before restore operations</span>
<span class="n">files_to_delete</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_files_to_clean_with_user_metadata</span><span class="p">(</span><span class="n">backup_metadata</span><span class="p">,</span> <span class="n">original_backup_metadata</span><span class="p">)</span>

<span class="c1"># 3. All user preferences and settings</span>
<span class="n">include_hidden</span> <span class="o">=</span> <span class="n">backup_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_hidden&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<h3 id="implementation-architecture"><strong>Implementation Architecture</strong><a class="headerlink" href="#implementation-architecture" title="Permanent link">&para;</a></h3>
<h4 id="hybrid-approach-perfect-balance"><strong>Hybrid Approach - Perfect Balance:</strong><a class="headerlink" href="#hybrid-approach-perfect-balance" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>✅ User Control</strong>: ACE editor content drives all restore operations</li>
<li><strong>✅ Technical Compatibility</strong>: Original metadata enables cross-system path translation</li>
<li><strong>✅ Complete Transparency</strong>: Users see and control exactly what will be executed</li>
<li><strong>✅ System Intelligence</strong>: Automatic path translation preserves functionality</li>
</ul>
<h4 id="api-layer-integration"><strong>API Layer Integration:</strong><a class="headerlink" href="#api-layer-integration" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Both preview and restore APIs follow same pattern:</span>
<span class="k">class</span><span class="w"> </span><span class="nc">BackupRestorePreview</span><span class="p">(</span><span class="n">ApiHandler</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Response</span><span class="p">:</span>
        <span class="c1"># Get user-edited metadata from ACE editor</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">metadata_json</span><span class="p">)</span>

        <span class="c1"># Pass user metadata to service layer</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">backup_service</span><span class="o">.</span><span class="n">preview_restore</span><span class="p">(</span>
            <span class="n">backup_file</span><span class="o">=</span><span class="n">backup_file</span><span class="p">,</span>
            <span class="n">restore_include_patterns</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_patterns&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">restore_exclude_patterns</span><span class="o">=</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude_patterns&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">user_edited_metadata</span><span class="o">=</span><span class="n">metadata</span>  <span class="c1"># ← ACE editor content</span>
        <span class="p">)</span>
</code></pre></div>
<h4 id="service-layer-implementation"><strong>Service Layer Implementation:</strong><a class="headerlink" href="#service-layer-implementation" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Service methods intelligently use both metadata sources:</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">preview_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_edited_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Read original metadata from archive</span>
    <span class="n">original_backup_metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">metadata_content</span><span class="p">)</span>

    <span class="c1"># Use ACE editor metadata for operations</span>
    <span class="n">backup_metadata</span> <span class="o">=</span> <span class="n">user_edited_metadata</span> <span class="k">if</span> <span class="n">user_edited_metadata</span> <span class="k">else</span> <span class="n">original_backup_metadata</span>

    <span class="c1"># User metadata drives pattern matching</span>
    <span class="n">files_to_restore</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_with_user_patterns</span><span class="p">(</span><span class="n">backup_metadata</span><span class="p">)</span>

    <span class="c1"># Original metadata enables path translation</span>
    <span class="n">target_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_restore_path</span><span class="p">(</span><span class="n">archive_path</span><span class="p">,</span> <span class="n">original_backup_metadata</span><span class="p">)</span>
</code></pre></div>
<h3 id="dead-code-cleanup-results"><strong>Dead Code Cleanup Results</strong><a class="headerlink" href="#dead-code-cleanup-results" title="Permanent link">&para;</a></h3>
<h4 id="removed-unused-method"><strong>✅ Removed Unused Method:</strong><a class="headerlink" href="#removed-unused-method" title="Permanent link">&para;</a></h4>
<ul>
<li><strong><code>_find_files_to_clean()</code> method</strong> (39 lines) - Replaced by <code>_find_files_to_clean_with_user_metadata()</code></li>
<li><strong>Functionality</strong>: Was using original archive metadata instead of user-edited metadata</li>
<li><strong>Replacement</strong>: New method properly uses ACE editor content for clean operations</li>
</ul>
<h4 id="method-comparison"><strong>✅ Method Comparison:</strong><a class="headerlink" href="#method-comparison" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># OLD (REMOVED): Used original archive metadata</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_find_files_to_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
    <span class="n">original_include_patterns</span> <span class="o">=</span> <span class="n">backup_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_patterns&quot;</span><span class="p">,</span> <span class="p">[])</span>  <span class="c1"># ← Archive metadata</span>
    <span class="c1"># ... 39 lines of implementation</span>

<span class="c1"># NEW (ACTIVE): Uses ACE editor metadata</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_find_files_to_clean_with_user_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">original_metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
    <span class="n">user_include_patterns</span> <span class="o">=</span> <span class="n">user_metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;include_patterns&quot;</span><span class="p">,</span> <span class="p">[])</span>  <span class="c1"># ← ACE editor metadata</span>
    <span class="c1"># Translation only uses original_metadata for environment_info</span>
</code></pre></div>
<h3 id="user-experience-flow"><strong>User Experience Flow</strong><a class="headerlink" href="#user-experience-flow" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Upload Archive</strong> → Original metadata.json extracted</li>
<li><strong>ACE Editor Preload</strong> → Original patterns shown as starting point</li>
<li><strong>User Editing</strong> → Complete freedom to modify patterns, settings</li>
<li><strong>Preview Operation</strong> → Uses current ACE editor content</li>
<li><strong>Execute Restore</strong> → Uses final ACE editor content</li>
<li><strong>Path Translation</strong> → Automatic system compatibility (transparent to user)</li>
</ol>
<h3 id="technical-benefits-achieved"><strong>Technical Benefits Achieved</strong><a class="headerlink" href="#technical-benefits-achieved" title="Permanent link">&para;</a></h3>
<h4 id="complete-user-control"><strong>✅ Complete User Control:</strong><a class="headerlink" href="#complete-user-control" title="Permanent link">&para;</a></h4>
<ul>
<li>Users can edit any pattern in the ACE editor</li>
<li>Changes immediately reflected in preview operations</li>
<li>Execute button runs exactly what's shown in editor</li>
<li>No hidden operations using different metadata</li>
</ul>
<h4 id="cross-system-compatibility"><strong>✅ Cross-System Compatibility:</strong><a class="headerlink" href="#cross-system-compatibility" title="Permanent link">&para;</a></h4>
<ul>
<li>Path translation preserves technical functionality</li>
<li>Users don't need to manually adjust paths</li>
<li>Works seamlessly between different Agent Zero installations</li>
<li>Maintains backup portability across environments</li>
</ul>
<h4 id="clean-architecture"><strong>✅ Clean Architecture:</strong><a class="headerlink" href="#clean-architecture" title="Permanent link">&para;</a></h4>
<ul>
<li>Single source of truth: ACE editor content</li>
<li>Clear separation of concerns: user control vs technical requirements</li>
<li>Eliminated dead code and simplified maintenance</li>
<li>Consistent behavior between preview and execution</li>
</ul>
<h3 id="final-status-production-ready"><strong>Final Status: ✅ PRODUCTION READY</strong><a class="headerlink" href="#final-status-production-ready" title="Permanent link">&para;</a></h3>
<p>The Agent Zero backup system now provides:
- <strong>✅ Complete user control</strong> via ACE editor state
- <strong>✅ Cross-system compatibility</strong> through intelligent path translation
- <strong>✅ Clean, maintainable code</strong> with dead code eliminated
- <strong>✅ Transparent operations</strong> with full user visibility
- <strong>✅ Production reliability</strong> with comprehensive error handling</p>
<p><strong>The backup system perfectly balances user control with technical functionality!</strong> 🎯</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">October 18, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.top", "navigation.tracking", "content.code.copy", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>