# =============================================================================
# SHARED KEYCLOAK CLUSTER
# Port Range: 49010-49019
# =============================================================================
# This is a SHARED SERVICE used by all SOMA projects:
#   - SomaAgent01 (Eye of God UI)
#   - SomaBrain (Cognitive API)
#
# Container naming: shared_keycloak_*
#
# Usage:
#   docker compose up -d
#
# Access:
#   Admin Console: http://localhost:49010
#   Default Admin: admin / admin (change in production!)
#
# Connection from other projects:
#   KEYCLOAK_URL=http://host.docker.internal:49010
#   KEYCLOAK_REALM=somabrain  (or somaagent)
# =============================================================================

services:
  # ===========================================================================
  # Keycloak (Port 49010)
  # ===========================================================================
  shared_keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: shared_keycloak
    restart: unless-stopped
    ports:
      - "49010:8080"
    environment:
      # Database
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://shared_keycloak_db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
      # Admin
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      # Config
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-localhost}
      KC_HTTP_PORT: 8080
      KC_PROXY: edge
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      # JVM for constrained environment
      JAVA_OPTS_APPEND: "-Xms256m -Xmx512m"
    command: start-dev
    depends_on:
      shared_keycloak_db:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\r

            Host: localhost\r

            \r

            ' >&3 && timeout 1 cat <&3 | grep -q '200'"
        ]
      start_period: 180s
      interval: 60s
      timeout: 10s
      retries: 3
    networks:
      - shared_network

  # ===========================================================================
  # Keycloak PostgreSQL (Port 49011)
  # ===========================================================================
  shared_keycloak_db:
    image: postgres:15-alpine
    container_name: shared_keycloak_db
    restart: unless-stopped
    ports:
      - "49011:5432"
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
      POSTGRES_DB: keycloak
    volumes:
      - shared_keycloak_postgres_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U keycloak -d keycloak" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shared_network

volumes:
  shared_keycloak_postgres_data:
    name: shared_keycloak_postgres_data

networks:
  shared_network:
    name: shared_soma_network
    driver: bridge
