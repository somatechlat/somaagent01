# Use the pre-built base image for A0
# FROM agent-zero-base:local
FROM agent0ai/agent-zero-base:latest

# Increase HTTP timeout for uv to reduce transient download failures
ENV UV_HTTP_TIMEOUT=180

# Set BRANCH to "local" if not provided
ARG BRANCH=local
ENV BRANCH=$BRANCH

# Build-time toggles for feature-based installation
# SERVICE: optional service name to include specific runtime deps (e.g. memory_service)
# K8S: optional flag for k8s-tuned builds (not changing entrypoint or compose behavior)
ARG SERVICE=""
ARG K8S=false

# Feature flags for modular installation (defaults tuned for dev reliability)
ARG FEATURE_AI=basic
ARG FEATURE_AUDIO=none
ARG FEATURE_BROWSER=true
ARG FEATURE_DOCUMENTS=true
ARG FEATURE_DATABASE=true
ARG FEATURE_MONITORING=false
ARG FEATURE_DEV=true
ARG FEATURE_GRPC=true
ARG FEATURE_INTEGRATIONS=true
ARG TORCH_VARIANT=none
ARG ENABLE_TORCH=false

# Surface feature args to shell during RUN steps
ENV FEATURE_AI=${FEATURE_AI} \
    FEATURE_AUDIO=${FEATURE_AUDIO} \
    FEATURE_BROWSER=${FEATURE_BROWSER} \
    FEATURE_DOCUMENTS=${FEATURE_DOCUMENTS} \
    FEATURE_DATABASE=${FEATURE_DATABASE} \
    FEATURE_MONITORING=${FEATURE_MONITORING} \
    FEATURE_DEV=${FEATURE_DEV} \
    FEATURE_GRPC=${FEATURE_GRPC} \
    FEATURE_INTEGRATIONS=${FEATURE_INTEGRATIONS} \
    ENABLE_TORCH=${ENABLE_TORCH} \
    TORCH_VARIANT=${TORCH_VARIANT} \
    INSTALL_PRELOAD=false

# Copy installer filesystem and the entire repo to ensure full context is available
# Installer filesystem
COPY ./docker/run/fs/ /

# Minimal agent project files only (avoid copying full repo)
# Requirements for modular installer
COPY ./requirements*.txt /git/agent-zero/

# Core application code
COPY ./run_ui.py /git/agent-zero/
COPY ./agent.py /git/agent-zero/
COPY ./models.py /git/agent-zero/
COPY ./initialize.py /git/agent-zero/
COPY ./prepare.py /git/agent-zero/
COPY ./preload.py /git/agent-zero/

# Packages and resources the agent needs
COPY ./python/ /git/agent-zero/python/
COPY ./services/ /git/agent-zero/services/
COPY ./common/ /git/agent-zero/common/
COPY ./conf/ /git/agent-zero/conf/
COPY ./lib/ /git/agent-zero/lib/
COPY ./prompts/ /git/agent-zero/prompts/
COPY ./webui/ /git/agent-zero/webui/

# Prefer Python 3.12 venv prepared in the base image for compatibility
ENV PATH="/opt/venv-a0/bin:${PATH}"

# Pre-install, modular install, and post-install using the canonical installer
RUN bash /ins/pre_install.sh $BRANCH
RUN bash /ins/install.sh $BRANCH
RUN bash /ins/post_install.sh $BRANCH

# Expose ports
EXPOSE 22 80 9000-9009 20017

RUN chmod +x /exe/initialize.sh /exe/run_A0.sh /exe/run_searxng.sh /exe/run_tunnel_api.sh

# initialize runtime and switch to supervisord
CMD ["/exe/initialize.sh", "$BRANCH"]
