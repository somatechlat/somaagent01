# Use the pre-built base image for A0
# FROM agent-zero-base:local
FROM agent0ai/agent-zero-base:latest

# Increase HTTP timeout for uv to reduce transient download failures
ENV UV_HTTP_TIMEOUT=180

# Set BRANCH to "local" if not provided
ARG BRANCH=local
ENV BRANCH=$BRANCH

# Copy filesystem files to root
COPY ./docker/run/fs/ /
# Copy current development files to git, they will only be used in "local" branch
# COPY ./ /git/agent-zero
# COPY ./ /git/agent-zero  # Disabled to prevent clone conflict during image build

# pre installation steps
RUN bash /ins/pre_install.sh $BRANCH

# install A0
RUN bash /ins/install_A0.sh $BRANCH

# install additional software
RUN bash /ins/install_additional.sh $BRANCH

# cleanup repo and install A0 without caching, this speeds up builds
ARG CACHE_DATE=none
RUN echo "cache buster $CACHE_DATE" && bash /ins/install_A02.sh $BRANCH

# post installation steps
RUN bash /ins/post_install.sh $BRANCH

# Install pip and uvicorn using system python, with break-system-packages to bypass external environment restrictions
RUN apt-get update && apt-get install -y python3-pip && \
    python3 -m pip install --break-system-packages "uvicorn[standard]" && \
    python3 -m pip install --break-system-packages "fastapi[all]" && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Playwright and its browsers for UI testing
RUN python3 -m pip install --break-system-packages playwright && \
    python3 -m playwright install chromium && \
    python3 -m playwright install firefox && \
    python3 -m playwright install webkit

# Install aiokafka for Kafka event bus
RUN python3 -m pip install --break-system-packages aiokafka

# Install asyncpg for async PostgreSQL access
RUN python3 -m pip install --break-system-packages asyncpg

# Install latest redis (asyncio support)
RUN python3 -m pip install --break-system-packages "redis>=5.0"

# Install jsonschema for event validation
RUN python3 -m pip install --break-system-packages jsonschema

# Install Prometheus client library for metrics exposition
RUN python3 -m pip install --break-system-packages prometheus-client

# Expose ports
EXPOSE 22 80 9000-9009

RUN chmod +x /exe/initialize.sh /exe/run_A0.sh /exe/run_searxng.sh /exe/run_tunnel_api.sh

# initialize runtime and switch to supervisord
CMD ["/exe/initialize.sh", "$BRANCH"]
