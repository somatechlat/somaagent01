# SomaAgent01 Docker Compose Configuration
# Per SomaStack Infrastructure Spec
#
# VIBE COMPLIANT:
# - Real services (no mocks)
# - Production-grade configuration
# - Resource limits for 15GB total
#
# Profiles:
#   - infra: Core infrastructure (PostgreSQL, Redis, Kafka)
#   - soma: SomaAgent services
#   - observability: Prometheus, Grafana
#   - security: SpiceDB, OPA

version: "3.9"

x-common-labels: &common-labels
  com.somastack.project: "somaagent01"
  com.somastack.environment: "${ENVIRONMENT:-development}"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s

services:
  # ==========================================================================
  # DATABASE: PostgreSQL with WAL for CDC
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: somastack-postgres
    profiles: [ "infra", "core" ]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-somastack2024}
      POSTGRES_DB: ${POSTGRES_DB:-somaagent}
      POSTGRES_MULTIPLE_DATABASES: somabrain,somamemory
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-15432}:5432"
    command: >
      postgres -c wal_level=logical -c max_wal_senders=5 -c max_replication_slots=5 -c shared_buffers=256MB -c work_mem=16MB -c maintenance_work_mem=128MB
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"
    labels:
      <<: *common-labels
      com.somastack.service: "postgres"

  # ==========================================================================
  # CACHE: Redis with AOF persistence
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: somastack-redis
    profiles: [ "infra", "core" ]
    command: >
      redis-server --appendonly yes --appendfsync everysec --maxmemory 512mb --maxmemory-policy allkeys-lru --save 60 1000 --save 300 10
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "redis-cli", "ping" ]
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    labels:
      <<: *common-labels
      com.somastack.service: "redis"

  # ==========================================================================
  # MESSAGE BROKER: Kafka with KRaft (no ZooKeeper)
  # ==========================================================================
  kafka:
    image: apache/kafka:3.7.0
    container_name: somastack-kafka
    profiles: [ "infra", "core" ]
    environment:
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CFG_LOG_RETENTION_HOURS: 168 # 7 days
      KAFKA_CFG_LOG_RETENTION_BYTES: 10737418240 # 10GB
      KAFKA_CFG_ENABLE_IDEMPOTENCE: "true"
      KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_KRAFT_CLUSTER_ID: ${KAFKA_CLUSTER_ID:-soma-kraft-cluster}
    volumes:
      - kafka_data:/bitnami/kafka
    ports:
      - "${KAFKA_PORT:-9092}:9092"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:9092" ]
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: "1"
    labels:
      <<: *common-labels
      com.somastack.service: "kafka"

  # ==========================================================================
  # VECTOR DB: Milvus for embeddings
  # ==========================================================================
  etcd:
    image: quay.io/coreos/etcd:v3.5.11
    container_name: somastack-etcd
    profiles: [ "infra", "vectors" ]
    environment:
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
    command: >
      etcd --advertise-client-urls=http://127.0.0.1:2379 --listen-client-urls=http://0.0.0.0:2379 --data-dir=/etcd
    volumes:
      - etcd_data:/etcd
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "etcdctl", "endpoint", "health" ]
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
    labels:
      <<: *common-labels
      com.somastack.service: "etcd"

  minio:
    image: minio/minio:latest
    container_name: somastack-minio
    profiles: [ "infra", "vectors" ]
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    command: server /data --console-address ":9001"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    labels:
      <<: *common-labels
      com.somastack.service: "minio"

  milvus:
    image: milvusdb/milvus:v2.3.4
    container_name: somastack-milvus
    profiles: [ "infra", "vectors" ]
    depends_on:
      - etcd
      - minio
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_PASSWORD:-minioadmin}
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "${MILVUS_PORT:-19530}:19530"
      - "${MILVUS_GRPC_PORT:-9091}:9091"
    command: [ "milvus", "run", "standalone" ]
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "curl", "-f", "http://localhost:9091/healthz" ]
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "1"
    labels:
      <<: *common-labels
      com.somastack.service: "milvus"

  # ==========================================================================
  # AUTHORIZATION: SpiceDB
  # ==========================================================================
  spicedb:
    image: authzed/spicedb:latest
    container_name: somastack-spicedb
    profiles: [ "security" ]
    depends_on:
      - postgres
    environment:
      SPICEDB_DATASTORE_ENGINE: postgres
      SPICEDB_DATASTORE_CONN_URI: postgres://postgres:somastack2024@postgres:5432/somaagent?sslmode=disable
      SPICEDB_GRPC_PRESHARED_KEY: ${SPICEDB_TOKEN:-somastack-spicedb-token}
      SPICEDB_HTTP_ENABLED: "true"
    ports:
      - "${SPICEDB_GRPC_PORT:-50051}:50051"
      - "${SPICEDB_HTTP_PORT:-8443}:8443"
    command: serve
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "curl", "-f", "http://localhost:8443/health" ]
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
    labels:
      <<: *common-labels
      com.somastack.service: "spicedb"

  # ==========================================================================
  # POLICY ENGINE: OPA
  # ==========================================================================
  opa:
    image: openpolicyagent/opa:0.60.0-rootless
    container_name: somastack-opa
    profiles: [ "security" ]
    volumes:
      - ./policy:/policy:ro
    ports:
      - "${OPA_PORT:-8181}:8181"
    command: >
      run --server --addr=:8181 --log-level=info /policy
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8181/health" ]
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
    labels:
      <<: *common-labels
      com.somastack.service: "opa"

  # ==========================================================================
  # OBSERVABILITY: Prometheus
  # ==========================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: somastack-prometheus
    profiles: [ "observability" ]
    volumes:
      - ./infrastructure/prometheus:/etc/prometheus:ro
      - prometheus_data:/prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
      - "--web.enable-lifecycle"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy" ]
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    labels:
      <<: *common-labels
      com.somastack.service: "prometheus"

  # ==========================================================================
  # OBSERVABILITY: Grafana
  # ==========================================================================
  grafana:
    image: grafana/grafana:10.2.2
    container_name: somastack-grafana
    profiles: [ "observability" ]
    depends_on:
      - prometheus
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-somastack}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./infrastructure/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD-SHELL", "wget --spider -q http://localhost:3000/api/health" ]
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
    labels:
      <<: *common-labels
      com.somastack.service: "grafana"

# ==========================================================================
# VOLUMES
# ==========================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  kafka_data:
    driver: local
  etcd_data:
    driver: local
  minio_data:
    driver: local
  milvus_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# ==========================================================================
# NETWORKS
# ==========================================================================
networks:
  default:
    name: somastack-network
    driver: bridge
