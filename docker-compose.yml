# SomaAgent01 Docker Compose Configuration
# Per Eye of God UIX Design Section 1.1
#
# VIBE COMPLIANT:
# - Real services only (no mocks/stubs)
# - Production-grade configuration
# - Unique port namespace (20xxx) to avoid conflicts
# - Per design.md: Django Ninja on 8020, parallel with FastAPI 8010
#
# Usage:
#   docker compose up -d                    # All services
#   docker compose --profile core up -d     # Core only
#   docker compose --profile vectors up -d  # Vector DB

x-common-labels: &common-labels
  com.somastack.project: "somaagent01"
  com.somastack.environment: "${ENVIRONMENT:-development}"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s

services:
  # ==========================================================================
  # DATABASE: PostgreSQL 16 (Port 20432 - unique namespace)
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: somaagent-postgres
    profiles: [ "core", "auth" ]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-somastack2024}
      POSTGRES_DB: ${POSTGRES_DB:-somaagent}
    volumes:
      - somaagent_postgres_data:/var/lib/postgresql/data
      - ./infrastructure/postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "20432:5432"
    command: >
      postgres -c wal_level=logical -c max_wal_senders=5 -c shared_buffers=256MB
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
    deploy:
      resources:
        limits:
          memory: 1G
    labels:
      <<: *common-labels
      com.somastack.service: "postgres"

  # ==========================================================================
  # CACHE: Redis 7 (Port 20379 - unique namespace)
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: somaagent-redis
    profiles: [ "core" ]
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - somaagent_redis_data:/data
    ports:
      - "20379:6379"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "redis-cli", "ping" ]
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      <<: *common-labels
      com.somastack.service: "redis"

  # ==========================================================================
  # MESSAGE BROKER: Kafka with KRaft (Port 20092 - unique namespace)
  # ==========================================================================
  kafka:
    image: apache/kafka:3.7.0
    container_name: somaagent-kafka
    profiles: [ "core" ]
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      CLUSTER_ID: somaagent-kraft-cluster
      # JVM heap settings for stability
      KAFKA_HEAP_OPTS: "-Xmx768m -Xms512m"
    volumes:
      - somaagent_kafka_data:/var/lib/kafka/data
    ports:
      - "20092:9092"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD-SHELL", "nc -z localhost 9092 || exit 1" ]
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    labels:
      <<: *common-labels
      com.somastack.service: "kafka"

  # ==========================================================================
  # VECTOR DB: Milvus (Ports 20530, 20091 - unique namespace)
  # ==========================================================================
  etcd:
    image: quay.io/coreos/etcd:v3.5.11
    container_name: somaagent-etcd
    profiles: [ "vectors" ]
    environment:
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
    command: etcd --advertise-client-urls=http://127.0.0.1:2379 --listen-client-urls=http://0.0.0.0:2379 --data-dir=/etcd
    volumes:
      - somaagent_etcd_data:/etcd
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "etcdctl", "endpoint", "health" ]
    deploy:
      resources:
        limits:
          memory: 256M
    labels:
      <<: *common-labels
      com.somastack.service: "etcd"

  minio:
    image: minio/minio:latest
    container_name: somaagent-minio
    profiles: [ "vectors" ]
    environment:
      MINIO_ROOT_USER: ${MINIO_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD:-minioadmin}
    volumes:
      - somaagent_minio_data:/data
    ports:
      - "20900:9000"
      - "20901:9001"
    command: server /data --console-address ":9001"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      <<: *common-labels
      com.somastack.service: "minio"

  milvus:
    image: milvusdb/milvus:v2.3.4
    container_name: somaagent-milvus
    profiles: [ "vectors" ]
    depends_on:
      - etcd
      - minio
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_PASSWORD:-minioadmin}
    volumes:
      - somaagent_milvus_data:/var/lib/milvus
    ports:
      - "20530:19530"
      - "20091:9091"
    command: [ "milvus", "run", "standalone" ]
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "curl", "-f", "http://localhost:9091/healthz" ]
    deploy:
      resources:
        limits:
          memory: 2G
    labels:
      <<: *common-labels
      com.somastack.service: "milvus"

  # ==========================================================================
  # AUTHORIZATION: SpiceDB (Ports 20051, 20443 - unique namespace)
  # ==========================================================================
  spicedb:
    image: authzed/spicedb:latest
    container_name: somaagent-spicedb
    profiles: [ "security" ]
    depends_on:
      - postgres
    environment:
      SPICEDB_DATASTORE_ENGINE: postgres
      SPICEDB_DATASTORE_CONN_URI: postgres://postgres:somastack2024@postgres:5432/somaagent?sslmode=disable
      SPICEDB_GRPC_PRESHARED_KEY: ${SPICEDB_TOKEN:-somaagent-spicedb-token}
      SPICEDB_HTTP_ENABLED: "true"
    ports:
      - "20051:50051"
      - "20443:8443"
    command: serve
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "curl", "-f", "http://localhost:8443/health" ]
    deploy:
      resources:
        limits:
          memory: 256M
    labels:
      <<: *common-labels
      com.somastack.service: "spicedb"

  # ==========================================================================
  # POLICY ENGINE: OPA (Port 20181 - unique namespace)
  # ==========================================================================
  opa:
    image: openpolicyagent/opa:0.60.0-rootless
    container_name: somaagent-opa
    profiles: [ "security" ]
    volumes:
      - ./policy:/policy:ro
    ports:
      - "20181:8181"
    command: run --server --addr=:8181 --log-level=info /policy
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:8181/health" ]
    deploy:
      resources:
        limits:
          memory: 256M
    labels:
      <<: *common-labels
      com.somastack.service: "opa"

  # ==========================================================================
  # OBSERVABILITY: Prometheus (Port 20090 - unique namespace)
  # ==========================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: somaagent-prometheus
    profiles: [ "observability" ]
    volumes:
      - ./infrastructure/prometheus:/etc/prometheus:ro
      - somaagent_prometheus_data:/prometheus
    ports:
      - "20090:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy" ]
    deploy:
      resources:
        limits:
          memory: 512M
    labels:
      <<: *common-labels
      com.somastack.service: "prometheus"

  # ==========================================================================
  # OBSERVABILITY: Grafana (Port 20300 - unique namespace)
  # ==========================================================================
  grafana:
    image: grafana/grafana:10.2.2
    container_name: somaagent-grafana
    profiles: [ "observability" ]
    depends_on:
      - prometheus
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-somastack}
    volumes:
      - somaagent_grafana_data:/var/lib/grafana
      - ./infrastructure/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "20300:3000"
    healthcheck:
      <<: *common-healthcheck
      test: [ "CMD-SHELL", "wget --spider -q http://localhost:3000/api/health" ]
    deploy:
      resources:
        limits:
          memory: 256M
    labels:
      <<: *common-labels
      com.somastack.service: "grafana"

  # ==========================================================================
  # IDENTITY: Keycloak 24 (Port 20880 - unique namespace)
  # Enterprise SSO with OIDC/SAML support
  # ==========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: somaagent-keycloak
    profiles: [ "auth" ]
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: ${POSTGRES_USER:-postgres}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-somastack2024}
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-localhost}
      KC_HTTP_PORT: 8080
      KC_PROXY: edge
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin123}
    command: start-dev
    ports:
      - "20880:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      <<: *common-healthcheck
      test:
        [
          "CMD-SHELL",
          "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\r

            Host: localhost\r

            \r

            ' >&3 && cat <&3 | grep -q '200'"
        ]
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 1G
    labels:
      <<: *common-labels
      com.somastack.service: "keycloak"

# ==========================================================================
# VOLUMES - Namespaced to somaagent_
# ==========================================================================
volumes:
  somaagent_postgres_data:
  somaagent_redis_data:
  somaagent_kafka_data:
  somaagent_etcd_data:
  somaagent_minio_data:
  somaagent_milvus_data:
  somaagent_prometheus_data:
  somaagent_grafana_data:

    # ==========================================================================
    # NETWORKS
    # ==========================================================================
networks:
  default:
    name: somaagent-network
    driver: bridge
