# =============================================================================
# SOMA MONOLITH AGENT - Unified Container
# =============================================================================
# This Dockerfile builds a single container containing:
# - somaAgent01 (User-facing agent, orchestration)
# - somabrain (Cognitive core, Rust, quantum layer)
# - somafractalmemory (Memory persistence, vector store)
#
# All inter-service communication is IN-PROCESS (no network overhead).
# External services (Milvus, Redis, Postgres) remain as separate containers.
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: Rust Builder (for somabrain_rs)
# -----------------------------------------------------------------------------
FROM rust:1.75-slim-bookworm AS rust-builder

RUN apt-get update && apt-get install -y \
    python3-dev \
    libffi-dev \
    libssl-dev \
    pkg-config \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install maturin for building Python-Rust bindings
RUN pip3 install maturin

WORKDIR /build

# Copy somabrain Rust core source
COPY somabrain/rust_core/ /build/rust_core/

WORKDIR /build/rust_core

# Build the Rust wheel
RUN maturin build --release --strip --out /build/wheels

# -----------------------------------------------------------------------------
# Stage 2: Python Dependencies Builder
# -----------------------------------------------------------------------------
FROM python:3.12-slim-bookworm AS python-builder

RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy and install all requirements
COPY somaAgent01/requirements.txt /build/requirements-agent.txt
COPY somabrain/requirements.txt /build/requirements-brain.txt
COPY somafractalmemory/requirements.txt /build/requirements-memory.txt

# Create unified requirements
RUN cat requirements-agent.txt requirements-brain.txt requirements-memory.txt | \
    sort | uniq > requirements-unified.txt

# Install all dependencies
RUN pip install --no-cache-dir --prefix=/install \
    -r requirements-unified.txt

# Copy Rust wheel from builder and install
COPY --from=rust-builder /build/wheels/*.whl /build/wheels/
RUN pip install --no-cache-dir --prefix=/install /build/wheels/*.whl

# -----------------------------------------------------------------------------
# Stage 3: Final Runtime Image
# -----------------------------------------------------------------------------
FROM python:3.12-slim-bookworm AS runtime

# Runtime dependencies
RUN apt-get update && apt-get install -y \
    libpq5 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy installed Python packages
COPY --from=python-builder /install /usr/local

WORKDIR /app

# =============================================================================
# Copy all 3 projects as packages
# =============================================================================

# somaAgent01 - Primary application
COPY somaAgent01/admin/ /app/admin/
COPY somaAgent01/services/ /app/services/
COPY somaAgent01/prompts/ /app/prompts/
COPY somaAgent01/webui/ /app/webui/
COPY somaAgent01/manage.py /app/manage.py
COPY somaAgent01/sitecustomize.py /app/sitecustomize.py

# somabrain - Cognitive core
COPY somabrain/somabrain/ /app/somabrain/

# somafractalmemory - Memory system
COPY somafractalmemory/app/ /app/fractal_memory/
COPY somafractalmemory/sfm_api/ /app/sfm_api/

# =============================================================================
# Monolith bridge package (direct imports instead of HTTP)
# =============================================================================
COPY somaAgent01/soma_monolith/ /app/soma_monolith/

# Environment configuration
ENV PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    DJANGO_SETTINGS_MODULE=admin.settings \
    # Monolith mode: disable external HTTP calls to brain/memory
    SOMA_MONOLITH_MODE=true \
    # Default ports for external services
    MILVUS_HOST=milvus \
    MILVUS_PORT=19530 \
    REDIS_HOST=redis \
    REDIS_PORT=6379 \
    POSTGRES_HOST=postgres \
    POSTGRES_PORT=5432

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:9000/health || exit 1

# Expose single port
EXPOSE 9000

# Default command: Run the unified agent
CMD ["python", "-m", "admin.run_gateway"]
