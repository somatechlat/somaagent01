# SomaAgent01 Session State Contract

The messaging gateway, conversation worker, and downstream tools now share a
canonical session envelope that keeps persona metadata, tenancy context, and
budget state aligned across Redis and Postgres. This document records the schema
alongside the migration plan for Track B (Memory & State Unification).

## Envelope Structure

Sessions are serialized as JSON documents with the following top-level fields:

| Field | Type | Description |
| --- | --- | --- |
| `session_id` | `string` (UUID) | Primary identifier provided by the gateway. |
| `persona_id` | `string` | Persona currently guiding the conversation. Empty when unset. |
| `tenant` | `string` | Tenant/organization identifier derived from authentication. |
| `subject` | `string` | Authenticated user subject (JWT `sub`). Optional. |
| `issuer` | `string` | Token issuer for audit trails. Optional. |
| `scope` | `string` | Scopes granted to the caller. Optional. |
| `metadata` | `object` | Arbitrary key/value pairs from clients (non-overlapping with reserved keys). |
| `analysis` | `object` | Enriched metadata injected by the conversation worker (intent, sentiment, tags). |
| `timestamps` | `object` | Contains `created_at` and `updated_at` ISO-8601 timestamps. |

### JSON Schema excerpt

```json
{
  "type": "object",
  "required": ["session_id", "metadata", "timestamps"],
  "properties": {
    "session_id": {"type": "string", "format": "uuid"},
    "persona_id": {"type": "string"},
    "tenant": {"type": "string"},
    "subject": {"type": "string"},
    "issuer": {"type": "string"},
    "scope": {"type": "string"},
    "metadata": {"type": "object", "additionalProperties": true},
    "analysis": {
      "type": "object",
      "properties": {
        "intent": {"type": "string"},
        "sentiment": {"type": "string"},
        "tags": {"type": "array", "items": {"type": "string"}}
      }
    },
    "timestamps": {
      "type": "object",
      "properties": {
        "created_at": {"type": "string", "format": "date-time"},
        "updated_at": {"type": "string", "format": "date-time"}
      }
    }
  }
}
```

## Storage Layout

### Redis (Ephemeral cache)

- **Key format:** `session:{session_id}:meta`
- **TTL:** 15 minutes (configurable via `SESSION_CACHE_TTL_SECONDS`).
- **Value:** JSON blob matching the envelope above, stored as UTF-8.
- **Purpose:** Fast rehydration of session metadata for the gateway and tooling
  without hitting Postgres on every request.

### Postgres (Authoritative store)

```
create table if not exists session_envelopes (
    session_id uuid primary key,
    persona_id text,
    tenant text,
    subject text,
    issuer text,
    scope text,
    metadata jsonb not null default '{}'::jsonb,
    analysis jsonb not null default '{}'::jsonb,
    created_at timestamptz not null default now(),
    updated_at timestamptz not null default now()
);
```

- `metadata` stores client-provided context plus gateway auth metadata.
- `analysis` mirrors the latest enrichment generated by the conversation worker.
- Triggers keep `updated_at` current on writes (`updated_at = now()`).

## Migration Plan (Track B Entry Criteria)

1. **Snapshot existing data**
   - Export current Redis cache for active sessions.
   - Dump the legacy Postgres `session_events` tail required to rebuild metadata.

2. **Canonical backfill**
   - Run the `scripts/session_backfill.py` (to be implemented) which:
     - reads the most recent `user`/`assistant` events per session,
     - assembles the envelope using the schema above,
     - persists to `session_envelopes` and warms the Redis cache.

3. **Schema enforcement**
   - Update `services/common/session_repository.py` so `append_event` and
     `list_events` hydrate envelopes via the new table.
   - Add JSON Schema validation in CI (`pytest services/common/tests/test_session_schema.py`).

4. **Cut-over**
   - Flag `SESSION_ENVELOPE_ENABLED=true` (defaults to true after migration).
   - Remove legacy code paths that inferred persona metadata from event streams.

5. **Validation**
   - Run automated regression covering:
     - New conversation start → persona switch → quick action replay.
     - Tool executor persona echo during tool requests.
     - Redis eviction behaviour (simulate TTL expiry, ensure Postgres refresh works).
   - Prometheus metrics report `session_envelope_refresh_total` counter increases
     only on cache misses.

## Next Steps

- Implement the backfill script and automated tests described above.
- Expose envelope validation metrics from the session repository to Prometheus.
- Document rollback procedure (clear Redis keys + drop new rows) in the sprint
  runbook once migration tooling lands.
