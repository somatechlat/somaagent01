# V3 FLOW MASTER TASK TRACKER â€” COMPLETE IMPLEMENTATION PLAN

**Project:** SomaAgent01 V3 Flow
**Last Updated:** 2026-01-16 20:51
**Status:** 81% COMPLETE (13/16 SRS)

---

## ğŸ“Š COMPLETE 12-PHASE FLOW STATUS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        12-PHASE AGENTIC TURN PIPELINE                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ P1  â”‚â”€â”€â”€â–¶â”‚ P2  â”‚â”€â”€â”€â–¶â”‚ P3  â”‚â”€â”€â”€â–¶â”‚ P4  â”‚â”€â”€â”€â–¶â”‚ P5  â”‚â”€â”€â”€â–¶â”‚ P6  â”‚           â”‚
â”‚  â”‚AUTH â”‚    â”‚BUDG â”‚    â”‚CAPS â”‚    â”‚DERV â”‚    â”‚CTXT â”‚    â”‚MEM  â”‚           â”‚
â”‚  â”‚ âœ…  â”‚    â”‚ â³  â”‚    â”‚ âœ…  â”‚    â”‚ âœ…  â”‚    â”‚ âœ…  â”‚    â”‚ âœ…  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ P7  â”‚â”€â”€â”€â–¶â”‚ P8  â”‚â”€â”€â”€â–¶â”‚ P9  â”‚â”€â”€â”€â–¶â”‚ P10 â”‚â”€â”€â”€â–¶â”‚ P11 â”‚â”€â”€â”€â–¶â”‚ P12 â”‚           â”‚
â”‚  â”‚ LLM â”‚    â”‚ RLM â”‚    â”‚TOOL â”‚    â”‚SAVE â”‚    â”‚LERN â”‚    â”‚OBSV â”‚           â”‚
â”‚  â”‚ âœ…  â”‚    â”‚ âœ…  â”‚    â”‚ âœ…  â”‚    â”‚ âœ…  â”‚    â”‚ âœ…  â”‚    â”‚ âœ…  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                             â”‚
â”‚  Legend: âœ… IMPLEMENTED   â³ IN PROGRESS   ğŸ”´ TODO                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ SRS â†’ IMPLEMENTATION MATRIX

| # | SRS Document | Sprint | Implementation File | Lines | Status |
|---|--------------|--------|---------------------|-------|--------|
| 1 | SRS-DATA-MODELS | 1 | `admin/*/models.py` (50+ models) | 3,500+ | âœ… DONE |
| 2 | SRS-CAPSULE-PORTABILITY | 1 | `admin/core/models.py:Capsule` | 250 | âœ… DONE |
| 3 | SRS-SECURITY-MULTITENANCY | 2 | SpiceDB + Vault + Keycloak | - | âœ… DONE |
| 4 | SRS-AGENTIQ | 4 | `admin/core/agentiq/` | 542 | âœ… DONE |
| 5 | SRS-PERMISSION-MATRIX | 5 | `admin/core/permission_matrix.py` | 270 | âœ… DONE |
| 6 | SRS-TOOL-SYSTEM | 6 | `admin/core/tool_system.py` | 280 | âœ… DONE |
| 7 | SRS-CONTEXT-BUILDING | 7 | `admin/core/context/` | 425 | âœ… DONE |
| 8 | SRS-MODEL-ROUTING | 8 | `admin/core/model_router.py` | 220 | âœ… DONE |
| 9 | SRS-MULTIMODAL | 8 | `admin/core/multimodal.py` | 230 | âœ… DONE |
| 10 | SRS-RLM-ENGINE | 9 | `admin/agents/services/rlm_engine.py` | 240 | âœ… DONE |
| 11 | SRS-CHAT-FLOW-MASTER | 9 | `admin/core/chat_orchestrator.py` | 215 | âœ… DONE |
| 12 | SRS-LAGO-BILLING | 9 | `admin/core/billing.py` | 220 | âœ… DONE |
| 13 | SRS-SOMABRAIN-INTEGRATION | 3 | `admin/somabrain/` | 400+ | âœ… DONE |
| 14 | **SRS-BUDGET-SYSTEM** | 10 | `admin/core/budget/` | 950 | âœ… DONE |
| 15 | **SRS-FEATURE-FLAGS** | 11 | `admin/core/features/` | 1300 | âœ… DONE |
| 16 | **SRS-BACKUP-SYSTEM** | 12 | `services/capsule_export.py` | 445 | âœ… DONE |

---

## ğŸ¯ SPRINT 10: BUDGET SYSTEM

### Files to Create

| File | Purpose | Est. Lines |
|------|---------|------------|
| `admin/core/budget/__init__.py` | Package exports | 30 |
| `admin/core/budget/registry.py` | Metric definitions | 100 |
| `admin/core/budget/gate.py` | @budget_gate decorator | 80 |
| `admin/core/budget/limits.py` | Plan limits | 60 |
| `admin/core/budget/cache.py` | Redis cache | 50 |
| `admin/core/budget/exceptions.py` | BudgetExhaustedError | 40 |
| `admin/core/budget/lago.py` | Lago event publishing | 70 |

### Tasks

- [ ] **TASK 10.1**: Create `METRIC_REGISTRY` with 10 metrics
  ```python
  tokens, tool_calls, images, voice_minutes, api_calls,
  memory_tokens, vector_ops, learning, storage_gb, sessions
  ```

- [ ] **TASK 10.2**: Implement `@budget_gate(metric="tokens")` decorator
  - Check cache `budget:{tenant_id}:{metric}`
  - Compare against plan limit
  - Raise `BudgetExhaustedError(402)` if exceeded
  - Async emit Lago event after success

- [ ] **TASK 10.3**: Integrate with chat_orchestrator.py Phase 2
  ```python
  @budget_gate(metric="tokens")
  async def process_chat(request, capsule):
      ...
  ```

- [ ] **TASK 10.4**: Integrate with tool_system.py
  ```python
  @budget_gate(metric="tool_calls")
  async def execute_tool(request, tool_name, args):
      ...
  ```

- [ ] **TASK 10.5**: Integrate with multimodal.py
  ```python
  @budget_gate(metric="images")
  async def generate_image(request, prompt, capsule):
      ...
  ```

---

## ğŸ¯ SPRINT 11: FEATURE FLAGS

### Files to Create

| File | Purpose | Est. Lines |
|------|---------|------------|
| `admin/core/features/__init__.py` | Package exports | 25 |
| `admin/core/features/registry.py` | Feature definitions | 150 |
| `admin/core/features/check.py` | is_feature_enabled() | 80 |
| `admin/core/features/gate.py` | @require_feature decorator | 60 |
| `admin/api/features.py` | API endpoints | 100 |

### Tasks

- [ ] **TASK 11.1**: Create `FEATURE_REGISTRY` with tiers
  ```
  TIER 1 (CORE - Always ON): chat, auth, capsule, agentiq, permissions
  TIER 2 (OPTIONAL - Toggleable): images, vision, voice, learning, mcp
  ```

- [ ] **TASK 11.2**: Implement `is_feature_enabled(tenant_id, feature)`
  - Check plan requirement
  - Check dependencies
  - Check credentials
  - Check tenant toggle

- [ ] **TASK 11.3**: Implement `@require_feature("images")` decorator
  ```python
  @require_feature("images")
  @budget_gate(metric="images")
  async def generate_image(request, prompt, capsule):
      ...
  ```

- [ ] **TASK 11.4**: Create API endpoints
  - `GET /features` - List all with status
  - `POST /features/{feature}` - Toggle
  - `POST /features/{feature}/credentials` - Set credentials

- [ ] **TASK 11.5**: Create Agent Settings UI mockups

---

## ğŸ¯ SPRINT 12: FULL PERMISSIONS (88)

### Tasks

- [ ] **TASK 12.1**: Complete SpiceDB schema with all 88 permissions
  ```zed
  definition platform {}
  definition tenant {
      permission manage = sysadmin
      permission administrate = sysadmin + admin
      ...
  }
  ```

- [ ] **TASK 12.2**: Update permission_matrix.py with full matrix

- [ ] **TASK 12.3**: Create OPA policies for all levels
  - Level 0: Platform
  - Level 1: Tenant
  - Level 2: Agent
  - Level 3: Resource
  - Level 4: Emergency

- [ ] **TASK 12.4**: Integration tests for all 88 permissions

---

## ğŸ¯ SPRINT 13: MULTIMODAL ROUTING INTEGRATION

### Tasks

- [ ] **TASK 13.1**: Create `admin/multimodal/routing.py`
  ```python
  async def select_multimodal_model(
      capability: str,
      capsule: Capsule,
  ) -> LLMModelConfig
  ```

- [ ] **TASK 13.2**: Update execution.py with tenant isolation

- [ ] **TASK 13.3**: Add @budget_gate + @require_feature to all endpoints

- [ ] **TASK 13.4**: Integration tests for multimodal flow

---

## ğŸ“ COMPLETE FILE INVENTORY

### âœ… IMPLEMENTED FILES (16 files, ~2,642 lines)

| File | SRS | Lines | Tests |
|------|-----|-------|-------|
| `admin/core/agentiq/__init__.py` | AGENTIQ | 27 | âœ… |
| `admin/core/agentiq/settings.py` | AGENTIQ | 75 | âœ… |
| `admin/core/agentiq/tables.py` | AGENTIQ | 165 | âœ… |
| `admin/core/agentiq/derivation.py` | AGENTIQ | 105 | âœ… |
| `admin/core/agentiq/unified_gate.py` | AGENTIQ | 170 | âœ… |
| `admin/core/context/__init__.py` | CONTEXT | 27 | âœ… |
| `admin/core/context/models.py` | CONTEXT | 68 | âœ… |
| `admin/core/context/lanes.py` | CONTEXT | 120 | âœ… |
| `admin/core/context/builder.py` | CONTEXT | 210 | âœ… |
| `admin/core/model_router.py` | MODEL-ROUTING | 220 | âœ… |
| `admin/core/tool_system.py` | TOOL-SYSTEM | 280 | âœ… |
| `admin/core/permission_matrix.py` | PERMISSION | 270 | âœ… |
| `admin/core/chat_orchestrator.py` | CHAT-FLOW | 215 | âœ… |
| `admin/agents/services/rlm_engine.py` | RLM-ENGINE | 240 | âœ… |
| `admin/core/multimodal.py` | MULTIMODAL | 230 | âœ… |
| `admin/core/billing.py` | LAGO-BILLING | 220 | âœ… |

### ğŸ”´ FILES TO CREATE (12 files, ~900 lines)

| File | SRS | Est. Lines |
|------|-----|------------|
| `admin/core/budget/__init__.py` | BUDGET | 30 |
| `admin/core/budget/registry.py` | BUDGET | 100 |
| `admin/core/budget/gate.py` | BUDGET | 80 |
| `admin/core/budget/limits.py` | BUDGET | 60 |
| `admin/core/budget/cache.py` | BUDGET | 50 |
| `admin/core/budget/exceptions.py` | BUDGET | 40 |
| `admin/core/budget/lago.py` | BUDGET | 70 |
| `admin/core/features/__init__.py` | FEATURES | 25 |
| `admin/core/features/registry.py` | FEATURES | 150 |
| `admin/core/features/check.py` | FEATURES | 80 |
| `admin/core/features/gate.py` | FEATURES | 60 |
| `admin/api/features.py` | FEATURES | 100 |

---

## ğŸ“Š METRICS

| Metric | Value |
|--------|-------|
| **SRS Documents** | 17 |
| **SRS Implemented** | 13/16 (81%) |
| **Files Created** | 16 |
| **Lines Implemented** | ~2,642 |
| **Files Remaining** | 12 |
| **Lines Remaining** | ~900 |
| **Total Estimated** | ~3,542 |

---

## ğŸ”„ INTEGRATION TEST CHECKLIST

### Phase 1-4: Ingress
- [ ] JWT authentication
- [ ] Budget gate enforcement
- [ ] Capsule load by tenant
- [ ] Knob derivation

### Phase 5-8: Process
- [ ] Context building with lanes
- [ ] Memory recall from SomaBrain
- [ ] LLM invoke with fallback
- [ ] RLM execution

### Phase 9-12: Execute
- [ ] Tool execution with 4-phase gate
- [ ] Multimodal routing
- [ ] Memorize to Brain
- [ ] Learn updates to capsule.body.learned
- [ ] Audit trail (AuditLog)

---

## âœ… ACCEPTANCE CRITERIA

| Criterion | Status |
|-----------|--------|
| 12-phase flow complete | â³ 11/12 (missing Budget gate) |
| Capsule sovereignty | âœ… All from capsule.body |
| 3 knobs â†’ all settings | âœ… AgentIQ |
| Resilience patterns | âœ… Circuit breakers |
| Security layers | âœ… SpiceDB + OPA + Vault |
| Audit trail | âœ… Reversible, traceable |
| Constitution from SomaBrain | âœ… Not stored locally |

---

## ğŸ“† ESTIMATED TIMELINE

| Sprint | Duration | Status |
|--------|----------|--------|
| 10: Budget System | 2 days | ğŸ”´ NEXT |
| 11: Feature Flags | 2 days | ğŸ”´ |
| 12: Full Permissions | 3 days | ğŸ”´ |
| 13: Multimodal Routing | 1 day | ğŸ”´ |
| **TOTAL** | **8 days** | |

---

**Document End**

*13/16 SRS IMPLEMENTED â€” 81% COMPLETE âœ…*
