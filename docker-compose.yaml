# =============================================================================
# SomaAgent01 Docker Compose - Production-Grade Local Development
# =============================================================================
# Single canonical compose file. Total cluster memory: 10GB max.
# Memory allocations are production-style but constrained for local dev.
# =============================================================================

x-agent-env: &agent-env
  PYTHONPATH: "/git/agent-zero:/git/agent-zero/src:/app"
  LOG_LEVEL: INFO
  SOMA_CONTAINER_HOST_ALIAS: host.docker.internal
  USE_LLM: "true"
  SA01_DEPLOYMENT_MODE: DEV
  SA01_DB_DSN: postgresql://soma:soma@postgres:5432/somaagent01
  SA01_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
  SA01_REDIS_URL: redis://redis:6379/0
  SA01_POLICY_URL: http://opa:8181
  SA01_POLICY_DECISION_PATH: /v1/data/soma/policy/allow
  SA01_AUTH_REQUIRED: "false"
  SA01_AUTH_INTERNAL_TOKEN: "dev-internal-token"
  SA01_SOMA_BASE_URL: http://host.docker.internal:9696
  SA01_CRYPTO_FERNET_KEY: "${SA01_CRYPTO_FERNET_KEY:-O6qM9Oe7zB3w6CqQFctciVwEciXxV9nOcDSBxPTsPOg=}"
  SA01_SSE_ENABLED: "true"

x-agent-service: &agent-service
  image: somaagent01-dev:latest
  build:
    context: .
    dockerfile: Dockerfile
    args:
      INCLUDE_ML_DEPS: ${INCLUDE_ML_DEPS:-true}
      TORCH_VARIANT: ${TORCH_VARIANT:-cpu}
  working_dir: /git/agent-zero
  environment:
    <<: *agent-env
  env_file:
    - ${SOMA_ENV_FILE:-.env}
    - .env.memory
  volumes:
    - ./memory:/git/agent-zero/memory
    - ./logs:/git/agent-zero/logs
    - ./.env:/git/agent-zero/.env
    - ./conf:/git/agent-zero/conf:ro
    - ./services:/git/agent-zero/services:ro
    - ./python:/git/agent-zero/python:ro
    - ./knowledge:/git/agent-zero/knowledge:ro
    - ./instruments:/git/agent-zero/instruments:ro
    - ./agents:/git/agent-zero/agents:ro
    - ./tmp:/git/agent-zero/tmp
    - ./prompts:/git/agent-zero/prompts:ro
    - ./webui:/git/agent-zero/webui:ro
    - ./schemas:/git/agent-zero/schemas:ro
    - ./observability:/git/agent-zero/observability:ro
    - ./src:/git/agent-zero/src:ro
  extra_hosts:
    - "host.docker.internal:host-gateway"
  depends_on:
    kafka:
      condition: service_healthy
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
    opa:
      condition: service_started
  restart: unless-stopped

services:
  temporal:
    image: temporalio/auto-setup:1.23
    container_name: somaAgent01_temporal
    profiles: ["dev"]
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=soma
      - POSTGRES_PWD=soma
      - POSTGRES_SEEDS=postgres
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development.yaml
      - TEMPORAL_BROADCAST_ADDRESS=${TEMPORAL_BROADCAST_ADDRESS:-}
      - SERVICES=frontend,history,matching,worker
    command:
      - sh
      - -c
      - |
        set -- $(hostname -i)
        export TEMPORAL_BROADCAST_ADDRESS="$1"
        exec /etc/temporal/entrypoint.sh
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "7233:7233"
    volumes:
      - ./infra/temporal/dynamicconfig:/etc/temporal/config/dynamicconfig:ro
    mem_limit: 1024m
    mem_reservation: 256m
    cpus: "0.75"

  temporal-ui:
    image: temporalio/ui:2.26
    container_name: somaAgent01_temporal_ui
    profiles: ["dev"]
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_UI_PORT=8080
    depends_on:
      temporal:
        condition: service_started
    ports:
      - "8080:8080"
    mem_limit: 256m
    mem_reservation: 128m
    cpus: "0.25"
  # ===========================================================================
  # INFRASTRUCTURE SERVICES (Core Profile)
  # ===========================================================================

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: somaAgent01_kafka
    profiles: ["core", "dev"]
    user: "0:0"
    environment:
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: "0"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "0@kafka:9093"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,EXTERNAL://0.0.0.0:9094,CONTROLLER://0.0.0.0:9093"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092,EXTERNAL://localhost:${KAFKA_PORT:-21000}"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_NUM_PARTITIONS: "3"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: "0"
      KAFKA_CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_HEAP_OPTS: "-Xms384m -Xmx768m"
      KAFKA_LOG_RETENTION_HOURS: "168"
      KAFKA_LOG_RETENTION_BYTES: "1073741824"
    ports:
      - "${KAFKA_PORT:-21000}:9094"
    restart: unless-stopped
    volumes:
      - kafka_data:/var/lib/kafka/data
      - ./kafka-logs:/var/log/kafka
    healthcheck:
      test: ["CMD-SHELL", "</dev/tcp/127.0.0.1/9092 >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 60s
    mem_limit: 1536m
    mem_reservation: 384m
    cpus: "1.0"

  kafka-init:
    image: confluentinc/cp-kafka:7.4.0
    container_name: somaAgent01_kafka_init
    profiles: ["core", "dev"]
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["bash", "-lc"]
    command: bash /init/init-topics.sh
    environment:
      SA01_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    volumes:
      - ./infra/kafka/init-topics.sh:/init/init-topics.sh:ro
    mem_limit: 256m
    mem_reservation: 64m
    restart: "no"

  redis:
    image: redis:7-alpine
    container_name: somaAgent01_redis
    profiles: ["core", "dev"]
    command: ["redis-server", "--save", "60", "1", "--appendonly", "yes", "--appendfsync", "everysec", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru"]
    ports:
      - "${REDIS_PORT:-20001}:6379"
    restart: unless-stopped
    volumes:
      - redis_data:/data
      - ./redis-conf:/usr/local/etc/redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
    mem_limit: 384m
    mem_reservation: 128m
    cpus: "0.5"

  postgres:
    image: postgres:16-alpine
    container_name: somaAgent01_postgres
    profiles: ["core", "dev"]
    command: ["postgres", "-c", "max_connections=100", "-c", "shared_buffers=128MB", "-c", "work_mem=4MB", "-c", "maintenance_work_mem=64MB"]
    environment:
      POSTGRES_USER: soma
      POSTGRES_PASSWORD: soma
      POSTGRES_DB: somaagent01
      OPENFGA_POSTGRES_USER: openfga
      OPENFGA_POSTGRES_PASSWORD: openfga
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-20002}:5432"
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-backups:/backups
      - ./infra/postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U soma -d somaagent01"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 40s
    mem_limit: 1024m
    mem_reservation: 256m
    cpus: "0.75"

  opa:
    image: openpolicyagent/opa:0.64.0
    container_name: somaAgent01_opa
    profiles: ["core", "dev"]
    command: ["run", "--server", "--watch", "/policy", "--set=decision_logs.console=true"]
    ports:
      - "${OPA_PORT:-20009}:8181"
    restart: unless-stopped
    volumes:
      - ./policy:/policy:ro
    mem_limit: 128m
    mem_reservation: 64m
    cpus: "0.25"


  # ===========================================================================
  # AGENT SERVICES (Dev Profile)
  # ===========================================================================

  gateway:
    <<: *agent-service
    container_name: somaAgent01_gateway
    profiles: ["dev"]
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    command:
      - python3
      - -m
      - uvicorn
      - services.gateway.main:app
      - --host
      - "0.0.0.0"
      - --port
      - "8010"
    environment:
      <<: *agent-env
      PORT: "8010"
      SA01_KAFKA_PUBLISH_TIMEOUT_SECONDS: "5.0"
      SA01_GATEWAY_WRITE_THROUGH: "true"
      SA01_GATEWAY_WRITE_THROUGH_ASYNC: "true"
    ports:
      - "${GATEWAY_PORT:-21016}:8010"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8010/v1/health >/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    mem_limit: 1536m
    mem_reservation: 512m
    cpus: "1.0"
    networks:
      - default
      - somaagent01_dev

  conversation-worker:
    <<: *agent-service
    container_name: somaAgent01_conversation-worker
    profiles: ["dev"]
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      temporal:
        condition: service_started
    environment:
      <<: *agent-env
      CONVERSATION_METRICS_PORT: "9410"
      SA01_TEMPORAL_HOST: ${SA01_TEMPORAL_HOST:-temporal:7233}
      SA01_TEMPORAL_CONVERSATION_QUEUE: conversation
    command:
      - python3
      - -m
      - services.conversation_worker.temporal_worker
    healthcheck:
      test: ["CMD", "true"]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 512m
    mem_reservation: 192m
    cpus: "0.5"

  tool-executor:
    <<: *agent-service
    container_name: somaAgent01_tool-executor
    profiles: ["dev"]
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      temporal:
        condition: service_started
    command:
      - python3
      - -m
      - services.tool_executor.temporal_worker
    environment:
      <<: *agent-env
      TOOL_EXECUTOR_METRICS_PORT: "9411"
      SA01_TEMPORAL_HOST: ${SA01_TEMPORAL_HOST:-temporal:7233}
      SA01_TEMPORAL_TOOL_QUEUE: tool-executor
    healthcheck:
      test: ["CMD", "true"]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 512m
    mem_reservation: 192m
    cpus: "0.5"

  memory-replicator:
    <<: *agent-service
    container_name: somaAgent01_memory-replicator
    profiles: ["dev"]
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    command:
      - python3
      - -m
      - services.memory_replicator.main
    environment:
      <<: *agent-env
      REPLICATOR_METRICS_PORT: "9412"
    healthcheck:
      test: ["CMD", "true"]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 256m
    mem_reservation: 96m
    cpus: "0.25"

  # ===========================================================================
  # FASTA2A SERVICES (Agent-to-Agent Communication)
  # ===========================================================================

  fasta2a-gateway:
    <<: *agent-service
    container_name: somaAgent01_fasta2a-gateway
    profiles: ["dev"]
    command:
      - python3
      - -m
      - services.delegation_gateway.temporal_worker
    environment:
      <<: *agent-env
      PORT: "8011"
      FASTA2A_GATEWAY_METRICS_PORT: "9420"
      SA01_TEMPORAL_HOST: ${SA01_TEMPORAL_HOST:-temporal:7233}
      SA01_TEMPORAL_A2A_QUEUE: a2a
    ports:
      - "${FASTA2A_GATEWAY_PORT:-21017}:8011"
    healthcheck:
      test: ["CMD", "true"]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 512m
    mem_reservation: 192m
    cpus: "0.5"

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  default:
    external: true
    name: somaagent01
  somaagent01_dev:
    external: true
    name: somaagent01_dev

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  kafka_data:
  redis_data:
  postgres_data:
