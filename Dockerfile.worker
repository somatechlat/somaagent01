# ============================================================================
# SomaAgent01 Worker - Kafka/Temporal Background Services
# ============================================================================
#
# Purpose: Background workers (conversation, tool-executor, delegation)
# Size: ~700MB (includes Kafka, Temporal clients)
# Services: conversation-worker, tool-executor, delegation-gateway
# Build: make build-worker
#
# Includes: Kafka, Temporal, LLM clients - NO ML, NO ffmpeg
# ============================================================================

FROM python:3.11-slim AS builder

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    VENV_PATH="/opt/venv"

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    libsasl2-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

RUN python -m venv "${VENV_PATH}" && \
    "${VENV_PATH}/bin/pip" install --upgrade pip setuptools wheel

WORKDIR /opt/build

COPY requirements-core.txt requirements-worker.txt ./

RUN "${VENV_PATH}/bin/pip" install --no-cache-dir -r requirements-worker.txt

# ============================================================================
# STAGE 2: Runtime
# ============================================================================
FROM python:3.11-slim AS runtime

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    VENV_PATH="/opt/venv" \
    DJANGO_SETTINGS_MODULE="services.gateway.settings"

ENV PATH="${VENV_PATH}/bin:$PATH" \
    PYTHONPATH=/app

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    libpq5 \
    libsasl2-2 \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /opt/venv /opt/venv

WORKDIR /app

# Copy worker-specific code
COPY admin/ /app/admin/
COPY services/ /app/services/
COPY python/ /app/python/
COPY integrations/ /app/integrations/
COPY src/ /app/src/
COPY manage.py sitecustomize.py agent.py models.py /app/
COPY scripts/entrypoints/ /app/scripts/entrypoints/

RUN useradd -m -u 1000 agent && \
    chown -R agent:agent /app && \
    chmod +x /app/scripts/entrypoints/*.sh

USER agent

ENTRYPOINT ["/app/scripts/entrypoints/django-entrypoint.sh"]
CMD ["python", "-m", "services.conversation_worker.main"]
