{{- $g := .Values.global -}}
{{- if $g.HPA_ENABLED }}
{{- with .Values.services.gateway }}
{{- if and .enabled .hpa.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "soma-stack.fullname" $ }}-gateway
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "soma-stack.fullname" $ }}-gateway
  minReplicas: {{ .hpa.minReplicas | default 1 }}
  maxReplicas: {{ .hpa.maxReplicas | default 5 }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .hpa.targetCPUUtilizationPercentage | default 70 }}
{{- end }}
{{- end }}

{{- with .Values.services.conversationWorker }}
{{- if and .enabled .hpa.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "soma-stack.fullname" $ }}-conversation-worker
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "soma-stack.fullname" $ }}-conversation-worker
  minReplicas: {{ .hpa.minReplicas | default 1 }}
  maxReplicas: {{ .hpa.maxReplicas | default 5 }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .hpa.targetCPUUtilizationPercentage | default 70 }}
{{- end }}
{{- end }}

{{- with .Values.services.toolExecutor }}
{{- if and .enabled .hpa.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "soma-stack.fullname" $ }}-tool-executor
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "soma-stack.fullname" $ }}-tool-executor
  minReplicas: {{ .hpa.minReplicas | default 1 }}
  maxReplicas: {{ .hpa.maxReplicas | default 5 }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .hpa.targetCPUUtilizationPercentage | default 70 }}
{{- end }}
{{- end }}

{{- with .Values.services.delegationGateway }}
{{- if and .enabled .hpa.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "soma-stack.fullname" $ }}-delegation-gateway
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "soma-stack.fullname" $ }}-delegation-gateway
  minReplicas: {{ .hpa.minReplicas | default 1 }}
  maxReplicas: {{ .hpa.maxReplicas | default 5 }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .hpa.targetCPUUtilizationPercentage | default 70 }}
{{- end }}
{{- end }}

{{- with .Values.services.ui }}
{{- if and .enabled .hpa.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "soma-stack.fullname" $ }}-ui
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "soma-stack.fullname" $ }}-ui
  minReplicas: {{ .hpa.minReplicas | default 1 }}
  maxReplicas: {{ .hpa.maxReplicas | default 5 }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .hpa.targetCPUUtilizationPercentage | default 70 }}
{{- end }}
{{- end }}

{{- with .Values.services.uiProxy }}
{{- if and .enabled .hpa.enabled }}
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "soma-stack.fullname" $ }}-ui-proxy
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "soma-stack.fullname" $ }}-ui-proxy
  minReplicas: {{ .hpa.minReplicas | default 1 }}
  maxReplicas: {{ .hpa.maxReplicas | default 5 }}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .hpa.targetCPUUtilizationPercentage | default 70 }}
{{- end }}
{{- end }}
{{- end }}
