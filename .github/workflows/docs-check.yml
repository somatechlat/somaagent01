name: Documentation Presence & Quality Check
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  verify-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Define required files
        id: files
        run: |
          cat <<EOF > required_files.txt
          docs/README.md
          docs/front_matter.yaml
          docs/glossary.md
          docs/style-guide.md
          docs/changelog.md
          docs/metadata.json
          docs/review-log.md
          docs/accessibility.md
          docs/security-classification.md
          docs/traceability-matrix.xlsx
          docs/i18n/en/README.md
          docs/user-manual/index.md
          docs/user-manual/installation.md
          docs/user-manual/quick-start-tutorial.md
          docs/user-manual/features/feature-data-pipeline.md
          docs/user-manual/features/feature-real-time-propagation.md
          docs/user-manual/faq.md
          docs/technical-manual/index.md
          docs/technical-manual/architecture.md
          docs/technical-manual/architecture.puml
          docs/technical-manual/deployment.md
          docs/technical-manual/monitoring.md
          docs/technical-manual/data-flow.mermaid
          docs/technical-manual/runbooks/propagation-service.md
          docs/technical-manual/runbooks/data-ingest-service.md
          docs/technical-manual/backup-and-recovery.md
          docs/technical-manual/security/secrets-policy.md
          docs/technical-manual/security/rbac-matrix.md
          docs/development-manual/index.md
          docs/development-manual/local-setup.md
          docs/development-manual/first-contribution.md
          docs/development-manual/coding-standards.md
          docs/development-manual/testing-guidelines.md
          docs/development-manual/api-reference.md
          docs/development-manual/contribution-process.md
          docs/onboarding-manual/project-context.md
          docs/onboarding-manual/codebase-walkthrough.md
          docs/onboarding-manual/first-contribution.md
          docs/onboarding-manual/team-collaboration.md
          docs/onboarding-manual/domain-knowledge.md
          docs/agent-onboarding/index.md
          docs/agent-onboarding/agent-zero.md
          docs/agent-onboarding/propagation-agent.md
          docs/agent-onboarding/monitoring-agent.md
          docs/agent-onboarding/security-hardening.md
          EOF

      - name: Verify each required file exists
        run: |
          missing=0
          while IFS= read -r file; do
            if [[ ! -f "$file" ]]; then
              echo "::error file=$file::Missing documentation file"
              missing=$((missing+1))
            fi
          done < required_files.txt
          if [[ $missing -gt 0 ]]; then
            echo "Documentation check failed: $missing file(s) missing."
            exit 1
          else
            echo "All required documentation files are present."
          fi

      - name: Markdown lint (markdownlint-cli2)
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          config: docs/.markdownlint.json
          globs: "docs/**/*.md"

      - name: Link check (remark-validate-links)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: |
          npm install -g remark-cli remark-validate-links
          remark docs --use remark-validate-links --quiet
