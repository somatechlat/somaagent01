<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>SomaAgent01 - Diagnostic Page</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #f8fafc;
      padding: 2rem;
      margin: 0;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      color: #6366f1;
    }
    h2 {
      color: #94a3b8;
      border-bottom: 1px solid #334155;
      padding-bottom: 0.5rem;
    }
    .status {
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .success {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid #10b981;
    }
    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
    }
    .pending {
      background: rgba(245, 158, 11, 0.2);
      border: 1px solid #f59e0b;
    }
    .info {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid #3b82f6;
    }
    pre {
      background: #1e293b;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.85rem;
      max-height: 300px;
      overflow-y: auto;
    }
    button {
      background: #6366f1;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.5rem;
    }
    button:hover {
      background: #4f46e5;
    }
    button.danger {
      background: #ef4444;
    }
    button.danger:hover {
      background: #dc2626;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .card {
      background: #1e293b;
      padding: 1rem;
      border-radius: 8px;
    }
    .card-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #94a3b8;
    }
    .card-value {
      font-size: 1.25rem;
      color: #f8fafc;
    }
    .warning-box {
      background: rgba(245, 158, 11, 0.2);
      border: 2px solid #f59e0b;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .warning-box h3 {
      color: #f59e0b;
      margin-top: 0;
    }
    code {
      background: #334155;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß SomaAgent01 Diagnostic Page</h1>
    <p>This page diagnoses issues with the UI loading. If you see this page, your browser can reach the server.</p>
    
    <div class="warning-box" id="cache-warning" style="display:none;">
      <h3>‚ö†Ô∏è Browser Cache Issue Detected</h3>
      <p>Your browser may be serving cached (old) files. Click the button below to fix:</p>
      <button class="danger" onclick="nukeEverything()">üî• NUCLEAR CACHE CLEAR</button>
      <p style="margin-top:1rem;font-size:0.9rem;">This will unregister all service workers, clear all caches, and reload the page.</p>
    </div>
    
    <h2>Browser Info</h2>
    <div class="grid">
      <div class="card">
        <div class="card-title">Browser</div>
        <div class="card-value" id="browser-info">-</div>
      </div>
      <div class="card">
        <div class="card-title">Service Workers</div>
        <div class="card-value" id="sw-count">-</div>
      </div>
      <div class="card">
        <div class="card-title">Caches</div>
        <div class="card-value" id="cache-count">-</div>
      </div>
      <div class="card">
        <div class="card-title">LocalStorage Items</div>
        <div class="card-value" id="ls-count">-</div>
      </div>
    </div>
    
    <h2>API Tests</h2>
    <div id="health-status" class="status pending">
      <strong>Health Check:</strong> <span id="health-result">Checking...</span>
    </div>
    
    <div id="sessions-status" class="status pending">
      <strong>Sessions API:</strong> <span id="sessions-result">Checking...</span>
    </div>
    
    <div id="settings-status" class="status pending">
      <strong>Settings API:</strong> <span id="settings-result">Checking...</span>
    </div>
    
    <div id="css-status" class="status pending">
      <strong>CSS Loading:</strong> <span id="css-result">Checking...</span>
    </div>
    
    <div id="index-status" class="status pending">
      <strong>Index.html Check:</strong> <span id="index-result">Checking...</span>
    </div>
    
    <h2>Actions</h2>
    <button onclick="nukeEverything()">üî• Nuclear Cache Clear</button>
    <button onclick="clearCache()">Clear Service Worker Only</button>
    <button onclick="runTests()">Re-run Tests</button>
    <button onclick="location.href='/?nocache=' + Date.now()">Go to Main UI (no cache)</button>
    
    <h2>Console Output</h2>
    <pre id="console-output"></pre>
    
    <h2>How to Fix Manually</h2>
    <div class="status info">
      <p><strong>If the Nuclear Cache Clear doesn't work:</strong></p>
      <ol>
        <li>Open DevTools (F12 or Cmd+Option+I)</li>
        <li>Go to Application tab ‚Üí Storage</li>
        <li>Click "Clear site data"</li>
        <li>Or try: <code>chrome://settings/clearBrowserData</code> (Chrome) or <code>about:preferences#privacy</code> (Firefox)</li>
        <li>Try a different browser or incognito/private window</li>
      </ol>
    </div>
  </div>
  
  <script>
    const log = (msg) => {
      const output = document.getElementById('console-output');
      output.textContent += msg + '\n';
      console.log(msg);
    };
    
    // Browser info
    async function getBrowserInfo() {
      document.getElementById('browser-info').textContent = navigator.userAgent.split(' ').pop();
      
      // Service workers
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        document.getElementById('sw-count').textContent = regs.length;
        if (regs.length > 0) {
          document.getElementById('cache-warning').style.display = 'block';
        }
      } else {
        document.getElementById('sw-count').textContent = 'N/A';
      }
      
      // Caches
      if ('caches' in window) {
        const names = await caches.keys();
        document.getElementById('cache-count').textContent = names.length;
        if (names.length > 0) {
          document.getElementById('cache-warning').style.display = 'block';
        }
      } else {
        document.getElementById('cache-count').textContent = 'N/A';
      }
      
      // LocalStorage
      try {
        document.getElementById('ls-count').textContent = localStorage.length;
      } catch (e) {
        document.getElementById('ls-count').textContent = 'N/A';
      }
    }
    
    async function testHealth() {
      const el = document.getElementById('health-status');
      const result = document.getElementById('health-result');
      try {
        const res = await fetch('/v1/health?_=' + Date.now());
        const data = await res.json();
        result.textContent = data.ok ? 'OK' : JSON.stringify(data);
        el.className = 'status success';
        log('‚úì Health check passed');
        return true;
      } catch (e) {
        result.textContent = 'Error: ' + e.message;
        el.className = 'status error';
        log('‚úó Health check failed: ' + e.message);
        return false;
      }
    }
    
    async function testSessions() {
      const el = document.getElementById('sessions-status');
      const result = document.getElementById('sessions-result');
      try {
        const res = await fetch('/v1/sessions?_=' + Date.now());
        const data = await res.json();
        const count = Array.isArray(data) ? data.length : (data.contexts?.length || 0);
        result.textContent = `${count} sessions`;
        el.className = 'status success';
        log('‚úì Sessions API passed');
        return true;
      } catch (e) {
        result.textContent = 'Error: ' + e.message;
        el.className = 'status error';
        log('‚úó Sessions API failed: ' + e.message);
        return false;
      }
    }
    
    async function testSettings() {
      const el = document.getElementById('settings-status');
      const result = document.getElementById('settings-result');
      try {
        const res = await fetch('/v1/settings?_=' + Date.now());
        const data = await res.json();
        result.textContent = data.sections ? `${data.sections.length} sections` : 'OK';
        el.className = 'status success';
        log('‚úì Settings API passed');
        return true;
      } catch (e) {
        result.textContent = 'Error: ' + e.message;
        el.className = 'status error';
        log('‚úó Settings API failed: ' + e.message);
        return false;
      }
    }
    
    async function testCSS() {
      const el = document.getElementById('css-status');
      const result = document.getElementById('css-result');
      try {
        const res = await fetch('/static/design-system/index.css?_=' + Date.now());
        if (res.ok) {
          const text = await res.text();
          // Check if it contains our new design system
          const hasNewDesign = text.includes('--color-primary') || text.includes('--radius');
          result.textContent = `${text.length} bytes, ${hasNewDesign ? 'NEW design' : 'OLD design!'}`;
          el.className = hasNewDesign ? 'status success' : 'status error';
          log(hasNewDesign ? '‚úì CSS is NEW design system' : '‚úó CSS is OLD - cache issue!');
          if (!hasNewDesign) {
            document.getElementById('cache-warning').style.display = 'block';
          }
          return hasNewDesign;
        } else {
          throw new Error(`HTTP ${res.status}`);
        }
      } catch (e) {
        result.textContent = 'Error: ' + e.message;
        el.className = 'status error';
        log('‚úó CSS loading failed: ' + e.message);
        return false;
      }
    }
    
    async function testIndex() {
      const el = document.getElementById('index-status');
      const result = document.getElementById('index-result');
      try {
        const res = await fetch('/static/index.html?_=' + Date.now());
        if (res.ok) {
          const text = await res.text();
          // Check for new UI markers
          const hasNewUI = text.includes('appController') && text.includes('design-system/index.css');
          const hasAlpine = text.includes('alpine');
          result.textContent = `${hasNewUI ? 'NEW UI' : 'OLD UI!'}, Alpine: ${hasAlpine ? 'Yes' : 'No'}`;
          el.className = hasNewUI ? 'status success' : 'status error';
          log(hasNewUI ? '‚úì Index.html is NEW UI' : '‚úó Index.html is OLD - cache issue!');
          if (!hasNewUI) {
            document.getElementById('cache-warning').style.display = 'block';
          }
          return hasNewUI;
        } else {
          throw new Error(`HTTP ${res.status}`);
        }
      } catch (e) {
        result.textContent = 'Error: ' + e.message;
        el.className = 'status error';
        log('‚úó Index.html check failed: ' + e.message);
        return false;
      }
    }
    
    async function clearCache() {
      log('Clearing service worker cache...');
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (const reg of registrations) {
          await reg.unregister();
          log('Unregistered service worker: ' + reg.scope);
        }
      }
      const cacheNames = await caches.keys();
      for (const name of cacheNames) {
        await caches.delete(name);
        log('Deleted cache: ' + name);
      }
      log('Cache cleared! Reloading...');
      setTimeout(() => location.reload(true), 1000);
    }
    
    async function nukeEverything() {
      log('üî• NUCLEAR CACHE CLEAR INITIATED...\n');
      
      // 1. Unregister ALL service workers
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        log(`Found ${registrations.length} service workers`);
        for (const reg of registrations) {
          await reg.unregister();
          log('  Unregistered: ' + reg.scope);
        }
      }
      
      // 2. Delete ALL caches
      if ('caches' in window) {
        const cacheNames = await caches.keys();
        log(`Found ${cacheNames.length} caches`);
        for (const name of cacheNames) {
          await caches.delete(name);
          log('  Deleted: ' + name);
        }
      }
      
      // 3. Clear localStorage
      try {
        const count = localStorage.length;
        localStorage.clear();
        log(`Cleared ${count} localStorage items`);
      } catch (e) {
        log('Could not clear localStorage: ' + e.message);
      }
      
      // 4. Clear sessionStorage
      try {
        const count = sessionStorage.length;
        sessionStorage.clear();
        log(`Cleared ${count} sessionStorage items`);
      } catch (e) {
        log('Could not clear sessionStorage: ' + e.message);
      }
      
      log('\n‚úì All caches cleared!');
      log('Reloading in 2 seconds...');
      
      // Force reload bypassing cache
      setTimeout(() => {
        window.location.href = '/?nocache=' + Date.now();
      }, 2000);
    }
    
    async function runTests() {
      document.getElementById('console-output').textContent = '';
      log('Running diagnostics...\n');
      log('Timestamp: ' + new Date().toISOString() + '\n');
      
      await getBrowserInfo();
      await testHealth();
      await testSessions();
      await testSettings();
      await testCSS();
      await testIndex();
      
      log('\nDiagnostics complete!');
    }
    
    // Run tests on load
    runTests();
  </script>
</body>
</html>
