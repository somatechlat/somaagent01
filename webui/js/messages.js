// message actions and components
import { openImageModal } from "i18n.t('ui_i18n_t_ui_image_modal_js')";
import { marked } from "i18n.t('ui_i18n_t_ui_vendor_marked_marked_esm_js')";
import { store as _messageResizeStore } from "i18n.t('ui_i18n_t_ui_components_messages_resize_message_resize_store_js')"; // keep here, required in html
import { store as attachmentsStore } from "i18n.t('ui_i18n_t_ui_components_chat_attachments_attachmentsstore_js')";
import { addActionButtonsToElement } from "i18n.t('ui_i18n_t_ui_components_messages_action_buttons_simple_action_buttons_js')";

const chatHistory = document.getElementById("i18n.t('ui_i18n_t_ui_chat_history')");

let messageGroup = null;

// Simplified implementation - no complex interactions needed

export function setMessage(id, type, heading, content, temp, kvps = null) {
  // Search for the existing message container by id
  let messageContainer = document.getElementById(`message-${id}`);
  let isNewMessage = false;

  if (messageContainer) {
    // Don't clear innerHTML - we'll do incremental updates
    // messageContainer.innerHTML = ""i18n.t('ui_i18n_t_ui_else_create_a_new_container_if_not_found_isnewmessage_true_const_sender_type')"user"i18n.t('ui_i18n_t_ui')"user"i18n.t('ui_i18n_t_ui')"ai"i18n.t('ui_i18n_t_ui_messagecontainer_document_createelement')"div"i18n.t('ui_i18n_t_ui_messagecontainer_id_message_id_messagecontainer_classlist_add')"message-container"i18n.t('ui_i18n_t_ui_sender_container_const_handler_gethandler_type_handler_messagecontainer_id_type_heading_content_temp_kvps_if_this_is_a_new_message_handle_dom_insertion_if_document_getelementbyid_message_id_message_type_visual_grouping_const_grouptypemap_user')"right"i18n.t('ui_i18n_t_ui_info')"mid"i18n.t('ui_i18n_t_ui_warning')"mid"i18n.t('ui_i18n_t_ui_error')"mid"i18n.t('ui_i18n_t_ui_rate_limit')"mid"i18n.t('ui_i18n_t_ui_util')"mid"i18n.t('ui_i18n_t_ui_hint')"mid"i18n.t('ui_i18n_t_ui_anything_else_is')"left"i18n.t('ui_i18n_t_ui_force_new_group_on_these_types_const_groupstart_agent_true_anything_else_is_false_const_grouptype_grouptypemap_type')"left"i18n.t('ui_i18n_t_ui_here_check_if_messagegroup_is_still_in_dom_if_not_then_set_it_to_null_context_switch_if_messagegroup_document_getelementbyid_messagegroup_id_messagegroup_null_if_messagegroup_no_group_yet_exists_groupstart_type_message_type_forces_new_group_grouptype_messagegroup_getattribute')"di18n.t('ui_headingelement_appendchild_minmaxbtn_else_remove_heading_if_it_exists_but_heading_is_null_const_existingheading_messagediv_queryselector_msg_heading_if_existingheading_existingheading_remove_find_existing_body_div_or_create_new_one_let_bodydiv_messagediv_queryselector_message_body_if_bodydiv_bodydiv_document_createelement_div_bodydiv_classlist_add_message_body_messagediv_appendchild_bodydiv_reapply_scroll_position_or_autoscroll_const_scroller_new_scroller_bodydiv_handle_kvps_incrementally_drawkvpsincremental_bodydiv_kvps_false_handle_content_if_content_content_trim_length_0_if_markdown_let_contentdiv_bodydiv_queryselector_msg_content_if_contentdiv_contentdiv_document_createelement_div_bodydiv_appendchild_contentdiv_contentdiv_classname_msg_content_contentclasses_join_let_spanelement_contentdiv_queryselector_span_if_spanelement_spanelement_document_createelement_span_contentdiv_appendchild_spanelement_let_processedcontent_content_processedcontent_convertimagetags_processedcontent_processedcontent_convertimgfilepaths_processedcontent_processedcontent_marked_parse_processedcontent_breaks_true_processedcontent_convertpathstolinks_processedcontent_processedcontent_addblanktargetstolinks_processedcontent_spanelement_innerhtml_processedcontent_katex_rendering_for_markdown_if_latex_spanelement_queryselectorall_latex_foreach_element_katex_render_element_innerhtml_element_throwonerror_false_ensure_action_buttons_exist_addactionbuttonstoelement_bodydiv_adjustmarkdownrender_contentdiv_else_let_preelement_bodydiv_queryselector_msg_content_if_preelement_preelement_document_createelement_pre_preelement_classlist_add_msg_content_contentclasses_preelement_style_whitespace_pre_wrap_preelement_style_wordbreak_break_word_bodydiv_appendchild_preelement_else_update_classes_preelement_classname_msg_content_contentclasses_join_let_spanelement_preelement_queryselector_span_if_spanelement_spanelement_document_createelement_span_preelement_appendchild_spanelement_spanelement_innerhtml_converthtml_content_ensure_action_buttons_exist_addactionbuttonstoelement_bodydiv_else_remove_content_if_it_exists_but_content_is_empty_const_existingcontent_bodydiv_queryselector_msg_content_if_existingcontent_existingcontent_remove_reapply_scroll_position_or_autoscroll_scroller_reapplyscroll_if_followup_messagecontainer_classlist_add_message_followup_return_messagediv_export_function_addblanktargetstolinks_str_const_doc_new_domparser_parsefromstring_str_text_html_doc_queryselectorall_a_foreach_anchor_const_href_anchor_getattribute_href_if_href_startswith_href_trim_tolowercase_startswith_javascript_return_if_anchor_hasattribute_target_anchor_getattribute_target_anchor_setattribute_target_blank_const_rel_anchor_getattribute_rel_split_s_filter_boolean_if_rel_includes_noopener_rel_push_noopener_if_rel_includes_noreferrer_rel_push_noreferrer_anchor_setattribute_rel_rel_join_return_doc_body_innerhtml_export_function_drawmessagedefault_messagecontainer_id_type_heading_content_temp_kvps_null_drawmessage_messagecontainer_heading_content_temp_false_message_default_kvps_message_ai_msg_json_false_false_export_function_drawmessageagent_messagecontainer_id_type_heading_content_temp_kvps_null_let_kvpsflat_null_if_kvps_kvpsflat_kvps_kvps_tool_args_delete_kvpsflat_tool_args_drawmessage_messagecontainer_heading_content_temp_false_message_agent_kvpsflat_message_ai_msg_json_false_false_export_function_drawmessageresponse_messagecontainer_id_type_heading_content_temp_kvps_null_drawmessage_messagecontainer_heading_content_temp_true_message_agent_response_null_message_ai_true_true_export_function_drawmessagedelegation_messagecontainer_id_type_heading_content_temp_kvps_null_drawmessage_messagecontainer_heading_content_temp_true_message_agent_delegation_kvps_message_ai_message_agent_true_false_export_function_drawmessageuser_messagecontainer_id_type_heading_content_temp_kvps_null_latex_false_find_existing_message_div_or_create_new_one_let_messagediv_messagecontainer_queryselector_message_if_messagediv_messagediv_document_createelement_div_messagediv_classlist_add_message_message_user_messagecontainer_appendchild_messagediv_else_ensure_it_has_the_correct_classes_if_it_already_exists_messagediv_classname_message_message_user_handle_heading_let_headingelement_messagediv_queryselector_msg_heading_if_headingelement_headingelement_document_createelement_h4_headingelement_classlist_add_msg_heading_messagediv_insertbefore_headingelement_messagediv_firstchild_headingelement_innerhtml_heading'))""i18n.t('ui_i18n_t_ui_anchor_setattribute')"target"i18n.t('ui_i1i18n_t_ui_person_ui')"_i18n.t('ui_handle_content_let_textdiv_messagediv_queryselector_message_text_if_content_content_trim_length_0_if_textdiv_textdiv_document_createelement_div_textdiv_classlist_add_message_text_messagediv_appendchild_textdiv_let_spanelement_textdiv_queryselector_pre_if_spanelement_spanelement_document_createelement_pre_textdiv_appendchild_spanelement_spanelement_innerhtml_escapehtml_content_addactionbuttonstoelement_textdiv_else_if_textdiv_textdiv_remove_handle_attachments_let_attachmentscontainer_messagediv_queryselector_attachments_container_if_kvps_kvps_attachments_kvps_attachments_length_0_if_attachmentscontainer_attachmentscontainer_document_createelement_div_attachmentscontainer_classlist_add_attachments_container_messagediv_appendchild_attachmentscontainer_important_clear_existing_attachments_to_re_render_preventing_duplicates_on_update_attachmentscontainer_innerhtml_kvps_attachments_foreach_attachment_const_attachmentdiv_document_createelement_div_attachmentdiv_classlist_add_attachment_item_const_displayinfo_attachmentsstore_getattachmentdisplayinfo_attachment_if_displayinfo_isimage_attachmentdiv_classlist_add_image_type_const_img_document_createelement_img_img_src_displayinfo_previewurl_img_alt_displayinfo_filename_img_classlist_add_attachment_preview_img_style_cursor_pointer_attachmentdiv_appendchild_img_else_render_as_file_tile_with_title_and_icon_attachmentdiv_classlist_add_file_type_file_icon_if_displayinfo_previewurl_displayinfo_previewurl_displayinfo_filename_const_iconimg_document_createelement_img_iconimg_src_displayinfo_previewurl_iconimg_alt_displayinfo_extension_file_iconimg_classlist_add_file_icon_attachmentdiv_appendchild_iconimg_file_title_const_filetitle_document_createelement_div_filetitle_classlist_add_file_title_filetitle_textcontent_displayinfo_filename_attachmentdiv_appendchild_filetitle_attachmentdiv_addeventlistener_click_displayinfo_clickhandler_attachmentscontainer_appendchild_attachmentdiv_else_if_attachmentscontainer_attachmentscontainer_remove_the_messagediv_is_already_appended_or_updated_no_need_to_append_again_export_function_drawmessagetool_messagecontainer_id_type_heading_content_temp_kvps_null_drawmessage_messagecontainer_heading_content_temp_true_message_tool_kvps_message_ai_msg_output_false_false_export_function_drawmessagecodeexe_messagecontainer_id_type_heading_content_temp_kvps_null_drawmessage_messagecontainer_heading_content_temp_true_message_code_exe_null_message_ai_false_false_export_function_drawmessagebrowser_messagecontainer_id_type_heading_content_temp_kvps_null_drawmessage_messagecontainer_heading_content_temp_true_message_browser_kvps_message_ai_msg_json_false_false_export_function_drawmessageagentplain_mainclass_messagecontainer_id_type_heading_content_temp_kvps_null_drawmessage_messagecontainer_heading_content_temp_false_mainclass_kvps_false_false_messagecontainer_classlist_add_center_container_export_function_drawmessageinfo_messagecontainer_id_type_heading_content_temp_kvps_null_return_drawmessageagentplain_message_info_messagecontainer_id_type_heading_content_temp_kvps_export_function_drawmessageutil_messagecontainer_id_type_heading_content_temp_kvps_null_drawmessage_messagecontainer_heading_content_temp_false_message_util_kvps_msg_json_false_false_messagecontainer_classlist_add_center_container_export_function_drawmessagewarning_messagecontainer_id_type_heading_content_temp_kvps_null_return_drawmessageagentplain_message_warning_messagecontainer_id_type_heading_content_temp_kvps_export_function_drawmessageerror_messagecontainer_id_type_heading_content_temp_kvps_null_return_drawmessageagentplain_message_error_messagecontainer_id_type_heading_content_temp_kvps_function_drawkvps_container_kvps_latex_if_kvps_const_table_document_createelement_table_table_classlist_add_msg_kvps_for_let_key_value_of_object_entries_kvps_const_row_table_insertrow_row_classlist_add_kvps_row_if_key_thoughts_key_reasoning_special_class_assignment_for_thoughts_and_reasoning_content_row_classlist_add_msg_thoughts_const_th_row_insertcell_th_textcontent_converttotitlecase_key_th_classlist_add_kvps_key_const_td_row_insertcell_const_tdiv_document_createelement_div_tdiv_classlist_add_kvps_val_td_appendchild_tdiv_if_array_isarray_value_for_const_item_of_value_addvalue_item_else_addvalue_value_addactionbuttonstoelement_tdiv_autoscroll_the_kvp_value_if_needed_auto_scroll_with_delayed_execution_to_ensure_proper_rendering_settimeout_tdiv_scrolltop_tdiv_scrollheight_0_function_addvalue_value_if_typeof_value_object_value_json_stringify_value_null_2_if_typeof_value_string_value_startswith_img_const_imgelement_document_createelement_img_imgelement_classlist_add_kvps_img_imgelement_src_mapimgurl_value_imgelement_alt_image_attachment_tdiv_appendchild_imgelement_add_click_handler_and_cursor_change_imgelement_style_cursor_pointer_imgelement_addeventlistener_click_openimagemodal_imgelement_src_1000_else_const_pre_document_createelement_pre_const_span_document_createelement_span_span_innerhtml_converthtml_value_pre_appendchild_span_tdiv_appendchild_pre_katex_rendering_for_markdown_if_latex_span_queryselectorall_latex_foreach_element_katex_render_element_innerhtml_element_throwonerror_false_container_appendchild_table_function_drawkvpsincremental_container_kvps_latex_if_kvps_find_existing_table_or_create_new_one_let_table_container_queryselector_msg_kvps_if_table_table_document_createelement_table_table_classlist_add_msg_kvps_container_appendchild_table_get_all_current_rows_for_comparison_let_existingrows_table_queryselectorall_kvps_row_const_kvpentries_object_entries_kvps_update_or_create_rows_as_needed_kvpentries_foreach_key_value_index_let_row_existingrows_index_if_row_create_new_row_if_it_doesn_t_exist_row_table_insertrow_row_classlist_add_kvps_row_update_row_classes_row_classname_kvps_row_if_key_thoughts_key_reasoning_row_classlist_add_msg_thoughts_handle_key_cell_let_th_row_queryselector_kvps_key_if_th_th_row_insertcell_0_th_classlist_add_kvps_key_th_textcontent_converttotitlecase_key_handle_value_cell_let_td_row_cells_1_if_td_td_row_insertcell_1_let_tdiv_td_queryselector_kvps_val_if_tdiv_tdiv_document_createelement_div_tdiv_classlist_add_kvps_val_td_appendchild_tdiv_reapply_scroll_position_or_autoscroll_const_scroller_new_scroller_tdiv_clear_and_rebuild_content_for_now_could_be_optimized_further_tdiv_innerhtml_addactionbuttonstoelement_tdiv_if_array_isarray_value_for_const_item_of_value_addvalue_item_tdiv_else_addvalue_value_tdiv_reapply_scroll_position_or_autoscroll_scroller_reapplyscroll_remove_extra_rows_if_we_have_fewer_kvps_now_while_existingrows_length_kvpentries_length_const_lastrow_existingrows_existingrows_length_1_lastrow_remove_existingrows_table_queryselectorall_kvps_row_function_addvalue_value_tdiv_if_typeof_value_object_value_json_stringify_value_null_2_if_typeof_value_string_value_startswith_img_const_imgelement_document_createelement_img_imgelement_classlist_add_kvps_img_imgelement_src_mapimgurl_value_imgelement_alt_image_attachment_tdiv_appendchild_imgelement_add_click_handler_and_cursor_change_imgelement_style_cursor_pointer_imgelement_addeventlistener_click_openimagemodal_imgelement_src_1000_else_const_pre_document_createelement_pre_const_span_document_createelement_span_span_innerhtml_converthtml_value_pre_appendchild_span_tdiv_appendchild_pre_add_action_buttons_to_the_row_const_row_tdiv_closest_kvps_row_if_row_addactionbuttonstoelement_pre_katex_rendering_for_markdown_if_latex_span_queryselectorall_latex_foreach_element_katex_render_element_innerhtml_element_throwonerror_false_else_remove_table_if_kvps_is_null_empty_const_existingtable_container_queryselector_msg_kvps_if_existingtable_existingtable_remove_function_converttotitlecase_str_return_str_replace_g_replace_underscores_with_spaces_tolowercase_convert_the_entire_string_to_lowercase_replace_b_w_g_function_match_return_match_touppercase_capitalize_the_first_letter_of_each_word_function_convertimagetags_content_regular_expression_to_match')s and exi18n.t('ui_tags_and_extract_base64_content_const_imagetagregex'))<\/imai18n.t('ui_');

  // Ri18n.t('ui_g_replace')s with <i18n.t('ui_tags_with')with bi18n.t('ui_tags_with_base64_source_const_updatedcontent_content_replace_imagetagregex_match_base64content_return')18n.t('ui_data_image_jpeg_base64_base64content')"i18n.t('ui_alt')"i18n.t('ui_image_attachment')"i18n.t('ui_style')"i18n.t('ui_max_widti18n.t('ui_return_updatedcontent_function_converthtml_str_if_typeof_str_string_str_json_stringify_str_null_2_let_result_escapehtml_str_result_convertimagetags_result_result_convertpathstolinks_result_return_result_function_mapimgurl_val_try_const_raw_string_val_slice_img_length_const_id_raw_replace_attachment_att_att_if_id_looks_like_uuid_map_to_attachments_endpoint_if_0_9a_fa_f_32_36_test_id_return_v1_attachments_id_fallback_do_not_attempt_prior_pathing_return_as_is_to_prevent_404_noise_return_v1_attachments_encodeuricomponent_id_catch_return_function_convertimgfilepaths_str_return_str_replace_img_s_g_m_p1_v1_attachments_p1_export_function_converticons_str_return_str_replace_icon_a_za_z0_9_g')an class="i18n.t('ui_i18n_t_ui_icon_material_symbols_oui18n_t_ui_1_ined')"i18n.t('ui_function_escapehtml_str_const_escapechars_amp')('ui_')"i18n.t('ui_amp')"i18ni18n.t('ui_gt_39_quot_return_str_replace')')i18n.t('ui_g_char_escapechars_char_function_convertpathstolinks_str_function_generatelinks_match_const_parts_match_split_if_parts_0_parts_shift_drop_empty_element_left_of_first_let_conc_let_html_for_const_part_of_parts_conc_part_html')18n.t('ui_for_const_part_of_parts_conc')"/"i18n.t('ui_i18n_t_ui_part_html_ai18n_t_ui_part')"#"ii18n.t('ui_return_html_const_prefix_n_39_quot_const_folder_a_za_z0_9_const_file_a_za_z0_9_const_suffix')der = `[a-zA-Z0-9_\\/.\\-]`;
  const file = `[a-zA-Z0-9_\\-\\/]`;
  const suffix = `(?<!\\.)`;
  const pathRegex = new RegExp(
    `(?<=${prefix})\\/${folder}*${file}${suffixi18n.t('ui_const_tagregex')ui_skip_i18n.t('ui_g_return_str_split_tagregex_keep_tags_text_separate_map_chunk_if_it_starts_with')ep_tags_text_separi18n.t('ui_leave_untouched_if_chunk_startswith')eave_untouched_if_chunk_startswith')"<"i18n.t('ui_i18n_t_ui_return_chunk_otherwise_run_your_link_generation_return_chunk_replace_pathregex_generatelinks_join')""i18n.t('ui_i18n_t_ui_function_adjustmarkdownrender_element_find_all_tables_in_the_element_const_elements_element_queryselectorall')"table"i18n.t('ui_wrap_each_with_a_div_with_class_message_markdown_table_wrap_elements_foreachi18n.t('ui_const_wrapper_document_createelement_div_wrapper_classname_message_markdown_table_wrap_el_parentnode_insertbefore_wrapper_el_wrapper_appendchild_el_class_scroller_constructor_element_this_element_element_this_wasatbottom_this_isatbottom_isatbottom_tolerance_10_const_scrollheight_this_element_scrollheight_const_clientheight_this_element_clientheight_const_distancefrombottom_scrollheight_this_element_scrolltop_clientheight_return_distancefrombottom')<= tolerance;
  }

  reApplyScroll() {
    if (this.wasAtBottom) this.element.scrollTop = this.element.scrollHeight;
  }
}