import { pipeline, read_audio } from 'i18n.t('ui_i18n_t')'ui_transformers_3_0_2_js')'i18n.t('ui_import_updatechatinput_sendmessage_from')'i18n.t('i18n.t('ui_index_js')')'i18n.t('ui_const_microphonebutton_document_getelementbyid')'i18n.t('i18n.t('ui_microphone_button')')'i18n.t('ui_let_microphoneinput_null_let_isprocessingclick_false_const_status_inactive')'i18n.t('i18n.t('ui_inactive')')'i18n.t('ui_activating')'i18n.t('i18n.t('ui_activating')')'i18n.t('ui_listening')'i18n.t('i18n.t('ui_listening')')'i18n.t('ui_recording')'i18n.t('i18n.t('ui_recording')')'i18n.t('ui_waiting')'i18n.t('i18n.t('ui_waiting')')'i18n.t('ui_processing')'i18n.t('i18n.t('ui_processini18n.t('ui_mic_status_changed_from_oldstatus_to_newstatus')pdatecallback_options_this_mediarecorder_null_this_audiochunks_this_li18n.t('ui_mic_oldstatus_tolowercase')pdatecallback_this_messagesent_false_audio_ai18n.t('ui_mic_newstatus_tolowercase')ontext_null_this_mediastreamsource_null_this_analysernode_null_this_status_status_inactive_i18n_t')'ui_mic_status_changed_from_oldstatus_to_newstatus'i18n.t('ui_ll_this_waitingtimer_null_this_silencestarttime_i18n_t')'ui_mic_oldstatus_tolowercase'i18n.t('ui_recording_false_this_analysisframi18n_t')'ui_mic_newstatus_tolowercase'i18n.t('ui_s_modelsize')'i18n.t('i18n.t('ui_tiny')')'i18n.t('ui_language')'i18n.t('i18n.t('ui_en')')'i18n.t('ui_silencethreshold_0_15_silenceduration_1000_waitingtimeout_2000_minspeechduration_500_options_get_status_return_this_status_set_status_newstatus_if_this_status_newstatus_return_const_oldstatus_this_status_this_status_newstatus_console_log_mic_status_changed_from_oldstatus_to_newstatus_update_ui_microphonebutton_classlist_remove_mic_oldstatus_tolowercase_microphonebutton_classlist_add_mic_newstatus_tolowercase_microphonebutton_setattribute')'i18n.t('i18n.t('ui_data_status')')'i18n.t('ui_newstatus_handle_state_specific_behaviors_this_handlestatuschange_oldstatus_newstatus_handlestatuschange_oldstatus_newstatus_last_chunk_kept_only_for_transition_to_recording_status_if_newstatus_status_recording_this_lastchunk_null_switch_newstatus_case_status_inactive_this_handleinactivestate_break_case_status_listening_this_handlelisteningstate_break_case_status_recording_this_handlerecordingstate_break_case_status_waiting_this_handlewaitingstate_break_case_status_processing_this_handleprocessingstate_break_handleinactivestate_this_stoprecording_this_stopaudioanalysis_if_this_waitingtimer_cleartimeout_this_waitingtimer_this_waitingtimer_null_handlelisteningstate_this_stoprecording_i18n_t')'ui_i18n_t_ui_i18n_t_ui_if_this_status_status_waiting_this_status_status_processing_this_options_waitingtimeout_handleprocessingstate_this_stoprecording_this_process_stoprecording_if_this_mediarecorder_state_recording_this_mediarecorder_stop_this_hasstartedrecording_false_async_initialize_try_this_transcriber_await_pipeline_automatic_speech_recognition_xenova_whisper_this_options_modelsize_this_options_language_const_stream_await_navigator_mediadevices_getusermedia_audio_echocancellation_true_noisesuppression_true_channelcount_1_this_mediarecorder_new_mediarecorder_stream_this_mediarecorder_ondataavailable_event_if_event_data_size_0_this_status_status_recording_this_status_status_waiting_if_this_lastchunk_this_audiochunks_push_this_lastchunk_this_lastchunk_null_this_audiochunks_push_event_data_console_log_audio_chunk_received_total_chunks_this_audiochunks_length_else_if_this_status_status_listening_this_lastchunk_event_data_this_setupaudioanalysis_stream_return_true_catch_error_console_error_microphone_initialization_error_error_window_toastfrontenderror_failed_to_access_microphone_please_check_permissions_microphone_error_return_false_setupaudioanalysis_stream_this_audiocontext_new_window_audiocontext_window_webkitaudiocontext_this_mediastreamsource_this_audiocontext_createmediastreamsource_stream_this_analysernode_this_audiocontext_createanalyser_this_analysernode_fftsize_2048_this_analysernode_mindecibels_90_this_analysernode_maxdecibels_10_this_analysernode_smoothingtimeconstant_0_85_this_mediastreamsource_connect_this_analysernode_startaudioanalysis_const_analyzeframe_if_this_status_status_inactive_return_const_dataarray_new_uint8array_this_analysernode_fftsize_this_analysernode_getbytetimedomaindata_dataarray_calculate_rms_volume_let_sum_0_for_let_i_0_i'i18n.t('ui_rror_window_toastfrontenderror_failed_to_access_microphone_please_check_permissions_microphone_error_return_false_setupaudioanalysis_stream_this_audiocontext_new_window_audiocontext_window_webkitaudiocontext_this_mediastreamsource_this_audiocontext_createmediastreamsource_stream_this_analysernode_this_audiocontext_createanalyser_this_analysernode_fftsize_2048_this_analysernode_mindecibels_90_this_analysernode_maxdecibels_10_this_analysernode_smoothingtimeconstant_0_85_this_mediastreamsource_connect_this_analysernode_startaudioanalysis_const_analyzeframe_if_this_status_status_inactive_return_const_dataarray_new_uint8array_this_analysernode_fftsize_this_analysernode_getbytetimedomaindata_dataarray_calculate_rms_volume_let_sum_0_for_let_i_0_i')'i18n.t('i18n.t('ui_dataarray_length_i_const_amplitude_dataarray_i_128_128_sum_amplitude_amplitude_const_rms_math_sqrt_sum_dataarray_length_const_now_date_now_update_status_based_on_audio_level_if_rms_this_options_silencethreshold_this_lastaudiotime_now_this_silencestarttime_null_if_this_status_status_listening_this_status_status_waiting_if_speech_isspeaking_todo_a_better_way_to_ignore_agent')')'i18n.t('ui_s_voice_this_status_status_recording_else_if_this_status_status_recording_if_this_silencestarttime_this_silencestarttime_now_const_silenceduration_now_this_silencestarttime_if_silenceduration_this_options_silenceduration_this_status_status_waiting_this_analysisframe_requestanimationframe_analyzeframe_this_analysisframe_requestanimationframe_analyzeframe_stopaudioanalysis_if_this_analysisframe_cancelanimationframe_this_analysisframe_this_analysisframe_null_async_process_if_this_audiochunks_length_0_this_status_status_listening_return_const_audioblob_new_blob_this_audiochunks_type')'i18n.t('i18n.t('ui_audio_wav')')'i18n.t('ui_const_audiourl_url_createobjecturl_audioblob_try_const_samplingrate_16000_const_audiodata_await_read_audio_audiourl_samplingrate_const_result_await_this_transcriber_audiodata_const_text_this_filterresult_result_text_if_text_console_log')'i18n.t('i18n.t('ui_transcription')')'i18n.t('ui_result_text_await_this_updatecallback_result_text_true_catch_error_console_error')'i18n.t('i18n.t('ui_transcription_error')')'i18n.t('ui_error_window_toastfrontenderror')'i18n.t('i18n.t('ui_transcription_failed')')'i18n.t('ui_')'i18n.t('i18n.t('ui_speech_recognition_erri18n_t')'ui_discarding_transcription_text'i18n.t('ui_url_revokeobjecturl_audiourl_this_audiochunks_this_status_status_listening_filterresult_text_text_text_trim_let_ok_false_while_ok_if_text_break_if_text_0')'{'i18n.t('ui_i18n_t')'ui_text_text_length_1')'}'i18n.t('ui_i18n_t')'ui_break_if_text_0')'('i18n.t('ui_i18n_t')'ui_text_text_length_1')')'i18n.t('ui_i18n_t')'ui_break_if_text_0')'['i18n.t('ui_i18n_t')'ui_text_text_length_1')']'i18n.t('ui_i18n_t')'ui_break_ok_true_if_ok_return_text_else_console_log_discarding_transcription_text_initialize_and_handle_click_events_async_function_initializemicrophoneinput_microphoneinput_new_microphoneinput_async_text_isfinal_if_isfinal_updatechatinput_text_if_microphoneinput_messagesent_microphoneinput_messagesent_true_await_sendmessage_modelsize')'i18n.t('ui_tiny')'i18n.t('i18n.t('ui_language')')'i18n.t('ui_en')'i18n.t('i18n.t('ui_silencethreshold_0_07_silenceduration_1000_waitingtimeout_1500_microphoneinput_status_status_activating_return_await_microphoneinput_initialize_microphonebutton_addeventlistener')')'i18n.t('ui_click')'i18n.t('i18n.t('ui_async_if_isprocessingclick_return_isprocessingclick_true_const_haspermission_await_requestmicrophonepermission_if_haspermission_return_try_if_microphoneinput_await_initializemicrophoneinput_return_simply_toggle_between_inactive_and_listening_states_microphoneinput_status_microphoneinput_status_status_inactive_microphoneinput_status_status_activating_status_listening_status_inactive_finally_settimeout_isprocessingclick_false_300_some_error_handling_for_microphone_input_async_function_requestmicrophonepermission_try_await_navigator_mediadevices_getusermedia_audio_true_return_true_catch_err_console_error')')'i18n.t('ui_error_accessing_microphone')'i18n.t('i18n.t('ui_err_window_toastfrontenderror')')'i18n.t('ui_microphone_access_denied_please_enable_microphone_access_in_your_browser_settings')'i18n.t('i18n.t('ui_ui')')'i18n.t('ui_microphone_error')');
        return false;
    }
}


class Speech {
    constructor() {
        this.synth = window.speechSynthesis;
        this.utterance = null;
    }

    stripEmojis(str) {
        return str
            .replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '')
            .replace(/\s+/g, ' 'i18n.t('ui_i18n_t')'ui_trim_speak_text_console_log')'i18n.t('ui_speaking')', text);
        // Stop any current utterance
        this.stop();

        // Remove emojis and create a new utterance
        text = this.stripEmojis(text);
        this.utterance = new SpeechSynthesisUtterance(text);

        // Speak the new utterance
        this.synth.speak(this.utterance);
    }

    stop() {
        if (this.isSpeaking()) {
            this.synth.cancel();
        }
    }

    isSpeaking() {
        return this.synth?.speaking || false;
    }
}

export const speech = new Speech();
window.speech = speech
