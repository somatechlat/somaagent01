/**
 * REAL IMPLEMENTATION - System Monitoring Integration for SomaAgent01 Web UI
 * Integrates degradation, circuit breaker, and metrics endpoints with the Web UI
 * VIBE CODING RULES COMPLIANT - No placeholders, real implementations only
 */

import { fetchApi, callJsonApi } from "i18n.t('ui_i18n_t_i18n.t('ui_i18n_t_ui_api_js')')";

class SystemMonitor {
    constructor() {
        this.pollingInterval = null;
        this.pollingActive = false;
        this.healthStatus = null;
        this.degradationStatus = null;
        this.circuitStatus = null;
        this.metricsData = null;
        this.systemMetrics = null;
        this.lastUpdate = null;
        this.callbacks = new Set();
        this.errorCount = 0;
        this.maxRetries = 3;
        this.retryDelay = 5000;
        this.circuitMonitoringEnabled = true;
        this._circuitErrorNotified = false;
    }

    /**
     * Start monitoring the system
     * @param {number} interval - Polling interval in milliseconds (default: 30000)
     */
    startMonitoring(interval = 30000) {
        if (this.pollingActive) return;
        
        this.pollingActive = true;
        this.pollingInterval = setInterval(() => i18n.t('i18n.t('ui_i18n_t_ui_this_updateallstatus_interval_initial_update_this_updateallstatus_real_implementation_check_somabrain_health_directly_async_checksomabrainhealth_try_const_response_await_fetch_http_localhost_9696_health_method_get_headers_content_type_application_json_if_response_ok_const_somabraindata_await_response_json_update_somabrain_store_based_on_somabrain_health_if_globalthis_alpine_store_somabrain_const_somabrainstore_globalthis_alpine_store_somabrain_if_somabraindata_ready_true_somabrainstore_state_normal_somabrainstore_tooltip_somabrain_online_somabrainstore_banner_else_somabrainstore_state_degraded_somabrainstore_tooltip_somabrain_degraded_limited_memory_retrieval_somabrainstore_banner_somabrain_responses_are_delayed_retrieval_snippets_will_be_limited_until_connectivity_stabilizes_somabrainstore_lastupdated_date_now_return_somabraindata_else_throw_new_error_somabrain_health_check_failed_response_status_catch_error_console_error_error_checking_somabrain_health_error_update_somabrain_store_to_reflect_error_if_globalthis_alpine_store_somabrain_const_somabrainstore_globalthis_alpine_store_somabrain_somabrainstore_state_down_somabrainstore_tooltip_somabrain_offline_degraded_mode_somabrainstore_banner_somabrain_is_offline_the_agent_will_answer_using_chat_history_only_until_memories_sync_again_somabrainstore_lastupdated_date_now_return_null_stop_monitoring_the_system_stopmonitoring_if_this_pollingactive_return_this_pollingactive_false_if_this_pollinginterval_clearinterval_this_pollinginterval_this_pollinginterval_null_add_a_callback_to_be_called_when_monitoring_data_updates_param_function_callback_callback_function_addcallback_callback_this_callbacks_add_callback_remove_a_callback_param_function_callback_callback_function_to_remove_removecallback_callback_this_callbacks_delete_callback_notify_all_callbacks_of_data_updates_notifycallbacks_this_callbacks_foreach_callback_try_callback_health_this_healthstatus_degradation_this_degradationstatus_circuit_this_circuitstatus_metrics_this_metricsdata_lastupdate_this_lastupdate_catch_e_console_error_error_in_monitoring_callback_e_real_implementation_update_all_monitoring_status_with_comprehensive_error_handling_async_updateallstatus_try_await_promise_all_this_updatehealthstatus_this_updatedegradationstatus_this_updatecircuitstatus_this_updatesystemmetrics_this_checksomabrainhealth_this_lastupdate_new_date_this_errorcount_0_reset_error_count_on_success_this_notifycallbacks_catch_error_console_error_error_updating_monitoring_status_error_this_errorcount_implement_retry_logic_with_exponential_backoff_if_this_errorcount')')<= this.maxRetries) {
                const delay = this.retryDelay * Math.pow(2, this.errorCount - 1);
                console.log(`Retrying in ${delay}ms (attempt ${this.errorCount}/${this.maxRetries})`);
                setTimeout(() => this.updateAllStatus(), delay);
            } else {
                console.error('i18n.t('ui_max_retries_reached_stopping_monitoring_updates')');
                this.stopMonitoring();
            }
        }
    }

    /**
     * REAL IMPLEMENTATION - Update system health status using the /v1/health endpoint
     */
    async updateHealthStatus() {
        try {
            const response = await fetchApi('i18n.t('ui_v1_health')');
            if (response.ok) {
                const healthData = await response.json();
                this.healthStatus = {
                    ...healthData,
                    timestamp: new Date().toISOString()
                };
                
                // Update somabrain store based on health status
                if (globalThis.Alpine?.store('i18n.t('ui_somabrain')')) {
                    const somabrainStore = globalThis.Alpine.store('i18n.t('ui_somabrain')');
                    if (healthData.status === 'i18n.t('ui_ok')') {
                        somabrainStore.state = 'i18n.t('ui_normal')';
                        somabrainStore.tooltip = 'i18n.t('ui_somabrain_online')';
                        somabrainStore.banner = ''i18n.t('ui_else_if_healthdata_status')'degraded'i18n.t('ui_somabrainstore_state')'degraded'i18n.t('ui_somabrainstore_tooltip')'SomaBrain degraded – limited memory retrieval'i18n.t('ui_somabrainstore_banner')'Somabrain responses are delayed. Retrieval snippets will be limited until connectivity stabilizes.'i18n.t('ui_else_somabrainstore_state')'down'i18n.t('ui_somabrainstore_tooltip')'SomaBrain offline – degraded mode'i18n.t('ui_somabrainstore_banner')'Somabrain is offline. The agent will answer using chat history only until memories sync again.'i18n.t('ui_somabrainstore_lastupdated_date_now_else_console_error')'Health status request failed:'i18n.t('ui_response_status_this_healthstatus_error')'Failed to fetch health status'i18n.t('ui_status')'error'i18n.t('ui_timestamp_new_date_toisostring_update_somabrain_store_to_reflect_error_if_globalthis_alpine_store')'somabrain'i18n.t('ui_const_somabrainstore_globalthis_alpine_store')'somabrain'i18n.t('ui_somabrainstore_state')'unknown'i18n.t('ui_somabrainstore_tooltip')'SomaBrain status unknown'i18n.t('ui_somabrainstore_banner')'SomaBrain status is unknown. We will keep retrying automatically.'i18n.t('ui_somabrainstore_lastupdated_date_now_catch_error_console_error')'Error fetching health status:'i18n.t('ui_error_this_healthstatus_error')'Failed to fetch health status'i18n.t('ui_status')'error'i18n.t('ui_timestamp_new_date_toisostring_update_somabrain_store_to_reflect_error_if_globalthis_alpine_store')'somabrain'i18n.t('ui_const_somabrainstore_globalthis_alpine_store')'somabrain'i18n.t('ui_somabrainstore_state')'unknown'i18n.t('ui_somabrainstore_tooltip')'SomaBrain status unknown'i18n.t('ui_somabrainstore_banner')'SomaBrain status is unknown. We will keep retrying automatically.'i18n.t('ui_somabrainstore_lastupdated_date_now_real_implementation_update_degradation_status_using_the_v1_degradation_status_endpoint_async_updatedegradationstatus_try_const_response_await_fetchapi')'/v1/degradation/status'i18n.t('ui_if_response_ok_const_degradationdata_await_response_json_this_degradationstatus_degradationdata_timestamp_new_date_toisostring_else_console_error')'Degradation status request failed:'i18n.t('ui_response_status_this_degradationstatus_error')'Failed to fetch degradation status'i18n.t('ui_overall_level')'unknown'i18n.t('ui_timestamp_new_date_toisostring_catch_error_console_error')'Error fetching degradation status:'i18n.t('ui_error_this_degradationstatus_error')'Failed to fetch degradation status'i18n.t('ui_overall_level')'unknown'i18n.t('ui_timestamp_new_date_toisostring_real_implementation_update_circuit_breaker_status_using_the_v1_circuit_status_endpoint_async_updatecircuitstatus_if_this_circuitmonitoringenabled_return_try_const_response_await_fetchapi')'/v1/circuit/status'i18n.t('ui_if_response_ok_const_circuitdata_await_response_json_this_circuitstatus_circuitdata_timestamp_new_date_toisostring_this_circuiterrornotified_false_else_if_this_circuiterrornotified_console_warn')'Circuit status request failed:'i18n.t('ui_response_status_this_circuiterrornotified_true_this_circuitstatus_error')'Failed to fetch circuit status'i18n.t('ui_circuits_overall_status')'unknown'i18n.t('ui_timestamp_new_date_toisostring_if_response_status_500_this_circuitmonitoringenabled_false_catch_error_if_this_circuiterrornotified_console_warn')'Error fetching circuit status:'i18n.t('ui_error_this_circuiterrornotified_true_this_circuitstatus_error')'Failed to fetch circuit status'i18n.t('ui_circuits_overall_status')'unknown'i18n.t('ui_timestamp_new_date_toisostring_this_circuitmonitoringenabled_false_real_implementation_update_system_metrics_using_the_v1_metrics_system_endpoint_async_updatesystemmetrics_try_const_response_await_fetchapi')'/v1/metrics/system'i18n.t('ui_if_response_ok_const_metricsdata_await_response_json_this_systemmetrics_metricsdata_timestamp_new_date_toisostring_update_metricsdata_for_backward_compatibility_this_metricsdata_system_status_this_healthstatus_status')'unknown'i18n.t('ui_cpu_percent_metricsdata_cpu_percent_memory_percent_metricsdata_memory_percent_disk_percent_metricsdata_disk_percent_components_object_keys_this_healthstatus_components_length_healthy_components_object_values_this_healthstatus_components_filter_c_c_status')'ok'i18n.t('ui_length_timestamp_new_date_toisostring_else_console_error')'System metrics request failed:'i18n.t('ui_response_status_this_systemmetrics_error')'Failed to fetch system metrics'i18n.t('ui_timestamp_new_date_toisostring_this_metricsdata_error')'Failed to fetch system metrics'i18n.t('ui_timestamp_new_date_toisostring_catch_error_console_error')'Error fetching system metrics:'i18n.t('ui_error_this_systemmetrics_error')'Failed to fetch system metrics'i18n.t('ui_timestamp_new_date_toisostring_this_metricsdata_error')'Failed to fetch system metrics'i18n.t('ui_timestamp_new_date_toisostring_get_current_degradation_status_getdegradationstatus_return_this_degradationstatus_get_current_circuit_breaker_status_getcircuitstatus_return_this_circuitstatus_real_implementation_get_current_metrics_data_getmetricsdata_return_this_metricsdata_real_implementation_get_detailed_system_metrics_getsystemmetrics_return_this_systemmetrics_real_implementation_get_degradation_analysis_with_actionable_insights_getdegradationanalysis_if_this_degradationstatus_this_degradationstatus_error_return_error')'Degradation data not available'i18n.t('ui_level')'unknown'i18n.t('ui_actionable_false_const_level_this_degradationstatus_overall_level_const_affectedcount_this_degradationstatus_affected_components_length_const_totalcount_this_degradationstatus_total_components_const_healthpercentage_totalcount_0_totalcount_affectedcount_totalcount_100_tofixed_1_0_return_level_level_severity_this_getdegradationseverity_level_affectedcount_affectedcount_totalcount_totalcount_healthpercentage_parsefloat_healthpercentage_actionable_affectedcount_0_recommendations_this_degradationstatus_recommendations_mitigationactions_this_degradationstatus_mitigation_actions_affectedcomponents_this_degradationstatus_affected_components_healthycomponents_this_degradationstatus_healthy_components_timestamp_this_degradationstatus_timestamp_real_implementation_get_circuit_breaker_analysis_getcircuitanalysis_if_this_circuitstatus_this_circuitstatus_erri18n.t('ui_name_is_down')')'Circuit breaker data not available'i18n.t('ui_overallstatus')'unknown'i18n.t('ui_circuits_const_circuits_object_entries_this_circuitstatus_circuits_map_name_circuit_name_name_state_circuit_state_failurerate_circuit_failure_rate_0_lastfailure_circuit_last_failure_time_null_requests_circuit_requests_0_failures_circuit_failures_0_consecutivefailures_circuit_consei18n.t('ui_name_is_degraded')onst_opencircuits_circuits_filter_c_c_state')'OPEN'i18n.t('ui_length_const_halfopencircuits_circuits_filter_c_c_state')'HALF_OPEN'i18n.t('ui_length_const_closedcircuits_circuits_filter_c_c_state')'CLOSED'i18n.t('ui_length_return_overallstatus_this_circuitstatus_overall_status_totalcircuits_circuits_length_opencircuits_opencircuits_halfopencircuits_halfopencircuits_closedcircuits_closedcircuits_circuits_circuits_ishealthy_opencircuits_0_timestamp_this_circuitstatus_timestamp_real_implementation_get_resource_utilization_analysis_getresourceanalysis_if_this_systemmetrics_this_systemmetrics_error_return_error')'System metrics not available'i18n.t('ui_status')'unknown'i18n.t('ui_const_cpu_memory_disk_this_systemmetrics_return_cpu_percent_cpu_percent_status_this_getresourcestatus_cpu_percent_count_cpu_count_countlogical_cpu_count_logical_memory_percent_memory_percent_status_this_getresourcestatus_memory_percent_total_memory_total_used_memory_used_available_memory_available_free_memory_free_disk_percent_disk_percent_status_this_getresourcestatus_disk_percent_total_disk_total_used_disk_used_free_disk_free_process_memoryrss_this_systemmetrics_process_memory_rss_memoryvms_this_systemmetrics_process_memory_vms_cpupercent_this_systemmetrics_process_cpu_percent_threads_this_systemmetrics_process_threads_openfiles_this_systemmetrics_process_open_files_overallstatus_this_getoverallresourcestatus_timestamp_this_systemmetrics_timestamp_real_implementation_helper_method_to_get_degradation_severity_getdegradationseverity_level_const_severitymap')'none'i18n.t('ui_')'healthy'i18n.t('ui_')'minor'i18n.t('ui_')'low'i18n.t('ui_')'moderate'i18n.t('ui_')'medium'i18n.t('ui_')'severe'i18n.t('ui_')'high'i18n.t('ui_')'critical'i18n.t('ui_')'critical'i18n.t('ui_return_severitymap_level')'unknown'i18n.t('ui_real_implementation_helper_method_to_get_resource_status_getresourcestatus_percent_if_percent_90_return')'critical'i18n.t('ui_if_percent_80_return')'warning'i18n.t('ui_if_percent_70_return')'elevated'i18n.t('ui_return')'normal'i18n.t('ui_real_implementation_helper_method_to_get_overall_resource_status_getoverallresourcestatus_if_this_systemmetrics_this_systemmetrics_error_return')'unknown'i18n.t('ui_const_cpu_memory_disk_this_systemmetrics_const_maxusage_math_max_cpu_percent_memory_percent_disk_percent_if_maxusage_90_return')'critical'i18n.t('ui_if_maxusage_80_return')'warning'i18n.t('ui_if_maxusage_70_return')'elevated'i18n.t('ui_return')'normal'i18n.t('ui_real_implementation_get_comprehensive_system_health_summary_with_degradation_analysis_gethealthsummary_const_issues_let_overallstatus')'unknown'i18n.t('ui_analyze_health_status_if_this_healthstatus_this_healthstatus_error_overallstatus_this_healthstatus_status_check_overall_system_status_if_this_healthstatus_status')'down'i18n.t('ui_issues_push_type')'system'i18n.t('ui_level')'critical'i18n.t('ui_message')'System is down'i18n.t('ui_source')'health'i18n.t('ui_else_if_this_i18n.t('ui_name_circuit_breaker_is_open')i18n.t('ui_issues_push_type')'system'i18n.t('ui_level')'warning'i18n.t('ui_message')'Syi18n.t('ui_circuit_is_open_blocking_requests_to_name')18n.t('ui_check_individual_componenti18n.t('ui_i18n_t_ui_i18n_t_ui_this_updateallstatus_interval_initial_update_this_updateallstatus_real_implementation_check_somabrain_health_directly_async_checksomabrainhealth_try_const_response_await_fetch_http_localhost_9696_health_method_get_headers_content_type_application_json_if_response_ok_const_somabraindata_await_response_json_update_somabrain_store_based_on_somabrain_health_if_globalthis_alpine_store_somabrain_const_somabrainstore_globalthis_alpine_store_somabrain_if_somabraindata_ready_true_somabrainstore_state_normal_somabrainstore_tooltip_somabrain_online_somabrainstore_banner_else_somabrainstore_state_degraded_somabrainstore_tooltip_somabrain_degraded_limited_memory_retrieval_somabrainstore_banner_somabrain_responses_are_delayed_retrieval_snippets_will_be_limited_until_connectivity_stabilizes_somabrainstore_lastupdated_date_now_return_somabraindata_else_throw_new_error_somabrain_health_check_failed_response_status_catch_error_console_error_error_checking_somabrain_health_error_update_somabrain_store_to_reflect_error_if_globalthis_alpine_store_somabrain_const_somabrainstore_globalthis_alpine_store_somabrain_somabrainstore_state_down_somabrainstore_tooltip_somabrain_offline_degraded_mode_somabrainstore_banner_somabrain_is_offline_the_agent_will_answer_using_chat_history_only_until_memories_sync_again_somabrainstore_lastupdated_date_now_return_null_stop_monitoring_the_system_stopmonitoring_if_this_pollingactive_return_this_pollingactive_false_if_this_pollinginterval_clearinterval_this_pollinginterval_this_pollinginterval_null_add_a_callback_to_be_called_when_monitoring_data_updates_param_function_callback_callback_function_addcallback_callback_this_callbacks_add_callback_remove_a_callback_param_function_callback_callback_function_to_remove_removecallback_callback_this_callbacks_delete_callback_notify_all_callbacks_of_data_updates_notifycallbacks_this_callbacks_foreach_callback_try_callback_health_this_healthstatus_degradation_this_degradationstatus_circuit_this_circuitstatus_metrics_this_metricsdata_lastupdate_this_lastupdate_catch_e_console_error_error_in_monitoring_callback_e_real_implementation_update_all_monitoring_status_with_comprehensive_error_handling_async_updateallstatus_try_await_promise_all_this_updatehealthstatus_this_updatedegradationstatus_this_updatecircuitstatus_this_updatesystemmetrics_this_checksomabrainhealth_this_lastupdate_new_date_this_errorcount_0_reset_error_count_on_success_this_notifycallbacks_catch_error_console_error_error_updating_monitoring_status_error_this_errorcount_implement_retry_logic_with_exponential_backoff_if_this_errorcount')issues_push_i18n.t('ui_retrying_in_delay_ms_attempt_this_errorcount_this_maxretries')uit_breaker_is_half_open_source')'ciri18n.t('ui_high_disk_usage_disk_percent_tofixed_1')me_service_recovery_if_overallstatus')'ok'i18n.t('ui_overallstatus')'degraded'i18n.t('ui_analyze_system_metrics_if_this_systemmetrics_this_systemmetrics_error_const_cpu_memory_disk_this_systemmetrics_check_cpu_usage_if_cpu_percent_90_issues_push_type')'resource'i18n.t('ui_level')'critical'i18n.t('ui_message_high_cpu_usage_cpu_percent_tofixed_1_source')'metrics'i18n.t('ui_detail')'Systi18n.t('ui_high_disk_usage_disk_percent_tofixed_1')('ui_if_overallstatus')'ok'i18n.t('ui_overallstatus')'degraded'i18n.t('ui_else_if_cpu_percent_80_issues_push_type')'resource'i18n.t('ui_level')'warning'i18n.t('ui_message_high_cpu_usage_cpu_percent_tofixed_1_source')'metrics'i18n.t('ui_detail')'System CPU utilization is elevated'i18n.t('ui_check_memory_usage_if_memory_percent_90_issues_push_type')'resource'i18n.t('ui_level')'critical'i18n.t('ui_message_high_memory_usage_memory_percent_tofixed_1_source')'metrics'i18n.t('ui_detail')'System memory utilization is critically high'i18n.t('ui_if_overallstatus')'ok'i18n.t('ui_overallstatus')'degraded'i18n.t('ui_else_if_memory_percent_80_issues_push_type')'resource'i18n.t('ui_level')'warning'i18n.t('ui_message_high_memory_usage_memory_percent_tofixed_1_source')'metrics'i18n.t('ui_detail')'System memory utilization is elevated'i18n.t('ui_check_disk_usage_if_disk_percent_90_issues_push_type')'resource'i18n.t('ui_level')'critical'i18n.t('ui_message_high_disk_usage_disk_percent_tofixed_1_source')'metrics'i18n.t('ui_detail')'System disk utilization is critically high'i18n.t('ui_if_overallstatus')'ok'i18n.t('ui_overallstatus')'degraded'i18n.t('ui_else_if_disk_percent_80_issues_push_type')'resource'i18n.t('ui_level')'warning'i18n.t('ui_message_high_disk_usage_disk_percent_tofixed_1_source')'metrics'i18n.t('ui_detail')'System disk utilization is elevated'i18n.t('ui_sort_issues_by_severity_const_severityorder_critical_0_warning_1_info_2_issues_sort_a_b_severityorder_a_level_severityorder_b_level_return_healthy_overallstatus')'ok'i18n.t('ui_overallstatus_overallstatus_degradationlevel_this_degradationstatus_overall_level')'unknown'i18n.t('ui_issues_issues_affectedcomponents_this_degradationstatus_affected_components_healthycomponents_this_degradationstatus_healthy_components_totalcomponents_this_degradationstatus_total_components_0_recommendations_this_degradationstatus_recommendations_mitigationactions_this_degradationstatus_mitigation_actions_systemmetrics_this_systemmetrics_lastupdate_this_lastupdate_create_global_instance_const_systemmonitor_new_systemmonitor_export_for_use_in_other_modules_export_systemmonitor_systemmonitor_auto_start_monitoring_when_dom_is_ready_and_alpine_is_initialized_if_typeof_window')'undefined'i18n.t('ui_document_addeventlistener')'DOMContentLoaded'i18n.t('ui_wait_for_alpine_to_be_initialized_before_starting_monitoring_const_waitforalpine_setinterval_if_window_alpine_window_alpine_store_window_alpine_store')'monitoring'i18n.t('ui_clearinterval_waitforalpine_get_the_monitoring_store_const_monitoringstore_window_alpine_store')'monitoring'i18n.t('ui_add_callback_to_update_alpine_store_systemmonitor_addcallback_data_update_the_monitoring_store_with_comprehensive_data_monitoringstore_degradation_data_degradation_monitoringstore_circuit_data_circuit_monitoringstore_metrics_data_metrics_monitoringstore_healthsummary_systemmonitor_gethealthsummary_monitoringstore_lastupdate_data_lastupdate_update_detailed_analysis_data_monitoringstore_healthstatus_monitoringstore_healthsummary_overallstatus')'unknown'i18n.t('ui_monitoringstore_degradationlevel_data_degradation_overall_level')'none'i18n.t('ui_monitoringstore_circuitbreakerstatus_data_circuit_overall_status')'unknown'i18n.t('ui_monitoringstore_systemmetrics_cpu_systemmonitor_getsystemmetrics_cpu_percent_0_memory_systemmonitor_getsystemmetrics_memory_percent_0_disk_systemmonitor_getsystemmetrics_disk_percent_0_monitoringstore_healthsummary_monitoringstore_healthsummary_healthy_0_degraded_0_critical_0_monitoringstore_degradationanalysis_systemmonitor_getdegradationanalysis_monitoringstore_circuitanalysis_systemmonitor_getcircuitanalysis_monitoringstore_resourceanalysis_systemmonitor_getresourceanalysis_start_monitoring_with_30_second_intervals_systemmonitor_startmonitoring_30000_console_log')'✅ Degradation monitoring started successfully'i18n.t('ui_100_timeout_after_5_seconds_settimeout_clearinterval_waitforalpine_console_warn')'⚠️ Alpine store not found, starting monitoring anyway');
            systemMonitor.startMonitoring(30000);
        }, 5000);
    });
}
