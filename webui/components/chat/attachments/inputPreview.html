<script type="module">
    import { store } from "/components/chat/attachments/attachmentsStore.js";
</script>

<div x-data>
    <template x-if="$store.chatAttachments">

        <div x-show="$store.chatAttachments.hasAttachments" class="preview-section">
            <template x-for="(attachment, index) in $store.chatAttachments.attachments" :key="index">
                <div class="attachment-item"
                    :class="{'image-type': attachment.type === 'image', 'file-type': attachment.type === 'file'}">
                    <template x-if="attachment.type === 'image'">
                        <img :src="attachment.url" class="attachment-preview" :alt="attachment.name" style="cursor: pointer;"
                            @click="$store.chatAttachments.openImageModal(attachment.url, attachment.name)">
                    </template>
                    <template x-if="attachment.type === 'file'">
                        <div>
                            <img :src="attachment.displayInfo.previewUrl" class="file-icon" :alt="attachment.extension">
                            <span class="file-title" x-text="attachment.name"></span>
                        </div>
                    </template>
                    <!-- Progress/status overlay -->
                                        <div class="attachment-progress" x-show="attachment.uploading || (attachment.uploadedBytes && attachment.totalBytes) || attachment.status === 'quarantined' || attachment.status === 'error' || attachment.uploadError">
                        <template x-if="attachment.status === 'quarantined'">
                            <span class="status-badge status-quarantined" title="Blocked by antivirus">Quarantined</span>
                        </template>
                                                <template x-if="attachment.status !== 'quarantined'">
                            <div class="progress-bar">
                                <div class="progress-fill"
                                     :style="{
                                        width: (attachment.totalBytes ? Math.min(100, Math.round((attachment.uploadedBytes||0) * 100 / (attachment.totalBytes||1))) : (attachment.uploading ? 5 : 100)) + '%'
                                     }"></div>
                            </div>
                                                        <div class="progress-text">
                                                            <template x-if="attachment.status === 'error' || attachment.uploadError">
                                                                <span class="status-badge status-error">Upload failed</span>
                                                            </template>
                                                            <template x-if="!(attachment.status === 'error' || attachment.uploadError)">
                                                                <span x-text="
                                                                    (attachment.totalBytes && attachment.uploadedBytes >= 0)
                                                                        ? (Math.min(100, Math.round((attachment.uploadedBytes||0) * 100 / (attachment.totalBytes||1))) + '%')
                                                                        : (attachment.uploading ? 'Uploadingâ€¦' : 'Ready')
                                                                "></span>
                                                            </template>
                                                        </div>
                                                        <div class="progress-actions">
                                                            <button class="btn-cancel" x-show="attachment.uploading" @click="$store.chatAttachments.cancelAttachment(index)">Cancel</button>
                                                            <button class="btn-retry" x-show="attachment.status === 'error' || attachment.uploadError" @click="$store.chatAttachments.retryAttachment(index)">Retry</button>
                                                        </div>
                        </template>
                    </div>
                    <button @click="$store.chatAttachments.removeAttachment(index)"
                        class="remove-attachment">&times;</button>
                </div>
            </template>
        </div>

    </template>
</div>