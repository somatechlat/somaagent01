<script type="module">
    import { store } from "./attachmentsStore.js";
</script>

<div x-data>
    <template x-if="$store.chatAttachments">

        <div x-show="$store.chatAttachments.hasAttachments" class="preview-section">
            <template x-for="(attachment, index) in $store.chatAttachments.attachments" :key="index">
                <div class="attachment-item"
                    :class="{'image-type': (attachment.type === 'image') || (attachment.mime && attachment.mime.startsWith('image/')), 'file-type': !(attachment.type === 'image' || (attachment.mime && attachment.mime.startsWith('image/')))}">
                    <div class="attachment-header">
                        <span class="file-title" x-text="attachment.name || attachment.filename"></span>
                        <button @click="$store.chatAttachments.removeAttachment(index)" class="remove-attachment">&times;</button>
                    </div>
                    <template x-if="(attachment.type === 'image' && attachment.url) || (attachment.path && attachment.mime && attachment.mime.startsWith('image/'))">
                        <img :src="$store.chatAttachments.getAttachmentPreviewUrl(attachment)" class="attachment-preview" :alt="attachment.name || attachment.filename" style="cursor: pointer;"
                            @click="$store.chatAttachments.openImageModal($store.chatAttachments.getAttachmentPreviewUrl(attachment), attachment.name || attachment.filename)">
                    </template>
                    <template x-if="!(attachment.type === 'image') && !(attachment.mime && attachment.mime.startsWith('image/'))">
                        <div>
                            <img :src="$store.chatAttachments.getAttachmentDisplayInfo(attachment).previewUrl" class="file-icon" :alt="attachment.extension">
                        </div>
                    </template>
                    <div class="attachment-progress" x-show="attachment.status === 'uploading'">
                        <div class="progress-bar">
                            <div class="progress-fill" :style="{ width: ((attachment.progressBytes||0) / (attachment.totalBytes||1) * 100) + '%'}"></div>
                        </div>
                        <div class="progress-text">
                            <span x-text="Math.round(((attachment.progressBytes||0)/(attachment.totalBytes||1))*100) + '%' "></span>
                            <template x-if="attachment.speedBps">
                                <span class="speed" x-text="(attachment.speedBps/1024).toFixed(1) + ' KB/s'"></span>
                            </template>
                            <template x-if="attachment.etaSeconds && attachment.etaSeconds > 0">
                                <span class="eta" x-text="'ETA ' + Math.ceil(attachment.etaSeconds) + 's'"></span>
                            </template>
                        </div>
                    </div>
                    <div class="attachment-status" x-show="attachment.status === 'error'">
                        <span class="error-text">Upload failed</span>
                        <button class="btn btn-xs" @click="$store.chatAttachments.retryAttachment(attachment)">Retry</button>
                    </div>
                    <div class="attachment-resume" x-show="attachment.status === 'uploading' && attachment.progressBytes < attachment.totalBytes && sessionStorage.getItem('chunk-upload:' + ($store.chatAttachments.sessionId||'unspecified') + ':' + (attachment.name||attachment.filename) + ':' + (attachment.totalBytes||attachment.size))">
                        <button class="btn btn-xs" @click="$store.chatAttachments.resumeAttachment(attachment)">Resume</button>
                    </div>
                </div>
            </template>
        </div>

    </template>
</div>