<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Decision Receipts</title>
</head>
<body class="admin-decisions">
  <style>
    .decisions-toolbar { display: flex; gap: 8px; align-items: end; flex-wrap: wrap; margin-bottom: 12px; }
    .decisions-toolbar .field { display: flex; flex-direction: column; gap: 4px; }
    .decisions-toolbar input { padding: 6px 8px; min-width: 220px; }
    .decisions-toolbar button { padding: 8px 10px; }
    .decisions-table { width: 100%; border-collapse: collapse; }
    .decisions-table th, .decisions-table td { border-bottom: 1px solid var(--border-color, #333); padding: 8px; text-align: left; vertical-align: top; }
    .decisions-table th { position: sticky; top: 0; background: var(--bg-0, #111); z-index: 1; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .pill-allow { background: #12381f; color: #66e18c; border: 1px solid #1f6b39; }
    .pill-deny { background: #412325; color: #ff9aa2; border: 1px solid #6b1f2a; }
    .pill-skip { background: #2b2b2b; color: #bbb; border: 1px solid #444; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    .nowrap { white-space: nowrap; }
    details pre { max-height: 300px; overflow: auto; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px; }
    .footer-actions { margin-top: 12px; display: flex; gap: 8px; }
  </style>

  <div id="decisions-root">
    <div class="decisions-toolbar">
      <div class="field">
        <label>Tenant</label>
        <input id="filter-tenant" type="text" placeholder="tenant id (optional)">
      </div>
      <div class="field">
        <label>Session ID</label>
        <input id="filter-session" type="text" placeholder="session id (optional)">
      </div>
      <div class="field">
        <label>Request ID</label>
        <input id="filter-request" type="text" placeholder="request id (optional)">
      </div>
      <div class="field">
        <label>Subject</label>
        <input id="filter-subject" type="text" placeholder="subject (optional)">
      </div>
      <div class="field">
        <label>Limit</label>
        <input id="filter-limit" type="number" min="1" max="200" value="50">
      </div>
      <div class="field">
        <label>From</label>
        <input id="filter-from" type="datetime-local" placeholder="Start time (optional)">
      </div>
      <div class="field">
        <label>To</label>
        <input id="filter-to" type="datetime-local" placeholder="End time (optional)">
      </div>
      <div class="field" style="gap:6px">
        <button id="btn-apply">Apply</button>
        <button id="btn-clear" class="btn-cancel">Clear</button>
        <button id="btn-export" title="Download NDJSON export of current filter">Export NDJSON</button>
      </div>
    </div>

    <div id="error-banner" style="display:none; margin-bottom:10px; padding:8px; border:1px solid #6b1f2a; border-radius:6px; background:#412325; color:#ff9aa2;">
      <span id="error-text"></span>
    </div>

    <div style="overflow:auto; max-height:60vh; border:1px solid var(--border-color,#333); border-radius:8px;">
      <table class="decisions-table">
        <thead>
          <tr>
            <th class="nowrap">Time</th>
            <th>Tenant</th>
            <th>Subject</th>
            <th>Resource</th>
            <th>OPA</th>
            <th>OpenFGA</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="decisions-rows"></tbody>
      </table>
    </div>

    <div class="footer-actions">
      <button id="btn-load-more" style="display:none;">Load more</button>
      <span id="results-count" class="mono"></span>
    </div>
  </div>

  <script type="module">
    import { fetchApi } from "/js/api.js";

    const root = document.currentScript.closest('#decisions-root');
    const rowsEl = root.querySelector('#decisions-rows');
    const tenantEl = root.querySelector('#filter-tenant');
    const sessionEl = root.querySelector('#filter-session');
    const requestEl = root.querySelector('#filter-request');
    const limitEl = root.querySelector('#filter-limit');
    const subjectEl = root.querySelector('#filter-subject');
    const fromEl = root.querySelector('#filter-from');
    const toEl = root.querySelector('#filter-to');
    const applyBtn = root.querySelector('#btn-apply');
    const clearBtn = root.querySelector('#btn-clear');
    const loadMoreBtn = root.querySelector('#btn-load-more');
    const countEl = root.querySelector('#results-count');
    const exportBtn = root.querySelector('#btn-export');
    const errBanner = root.querySelector('#error-banner');
    const errText = root.querySelector('#error-text');

    let nextCursor = null;
    let totalShown = 0;

    function fmtTs(ts) {
      try { return new Date(ts).toLocaleString(); } catch { return String(ts); }
    }

    function pill(text, type) {
      const cls = type === 'allow' ? 'pill-allow' : type === 'deny' ? 'pill-deny' : 'pill-skip';
      return `<span class="pill ${cls}">${text}</span>`;
    }

    function renderRow(item) {
      const opa = item.details?.opa || {};
      const fga = item.details?.openfga || {};
      const opaCell = opa.skipped ? pill('skipped', 'skip') : (opa.allow ? pill('allow', 'allow') : pill('deny', 'deny'));
      const fgaCell = fga.enforced ? (fga.allowed ? pill('allow','allow') : pill('deny','deny')) : pill('not enforced','skip');
      const detailsJson = JSON.stringify(item.details, null, 2);
      return `
        <tr>
          <td class="mono nowrap">${fmtTs(item.ts || item.timestamp || item.time || '')}</td>
          <td class="mono">${item.tenant ?? ''}</td>
          <td class="mono">${item.subject ?? ''}</td>
          <td class="mono">${item.resource ?? ''}</td>
          <td>${opaCell}</td>
          <td>${fgaCell}</td>
          <td>
            <details>
              <summary>view</summary>
              <pre class="mono">${escapeHtml(detailsJson)}</pre>
            </details>
          </td>
        </tr>
      `;
    }

    function escapeHtml(str) {
      return (str || '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }

    async function loadDecisions({ append=false } = {}) {
      const params = new URLSearchParams();
      if (tenantEl.value) params.set('tenant', tenantEl.value.trim());
      if (sessionEl.value) params.set('session_id', sessionEl.value.trim());
      if (requestEl.value) params.set('request_id', requestEl.value.trim());
      if (subjectEl.value) params.set('subject', subjectEl.value.trim());
      if (limitEl.value) params.set('limit', String(limitEl.value));
      if (fromEl.value) params.set('from_ts', new Date(fromEl.value).toISOString());
      if (toEl.value) params.set('to_ts', new Date(toEl.value).toISOString());
      if (append && nextCursor) params.set('after', String(nextCursor));

      const url = '/v1/admin/audit/decisions?' + params.toString();
      const resp = await fetchApi(url, { method: 'GET' });
      if (!resp.ok) {
        const txt = await resp.text();
        // Show inline error banner
        errText.textContent = txt || `Failed to load decisions (HTTP ${resp.status})`;
        errBanner.style.display = '';
        throw new Error(txt || 'Failed to load decisions');
      }
      // Clear error banner on success
      errBanner.style.display = 'none';
      errText.textContent = '';
      const body = await resp.json();
      const items = Array.isArray(body.items) ? body.items : [];

      if (!append) {
        rowsEl.innerHTML = '';
        totalShown = 0;
      }

      for (const it of items) {
        rowsEl.insertAdjacentHTML('beforeend', renderRow(it));
        totalShown++;
      }

      nextCursor = body.next_cursor || null;
      loadMoreBtn.style.display = nextCursor ? '' : 'none';
      countEl.textContent = totalShown ? `${totalShown} shown` : '';
    }

    applyBtn.addEventListener('click', () => loadDecisions({ append: false }).catch(() => {}));
    clearBtn.addEventListener('click', () => {
      tenantEl.value = '';
      sessionEl.value = '';
      requestEl.value = '';
      subjectEl.value = '';
      fromEl.value = '';
      toEl.value = '';
      nextCursor = null;
      loadDecisions({ append: false }).catch(() => {});
    });
    loadMoreBtn.addEventListener('click', () => loadDecisions({ append: true }).catch(() => {}));

    function buildExportUrl() {
      const params = new URLSearchParams();
      if (tenantEl.value) params.set('tenant', tenantEl.value.trim());
      if (sessionEl.value) params.set('session_id', sessionEl.value.trim());
      if (requestEl.value) params.set('request_id', requestEl.value.trim());
      if (subjectEl.value) params.set('subject', subjectEl.value.trim());
      if (fromEl.value) params.set('from_ts', new Date(fromEl.value).toISOString());
      if (toEl.value) params.set('to_ts', new Date(toEl.value).toISOString());
      // Ensure only decision receipts are exported
      params.set('action', 'auth.decision');
      return '/v1/admin/audit/export?' + params.toString();
    }

    exportBtn.addEventListener('click', () => {
      const href = buildExportUrl();
      // Open in a new tab/window to trigger download
      window.open(href, '_blank', 'noopener');
    });

    // initial load
    loadDecisions({ append: false }).catch(err => {
      console.error(err);
      rowsEl.innerHTML = `<tr><td colspan="7">Failed to load: ${escapeHtml(err.message)}</td></tr>`;
    });
  </script>
</body>
</html>
